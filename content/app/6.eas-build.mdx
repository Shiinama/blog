# 6. 构建与发布（EAS Build）

软件工程的可重复、可追踪与可审核，绝大部分体现于“构建与发布”阶段。EAS Build 将 iOS/Android 的繁琐本地环境搬到云端，串起凭证托管、缓存加速、内测分发与商店提交。本章从初始化到多环境配置、缓存与资源类、凭证策略、安全与审计细节，给出一套现代化移动 CI/CD 的参考实现。

## 一、初始化与登录

```bash
npx eas-cli login
npx eas-cli init
```

初始化会生成/更新 `eas.json`。建议与 `app.config.ts` 协同定义：

- `runtimeVersion`（与 EAS Update 的兼容边界）；
- 多环境 `bundleIdentifier`/`package` 与渠道（Channel）；
- 提交参数与密钥来源（Apple API Key、Play Service Account）。

## 二、`eas.json`：多环境构建的“真相源”

```json
{
  "cli": { "appVersionSource": "remote" },
  "build": {
    "development": {
      "distribution": "internal",
      "developmentClient": true,
      "env": { "APP_ENV": "development" },
      "ios": { "resourceClass": "m-medium" },
      "android": { "gradleCommand": ":app:assembleDebug" }
    },
    "preview": {
      "distribution": "internal",
      "channel": "staging",
      "autoIncrement": "version",
      "env": { "APP_ENV": "staging" },
      "ios": { "image": "latest" },
      "android": { "withoutCredentials": false }
    },
    "production": {
      "channel": "production",
      "autoIncrement": true,
      "env": { "APP_ENV": "production" },
      "ios": { "image": "latest" },
      "android": { "image": "latest" }
    }
  },
  "submit": {
    "production": {
      "ios": { "appleId": "you@example.com" },
      "android": { "serviceAccountKeyPath": "./google-service-account.json" }
    }
  }
}
```

关键说明：

- `development`：生成 Dev Build，包含原生依赖用于开发调试；
- `preview`：内测分发（QA/业务预览），可与 `staging` Channel 绑定；
- `production`：生产构建，绑定 `production` Channel 与严格凭证；
- `autoIncrement`：自动递增构建号；
- `env`：在构建期注入环境变量，配合 `app.config.ts` 动态配置。

资源类与镜像：

- `resourceClass`：选择构建算力（`m-medium`/`m-large`），大型 Pods/Gradle 项目可提升稳定性；
- `image`：固定构建镜像，减少环境漂移导致的不可复现。

## 三、凭证管理：安全第一，可审计为王

EAS 支持凭证托管与导入：

```bash
npx eas-cli credentials -p ios
npx eas-cli credentials -p android
```

- iOS：
  - 优先使用 App Store Connect API Key（更安全稳定），或使用 Apple ID + App 专用密码；
  - EAS 可创建/管理证书与 Provisioning Profile，团队协作更顺滑；
  - 权限：组织管理员需在 Apple 开发者后台为你的 Expo 账号授权。
- Android：
  - Keystore 生成/导入/下载备份；
  - 丢失 Keystore 将导致无法更新旧版本，务必冷备份；
  - Google Play 的服务帐号 JSON 请放入安全存储（EAS secrets）。

建议：

- 使用 EAS Secrets 管理敏感变量（API 密钥、私有仓库凭据）；
- 将凭证操作记录到变更日志，明确责任人与用途；
- 为生产与预发使用不同凭证与包名，降低风险。

## 四、触发构建、分发与本地构建

触发：

```bash
# Dev Build（原生依赖 + 调试）
eas build --profile development --platform ios

# 内测构建（staging 渠道）
eas build --profile preview --platform android

# 生产构建（双平台）
eas build --profile production --platform all
```

分发：

- `distribution: 'internal'` 会生成可直接安装的链接与二维码；
- 与 EAS Submit 串联，自动上传到 TestFlight/Google Play；
- 在 `expo.dev` 可浏览历史构建、下载日志、复用配置。

本地构建（可选）：

```bash
eas build --local --profile preview --platform ios
```

本地构建适合在 CI 受限或需调试打包环境时使用。

## 五、EAS Submit：把“可安装包”送到商店流水线

```bash
eas submit --platform ios --profile production
eas submit --platform android --profile production
```

常见参数：

- iOS：`appleId`、`ascAppId`、`appleTeamId`、`appSpecificPassword` 或 API Key；
- Android：`serviceAccountKeyPath`、`track`（internal/alpha/beta/production）。

建议在 `submit.production` 中预设参数，或者在 CI 中以环境变量形式安全注入。

## 六、与 EAS Update 的衔接与版本策略

- 在 `build` Profile 中指定 `channel`（如 `staging`、`production`）；
- 严格定义 `runtimeVersion`（例如 `appVersion` 策略或自定义哈希），在涉及原生变更时强制全量升级；
- 构建产物与 Update 的关联在 `expo.dev` 中可追踪，便于审计与回滚。

## 七、稳定性与调试

- 版本号：iOS `buildNumber` 与 Android `versionCode` 必须递增，建议由 `autoIncrement` 管理；
- 缓存：构建失败可清理缓存重试；Pods/Gradle 大项目建议更高 `resourceClass`；
- 日志：关注签名环节与依赖安装环节的警告与错误；
- 重现本地问题：`--local` 配合相同镜像与环境变量尽量还原云端环境。

## 小结

EAS Build 将过去散落在个人电脑与口口相传的“构建秘笈”标准化为可审计的流水线。多环境 Profile、凭证托管、缓存与镜像、提交与分发的闭环组合，既提升上线效率，也让团队对“每一次构建的来龙去脉”心中有数。配合下一章的 EAS Update，你可以在不牺牲安全边界的前提下高速迭代。
