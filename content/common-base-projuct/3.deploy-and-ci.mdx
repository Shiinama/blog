# é¡¹ç›®çš„éƒ¨ç½²ä»¥åŠCI/CD

åœ¨ä¸Šä¸€ç« é‚£ï¼Œæˆ‘ä»¬æŠŠæœ¬åœ°çš„æ•°æ®åº“å’Œæœ€ç®€å•çš„ç™»å½•åœ¨æœ¬åœ°è·‘äº†ä¸€éï¼Œè¿™ä¸€ç« å°±å¼€å§‹æŠŠè¿œç¨‹çš„éƒ¨ç½²å’ŒCI/CDè·‘èµ·æ¥ã€‚

## éƒ¨ç½²çš„ä¸»è¦é€»è¾‘

å¯¹äºéƒ¨ç½²çš„ä¸»è¦é€»è¾‘éƒ½é›†ä¸­åœ¨`scripts/deploy/index.ts`ï¼Œæ•´æ®µé€»è¾‘æ¯”è¾ƒç®€å•æ¸…æ¥šä¸”å¸¦æœ‰æ³¨é‡Šï¼Œå› æ­¤ä¸åœ¨æ–‡ç« ä¸­æµªè´¹ç¯‡å¹…ï¼Œè½¬è‡³[Github](https://github.com/Shiinama/next-cloudflare-template)è‡ªè¡ŒæŸ¥çœ‹é€»è¾‘ã€‚

```typescript
/**
 * ä¸»å‡½æ•°
 */
const main = async () => {
  try {
    console.log('ğŸš€ Starting deployment process...')

    validateEnvironment()
    setupEnvFile()
    setupWranglerConfigs()
    await checkAndCreateDatabase()
    migrateDatabase()
    // await checkAndCreateKVNamespace()
    await checkAndCreatePages()
    pushPagesSecret()
    deployPages()

    console.log('ğŸ‰ Deployment completed successfully')
  } catch (error) {
    console.error('âŒ Deployment failed:', error)
    process.exit(1)
  }
}

main()
```

## ç¯å¢ƒå˜é‡è®¾ç½®

åœ¨.envä¸­ï¼Œè¿™äº›ç¯å¢ƒå˜é‡æ˜¯å¿…é¡»è¦åœ¨cloudflareä¸Šå»è·å–çš„ã€‚

```
CLOUDFLARE_ACCOUNT_ID=""
CLOUDFLARE_API_TOKEN=""
PROJECT_NAME=""
DATABASE_NAME=""
DATABASE_ID=""
```

æµç¨‹å¦‚ä¸‹ï¼š

1. ç™»å½•[Cloudflareæ§åˆ¶å°](https://dash.cloudflare.com/)
2. ä»URLä¸­è·å–ID, å½“ä½ ç™»å½•ä»¥åï¼Œä½ çš„urlä¼šé•¿æˆè¿™æ ·ï¼šhttps://dash.cloudflare.com/[accoutId]/home/domainsï¼Œä¸­é—´çš„éƒ¨åˆ†å°±æ˜¯ä½ çš„`CLOUDFLARE_ACCOUNT_ID`ï¼Œå½“ç„¶ä¹Ÿæœ‰å…¶ä»–åœ°æ–¹å¯ä»¥çœ‹ï¼Œä½†è¿™æ˜¯æœ€å¿«çš„ã€‚
3. ç´§æ¥ç€å¦‚å›¾æ‰€ç¤ºï¼Œç‚¹å‡»å³è¾¹çš„å°äºº -> ä¸‹æ‹‰æ¡† -> é…ç½®æ–‡ä»¶ -> apiä»¤ç‰Œ -> åˆ›å»ºä»¤ç‰Œ

![](https://ik.imagekit.io/ixou4q6nu/cloudflare-create-api-token.png)

ç„¶åé€‰è¿™äº›æƒé™ï¼ˆå¯ä»¥å¤šé€‰ä¸€ç‚¹æ¯”å¦‚R2æ¡¶ã€Questé˜Ÿåˆ—ã€AIä»¥å…åç»­å†æ¬¡æ·»åŠ ï¼‰ï¼Œåœ¨åˆ›å»ºæˆåŠŸåä¼šè·å¾—ä¸€ä¸ªsecret keyï¼Œè®°å¾—ä¿å­˜ï¼Œåªæœ‰ä¸€æ¬¡æŸ¥çœ‹æœºä¼šã€‚å°†å…¶å¡«å…¥`CLOUDFLARE_API_TOKEN`ä¸­ã€‚

![](https://ik.imagekit.io/ixou4q6nu/premission.png)

4. `PROJECT_NAME`å–ä¸€ä¸ªé¡¹ç›®ä½ æƒ³è¦çš„åå­—
5. `DATABASE_NAME`å’Œ`DATABASE_ID`ï¼Œå°†ä½ ä¸Šä¸€èŠ‚ä¸­æœ¬åœ°ç”Ÿæˆçš„d1çš„å€¼å¡«å…¥ã€‚

> æ³¨æ„`PROJECT_NAME`ï¼Œè¿™ä¸ªåœ°æ–¹æˆ‘åœ¨å†™è¿™ä¸ªæ–‡ç« çš„æ—¶å€™è¸©äº†ä¸ªå‘ï¼Œæˆ‘åœ¨è·‘CIçš„æ—¶å€™ä¸€ç›´ä»¥ä¸ºæ˜¯æˆ‘githubçš„ç¯å¢ƒå˜é‡è®¾ç½®æœ‰é—®é¢˜ï¼Œç›´åˆ°æˆ‘å»ç¿»äº†cloudflareçš„æºç ï¼Œè¦æ±‚æ˜¯è¿™æ ·çš„ï¼š
> é¡¹ç›®åç§°å¯ä»¥æ˜¯1-58ä¸ªå°å†™å­—ç¬¦ï¼Œå¯ä»¥åŒ…å«è¿å­—ç¬¦ï¼Œä½†ä¸èƒ½ä»¥è¿å­—ç¬¦å¼€å¤´æˆ–ç»“å°¾ï¼Œä¾‹å¦‚ï¼š`cloudflare-next-template`ã€‚

## æ‰§è¡Œéƒ¨ç½²è„šæœ¬ä¸”éªŒè¯ç»“æœ

`pnpm deploy:pages`æ‰§è¡Œï¼Œå¦‚å›¾ã€‚

![](https://ik.imagekit.io/ixou4q6nu/success-excuete.png?updatedAt=1745851458326)

åœ¨cloudflareä¸Šæ£€æŸ¥ä¸€ä¸‹ï¼Œæ‰€åœ¨çš„ä½ç½®æ˜¯`Workers`å’Œ`D1`ä»å·¦ä¾§è¾¹æ ä¸­è¿›å…¥ï¼š

![](https://ik.imagekit.io/ixou4q6nu/cloudflare-success-pages.png)

![](https://ik.imagekit.io/ixou4q6nu/d1-success.png)

æœ€åæˆ‘æŠŠè¿™ä¸ª`Workers`æŒ‚åœ¨äº†æˆ‘çš„æŸä¸ªäºŒçº§åŸŸåä¸‹ï¼ˆè¿™é‡Œå¯ä»¥ç›´æ¥è¾“å…¥ä½ æ‹¥æœ‰çš„åŸŸï¼Œä½†åŸŸå¿…é¡»æ˜¯åœ¨cloudflareä¸Šçš„ï¼Œcloudflareä¼šè‡ªåŠ¨å¸®ä½ å¤„ç†ï¼‰ã€‚

![](https://ik.imagekit.io/ixou4q6nu/domain.png)

è®¿é—®åœ°å€ï¼šhttps://demo.getwhynot.org/

## è¿ç§»æ•°æ®åº“åˆ°è¿œç¨‹D1

æ˜¾ç„¶æˆ‘ä»¬è¿˜æœ‰ä¸€äº›äº‹æƒ…æ²¡åšï¼Œé‚£å°±æ˜¯è¿ç§»æœ¬åœ°çš„æ•°æ®åº“åˆ°è¿œç¨‹çš„D1ä¸Šï¼Œå› ä¸ºæœ¬åœ°å·²ç»æœ‰`migrations`äº†ï¼Œæ‰€ä»¥åªéœ€è¦æ‰§è¡Œ`wrangler d1 migrations apply demo --remote`å³å¯å°†æ•°æ®åº“åŒæ­¥åˆ°è¿œç«¯D1ä¸Šã€‚

å¤§å®¶è¿˜è®°å¾—å‰é¢è¿™æ®µè„šæœ¬`"db:studio:local": "LOCAL_DB_PATH=$(find .wrangler/state/v3/d1/miniflare-D1DatabaseObject -type f -name '*.sqlite' -print -quit) drizzle-kit studio"`ä»¥åŠ`drizzle.config.ts`æ–‡ä»¶å—ï¼Ÿ

å¯¹äºè¿œç¨‹æ¥è¯´æˆ‘å¢åŠ äº†ä¸€æ¡è„šæœ¬æ˜¯`"db:studio:remote": "drizzle-kit studio"`ï¼Œé€šè¿‡`drizzle.config.ts`çš„é€»è¾‘å¯çŸ¥ï¼Œä¼šå› ä¸ºæ²¡æœ‰ä¼ é€’`LOCAL_DB_PATH`çš„ç¯å¢ƒå˜é‡è€Œç›´æ¥é“¾æ¥è¿œç¨‹æ•°æ®åº“ï¼Œå±•ç¤ºè¿œç¨‹çš„æ•°æ®åº“ç»“æœã€‚

```
// drizzle.config.ts
import type { Config } from 'drizzle-kit'

const { LOCAL_DB_PATH, DATABASE_ID, CLOUDFLARE_API_TOKEN, CLOUDFLARE_ACCOUNT_ID } = process.env

// Use better-sqlite driver for local development
export default LOCAL_DB_PATH
  ? ({
      schema: './lib/db/schema.ts',
      dialect: 'sqlite',
      dbCredentials: {
        url: LOCAL_DB_PATH
      }
    } satisfies Config)
  : ({
      schema: './lib/db/schema.ts',
      out: './migrations',
      dialect: 'sqlite',
      driver: 'd1-http',
      dbCredentials: {
        databaseId: DATABASE_ID!,
        token: CLOUDFLARE_API_TOKEN!,
        accountId: CLOUDFLARE_ACCOUNT_ID!
      }
    } satisfies Config)
```

ç»“æœå¦‚ä¸‹ï¼Œå› ä¸ºæ²¡æœ‰æ‰§è¡Œä»»ä½•æ“ä½œæ˜¯ç©ºæ•°æ®åº“ï¼š

![](https://ik.imagekit.io/ixou4q6nu/d1-remote.png)

> ä¹Ÿå¯ä»¥ç›´æ¥åœ¨cloudflareç½‘ç«™ä¸Šçš„d1æŸ¥çœ‹ï¼Œä½†æ˜¯studioæ›´å¥½ç”¨ä¸€äº›ã€‚

## Googleå›è°ƒçš„é…ç½®ä»¥åŠè§£å†³ç™»å½•æŠ¥é”™

é‚£ä¹ˆæˆ‘ä»¬åŒæ ·éœ€è¦æµ‹è¯•ä¸€ä¸‹åœ¨çº¿ä¸Šçš„ç¯å¢ƒï¼Œèƒ½å¦æ’å…¥æ•°æ®åº“å’Œæ­£å¸¸ç™»å½•ï¼Œæ¥åˆ° [google cloud](https://console.cloud.google.com/)ï¼Œæ·»åŠ çº¿ä¸ŠåŸŸçš„å›è°ƒå’Œè®¿é—®æƒé™ã€‚

![](https://ik.imagekit.io/ixou4q6nu/google-callback-remote.png)

ç‚¹å‡»ç™»å½•ï¼Œå¥½çš„æœç„¶æŠ¥é”™ï¼Œé¡ºæ‰‹å°±æ•™å¤§å®¶`cloudflare`æ€ä¹ˆçœ‹æŠ¥é”™æ—¥å¿—ã€‚

![](https://ik.imagekit.io/ixou4q6nu/error-login.png)

æ“ä½œè·¯å¾„æ˜¯ï¼špagesï¼ˆæœ€æ–°çš„ä¸€æ¡éƒ¨ç½²ï¼‰ -> éƒ¨ç½²è¯¦ç»†ä¿¡æ¯ -> å‡½æ•° -> æ»‘åŠ¨åˆ°å®æ—¶æ—¥å¿—ï¼Œç‚¹å¼€å§‹å›¾æ ‡ -> å†ç‚¹ç™»å½•è§¦å‘å¼‚å¸¸ -> çœ‹æ—¥å¿—

![](https://ik.imagekit.io/ixou4q6nu/worker-log-stream.png)

è¿™ä¸ªé—®é¢˜ä¸€çœ¼å°±æ˜¯ç¯å¢ƒå˜é‡æ²¡ä¼ ä¸Šå»ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥åˆ°`scripts/deploy/index.ts`ï¼Œæ³¨é‡Šæ‰å…¶ä»–å‡½æ•°ï¼Œå†è·‘ä¸€éç¯å¢ƒå˜é‡ä¸Šä¼ (pnpm tsx scripts/deploy/index.ts)ï¼Œæ³¨æ„ä½ çš„.envæ–‡ä»¶é‡Œé¢åº”è¯¥æœ‰æ­£ç¡®çš„å€¼ã€‚

```typescript
const main = async () => {
  try {
    console.log('ğŸš€ Starting deployment process...')

    // validateEnvironment()
    // setupEnvFile()
    // setupWranglerConfigs()
    // await checkAndCreateDatabase()
    // migrateDatabase()
    // await checkAndCreateKVNamespace()
    // await checkAndCreatePages()
    pushPagesSecret()
    // deployPages()

    console.log('ğŸ‰ Deployment completed successfully')
  } catch (error) {
    console.error('âŒ Deployment failed:', error)
    process.exit(1)
  }
}
```

é‡æ–°è·‘äº†ä¸€éï¼Œç¯å¢ƒå˜é‡ä¸Šä¼ äº†ã€‚

![](https://ik.imagekit.io/ixou4q6nu/secret-success.png)

`pnpm deploy:pages`é‡æ–°éƒ¨ç½²ï¼Œå†æ¬¡ç™»å½•ï¼Œå¦‚å›¾æˆåŠŸç™»å½•ï¼Œå¹¶ä¸”D1æ•°æ®åº“ä¸­æ’å…¥ä¸€æ¡`accout`æ•°æ®ã€‚

![](https://ik.imagekit.io/ixou4q6nu/success-login.png)

![](https://ik.imagekit.io/ixou4q6nu/d1-success-row.png)

## CI/CD

å¯¹äº`Github Actions`æˆ‘é»˜è®¤å¤§å®¶ä¸äº†è§£ï¼Œå°±ç»†è®²ä¸€ä¸‹ã€‚

é¡ºæ‰‹ä¹Ÿè®²ä¸€ä¸‹è¿™ä¸ªè¯¾ç¨‹ç‰ˆæœ¬å·ï¼š

- ä¸»è¦ç‰ˆæœ¬ï¼šv1.0.0, v2.0.0 - è¡¨ç¤ºè¯¾ç¨‹çš„ç« èŠ‚æ›´æ–°
- æ¬¡è¦ç‰ˆæœ¬ï¼šv1.1.0, v1.2.0 - è¡¨ç¤ºæ·»åŠ äº†æ–°çš„ç« èŠ‚å†…å®¹
- è¡¥ä¸ç‰ˆæœ¬ï¼šv1.0.1, v1.0.2 - è¡¨ç¤ºå¯¹ç°æœ‰å†…å®¹çš„ä¿®å¤æˆ–å°æ”¹è¿›

èµ·å§‹ç‰ˆæœ¬ä»è¿™ä¸€ç« å¼€å§‹ï¼Œå› ä¸ºè¿™ä¸€ç« æ‰ç®—æ˜¯é¡¹ç›®åˆšå¼€å§‹~

### è§¦å‘æ¡ä»¶

```yaml
on:
  push:
    branches:
      - 'master'
  workflow_dispatch:
```

å·¥ä½œæµç¨‹åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹è§¦å‘ï¼š

1. å½“æ¨é€Masteråˆ†æ”¯çš„æ—¶å€™ï¼Œä¼šè§¦å‘è¿™ä¸ªActions
2. æ‰‹åŠ¨è§¦å‘ï¼ˆé€šè¿‡ GitHub ç•Œé¢æ‰‹åŠ¨å¯åŠ¨å·¥ä½œæµç¨‹ï¼‰

> è¿™é‡Œè¦æ³¨æ„cloudflareåœ¨Pagesé‡Œæœ‰ä¸€ä¸ªç”Ÿäº§åˆ†æ”¯é€‰é¡¹ï¼Œç¡®ä¿ä½ çš„æ¨é€è¾“å‡ºActionsåˆ†æ”¯ä¸ç”Ÿäº§åˆ†æ”¯ä¿å­˜ä¸€è‡´ï¼Œæ‰èƒ½æ›´æ–°é¡µé¢

### å·¥ä½œæµé…ç½®

#### 1. ç¡®å®šç¯å¢ƒå’Œè™šæ‹Ÿæœº

```yaml
jobs:
  deploy:
    runs-on: ubuntu-latest
```

è¿™ä¸€æ­¥å®šä¹‰äº†å·¥ä½œæµçš„æ‰§è¡Œç¯å¢ƒï¼š

- `runs-on: ubuntu-latest` æŒ‡å®šä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„Ubuntuè™šæ‹Ÿæœºè¿è¡Œå·¥ä½œæµ

#### 2. æ£€å‡ºä»£ç 

```yaml
- uses: actions/checkout@v4
  with:
    fetch-depth: 0 # Get full git history for checking file changes
```

è¿™ä¸€æ­¥ä½¿ç”¨ `actions/checkout@v4` æ“ä½œæ¥æ£€å‡ºä»“åº“ä»£ç ã€‚`fetch-depth: 0` å‚æ•°ç¡®ä¿è·å–å®Œæ•´çš„ git å†å²è®°å½•ï¼Œè¿™å¯¹äºåç»­è·å–ä¹‹å‰çš„æ ‡ç­¾æ˜¯å¿…è¦çš„ã€‚

#### 3. è®¾ç½® PNPM

```yaml
- name: Setup pnpm
  uses: pnpm/action-setup@v2
  with:
    version: 9
```

è¿™ä¸€æ­¥è®¾ç½® PNPM åŒ…ç®¡ç†å™¨ï¼ŒæŒ‡å®šä½¿ç”¨ç‰ˆæœ¬ 9ã€‚

#### 4. è®¾ç½® Node.js

```yaml
- name: Setup Node.js
  uses: actions/setup-node@v4
  with:
    node-version: '20'
    cache: 'pnpm'
```

è¿™ä¸€æ­¥è®¾ç½® Node.js ç¯å¢ƒï¼Œä½¿ç”¨ç‰ˆæœ¬ 20ï¼Œå¹¶å¯ç”¨ PNPM ç¼“å­˜ä»¥åŠ é€Ÿä¾èµ–å®‰è£…ã€‚

#### 5. å®‰è£…ä¾èµ–

```yaml
- name: Install Dependencies
  run: pnpm install --frozen-lockfile
```

ä½¿ç”¨ PNPM å®‰è£…é¡¹ç›®ä¾èµ–ã€‚`--frozen-lockfile` å‚æ•°ç¡®ä¿å®‰è£…ä¸ lockfile å®Œå…¨åŒ¹é…çš„ä¾èµ–ç‰ˆæœ¬ï¼Œå¦‚æœ lockfile éœ€è¦æ›´æ–°åˆ™ä¼šå¤±è´¥ã€‚

#### 6. è¿è¡Œéƒ¨ç½²è„šæœ¬

```yaml
- name: Run deploy script
  env:
    CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
    CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
    PROJECT_NAME: ${{ secrets.PROJECT_NAME }}
    DATABASE_NAME: ${{ secrets.DATABASE_NAME }}
    DATABASE_ID: ${{ secrets.DATABASE_ID }}
    AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
    AUTH_GOOGLE_ID: ${{ secrets.AUTH_GOOGLE_ID }}
    AUTH_GOOGLE_SECRET: ${{ secrets.AUTH_GOOGLE_SECRET }}
  run: pnpm dlx tsx scripts/deploy/index.ts
```

è¿™ä¸€æ­¥è¿è¡Œè‡ªå®šä¹‰éƒ¨ç½²è„šæœ¬ `scripts/deploy/index.ts`ï¼Œä½¿ç”¨ `tsx` æ‰§è¡Œ TypeScript æ–‡ä»¶ã€‚è„šæœ¬éœ€è¦å¤šä¸ªç¯å¢ƒå˜é‡ï¼Œè¿™äº›å˜é‡ä» GitHub ä»“åº“çš„ secrets ä¸­è·å–å’Œå¡«å†™ï¼š

- **Cloudflare å‡­è¯**ï¼š`CLOUDFLARE_API_TOKEN` å’Œ `CLOUDFLARE_ACCOUNT_ID`
- **é¡¹ç›®é…ç½®**ï¼š`PROJECT_NAME`
- **Cloudflare D1 æ•°æ®åº“é…ç½®**ï¼š`DATABASE_NAME` å’Œ `DATABASE_ID`
- **åº”ç”¨é…ç½®**ï¼š`AUTH_SECRET` å’Œ `AUTH_GOOGLE_ID` å’Œ `AUTH_GOOGLE_SECRET`

![](https://ik.imagekit.io/ixou4q6nu/github-actions.png?updatedAt=1745937473871)

æˆ‘ä»¬éœ€è¦æŠŠè¿™äº›ç¯å¢ƒå˜é‡ä»¥åŠå€¼æ·»åŠ åˆ°é‡Œé¢ï¼Œè¿™é‡Œç¨å¾®æ³¨æ„ä¸€ä¸‹ï¼Œä¸Šé¢çš„åœˆå‡ºçš„åœ°æ–¹ç¯å¢ƒå˜é‡çš„è®¾ç½®ï¼Œå¦‚æœæ˜¯å•ç¯å¢ƒï¼Œå…¶å®æ˜¯ä¸éœ€è¦çš„ï¼Œä¸‹é¢çš„repository secretsæ˜¯æˆ‘ä»¬è¦è®¾ç½®çš„ç§˜é’¥ä¿¡æ¯ã€‚è¿™é‡Œæœ‰ä¸¤ä¸ªTabï¼Œä¸€ä¸ªæ˜¯`Secrets`å®ƒçš„å†™æ³•å°±æ˜¯`${{ secrets.xxx }}`ï¼Œå¦‚æœåœ¨`Variables`ä¸­æ·»åŠ å†™æ³•å°±æ˜¯`${{vars.xxx}}`ã€‚æ·»åŠ æˆåŠŸåï¼š

![](https://ik.imagekit.io/ixou4q6nu/repository-secrets.png?updatedAt=1745945187613)

### éªŒè¯å·¥ä½œæµ

æˆ‘åœ¨é¦–é¡µé‡Œï¼Œæ·»åŠ äº†ä¸€ä¸ªç‰ˆæœ¬ä¿¡æ¯ã€‚

```tsx
// app/page.tsx
<h1 className="mb-4 text-4xl font-bold tracking-tight md:text-5xl lg:text-6xl">
  Next-Generation AI Image Technology Current Version v1.0.7
</h1>
```

æ¨é€åï¼Œå¯ä»¥åœ¨GitHubä»“åº“çš„Actionsæ ‡ç­¾é¡µæŸ¥çœ‹å·¥ä½œæµæ‰§è¡Œæƒ…å†µã€‚

![](https://ik.imagekit.io/ixou4q6nu/script-success.png?updatedAt=1745945615623)

æˆåŠŸäº†

![](https://ik.imagekit.io/ixou4q6nu/success-actions.png?updatedAt=1745946119885)

## ç»“æŸ

åˆ°æ­¤ä¸ºæ­¢ï¼Œå°±å®Œæˆäº†éƒ¨ç½²ï¼Œè¿™ä¹Ÿå®£å‘Šç€ï¼Œå¯¹äºå¼€å‘çš„å¤§å®¶ä¼™æ¥è¯´ï¼Œæœ€éš¾çš„ä¸€æ­¥æå®šäº†ã€‚è¿™ä¸€èŠ‚çš„æœ€æ–°çš„Tagæ˜¯[v1.08](https://github.com/Shiinama/next-cloudflare-template/tree/v1.0.8)ã€‚
