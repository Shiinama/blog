[
  {
    "slug": "/content/react-source-code/1.why-use-firber",
    "title": "1. React源码启蒙、梦开始的地方",
    "description": "探讨React的Fiber架构，解析其核心原理，揭示如何实现高效的任务调度，以及对React性能的提升。",
    "published": true,
    "date": "2022-11-20T00:00:00.000Z",
    "body": "const{Fragment:n,jsx:e,jsxs:i}=arguments[0];function _createMdxContent(r){const c={a:\"a\",code:\"code\",h2:\"h2\",h3:\"h3\",li:\"li\",ol:\"ol\",p:\"p\",span:\"span\",strong:\"strong\",ul:\"ul\",...r.components};return i(n,{children:[i(c.h2,{id:\"1-前因后果\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#1-前因后果\",children:e(c.span,{className:\"icon icon-link\"})}),\"1. 前因后果\"]}),\"\\n\",e(c.p,{children:\"为什么React要使用Fiber？它解决了什么问题？它是怎么解决的？它是怎样的一个思路？以及为什么我们要先从Fiber入手去理解源码？这些是我们在理解Fiber路上需要关注的核心问题。\"}),\"\\n\",i(c.h2,{id:\"2-为什么使用fiber\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#2-为什么使用fiber\",children:e(c.span,{className:\"icon icon-link\"})}),\"2. 为什么使用Fiber\"]}),\"\\n\",e(c.p,{children:\"它能解决以往react的卡顿问题。\"}),\"\\n\",i(c.h3,{id:\"21-解决的问题\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#21-解决的问题\",children:e(c.span,{className:\"icon icon-link\"})}),\"2.1 解决的问题\"]}),\"\\n\",e(c.p,{children:\"React 16之前，Virtual DOM的更新过程采用循环加递归实现。这种方式一旦开始就无法中断，导致大型应用中主线程长期被占用，影响用户交互和动画执行，造成页面卡顿。\"}),\"\\n\",e(c.p,{children:\"核心问题：递归无法中断，执行重任务耗时长。JavaScript又是单线程，无法同时执行其他任务，导致任务延迟、页面卡顿，用户体验差。\"}),\"\\n\",i(c.h3,{id:\"22-fiber的解决方案\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#22-fiber的解决方案\",children:e(c.span,{className:\"icon icon-link\"})}),\"2.2 Fiber的解决方案\"]}),\"\\n\",e(c.p,{children:\"Fiber本质上是一种新的调度算法，具有以下特点：\"}),\"\\n\",i(c.ul,{children:[\"\\n\",e(c.li,{children:\"可中断的渲染过程\"}),\"\\n\",e(c.li,{children:\"利用浏览器空闲时间执行任务\"}),\"\\n\",e(c.li,{children:\"放弃递归，采用循环方式\"}),\"\\n\",e(c.li,{children:\"更细粒度的任务划分\"}),\"\\n\"]}),\"\\n\",e(c.p,{children:\"Fiber通过Scheduler来利用浏览器空闲时间执行任务，解决长期占用主线程的问题。这意味着要放弃递归（因为它不可终止），保留循环（因为需要中断）。为了支持中断和恢复，任务被拆分为更小的单位。\"}),\"\\n\",i(c.h3,{id:\"23-为什么要从fiber入手理解源码\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#23-为什么要从fiber入手理解源码\",children:e(c.span,{className:\"icon icon-link\"})}),\"2.3 为什么要从Fiber入手理解源码\"]}),\"\\n\",e(c.p,{children:\"Fiber的构建过程以及最后的提交相当于源码的一条主线路。我们可以先理解这条主线，然后再拆解出支线去理解源码（例如Hooks、Suspense等）。\"}),\"\\n\",i(c.h2,{id:\"3-fiber的实现思路\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#3-fiber的实现思路\",children:e(c.span,{className:\"icon icon-link\"})}),\"3. Fiber的实现思路\"]}),\"\\n\",e(c.p,{children:\"Fiber的工作过程可以分为两个主要阶段：\"}),\"\\n\",i(c.ol,{children:[\"\\n\",i(c.li,{children:[e(c.strong,{children:\"Render阶段\"}),\"（可中断）：构建Fiber树，进行diff算法比较。\"]}),\"\\n\",i(c.li,{children:[e(c.strong,{children:\"Commit阶段\"}),\"（不可中断）：将更新提交到DOM。\"]}),\"\\n\"]}),\"\\n\",i(c.h3,{id:\"31-初始渲染vs更新渲染\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#31-初始渲染vs更新渲染\",children:e(c.span,{className:\"icon icon-link\"})}),\"3.1 初始渲染vs更新渲染\"]}),\"\\n\",i(c.ul,{children:[\"\\n\",i(c.li,{children:[e(c.strong,{children:\"初始渲染\"}),\"：JSX → React.createElement（或react/jsx-runtime） → VDOM对象 → 构建Fiber对象 → 提交到真实DOM\"]}),\"\\n\",i(c.li,{children:[e(c.strong,{children:\"更新渲染\"}),\"：重新构建Fiber → 新旧Fiber对比 → 生成更新队列 → 提交到真实DOM\"]}),\"\\n\"]}),\"\\n\",i(c.h2,{id:\"4-实现fiber的关键步骤\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#4-实现fiber的关键步骤\",children:e(c.span,{className:\"icon icon-link\"})}),\"4. 实现Fiber的关键步骤\"]}),\"\\n\",i(c.ol,{children:[\"\\n\",e(c.li,{children:\"创建任务队列\"}),\"\\n\",e(c.li,{children:\"实现任务调度逻辑\"}),\"\\n\",e(c.li,{children:\"创建Fiber对象\"}),\"\\n\",e(c.li,{children:\"构建Effects数组\"}),\"\\n\",e(c.li,{children:\"实现初始化提交\"}),\"\\n\",e(c.li,{children:\"处理组件\"}),\"\\n\",e(c.li,{children:\"处理Fiber更新\"}),\"\\n\"]}),\"\\n\",i(c.h2,{id:\"5-react的启动模式\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#5-react的启动模式\",children:e(c.span,{className:\"icon icon-link\"})}),\"5. React的启动模式\"]}),\"\\n\",e(c.p,{children:\"React提供了三种启动模式：\"}),\"\\n\",i(c.ol,{children:[\"\\n\",i(c.li,{children:[e(c.strong,{children:\"Legacy模式\"}),\"：\",e(c.code,{children:\"ReactDOM.render(<App />, rootNode)\"})]}),\"\\n\",i(c.li,{children:[e(c.strong,{children:\"Blocking模式\"}),\"：\",e(c.code,{children:\"ReactDOM.createBlockingRoot(rootNode).render(<App />)\"})]}),\"\\n\",i(c.li,{children:[e(c.strong,{children:\"Concurrent模式\"}),\"：\",e(c.code,{children:\"ReactDOM.createRoot(rootNode).render(<App />)\"})]}),\"\\n\"]}),\"\\n\",e(c.p,{children:\"Concurrent模式（React 18默认）直接就是Fiber架构，去实现并发渲染、自动批处理等新特性。\"}),\"\\n\",i(c.h2,{id:\"6-总结\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#6-总结\",children:e(c.span,{className:\"icon icon-link\"})}),\"6. 总结\"]}),\"\\n\",i(c.p,{children:[e(c.code,{children:\"1.2节\"}),\"是一块的，\",e(c.code,{children:\"3,4\"}),\"节又是一块的。\"]})]})}return{default:function(n={}){const{wrapper:i}=n.components||{};return i?e(i,{...n,children:e(_createMdxContent,{...n})}):_createMdxContent(n)}};",
    "toc": {
      "content": [
        {
          "title": "1. 前因后果",
          "url": "#1-前因后果",
          "items": []
        },
        {
          "title": "2. 为什么使用Fiber",
          "url": "#2-为什么使用fiber",
          "items": [
            {
              "title": "2.1 解决的问题",
              "url": "#21-解决的问题",
              "items": []
            },
            {
              "title": "2.2 Fiber的解决方案",
              "url": "#22-fiber的解决方案",
              "items": []
            },
            {
              "title": "2.3 为什么要从Fiber入手理解源码",
              "url": "#23-为什么要从fiber入手理解源码",
              "items": []
            }
          ]
        },
        {
          "title": "3. Fiber的实现思路",
          "url": "#3-fiber的实现思路",
          "items": [
            {
              "title": "3.1 初始渲染vs更新渲染",
              "url": "#31-初始渲染vs更新渲染",
              "items": []
            }
          ]
        },
        {
          "title": "4. 实现Fiber的关键步骤",
          "url": "#4-实现fiber的关键步骤",
          "items": []
        },
        {
          "title": "5. React的启动模式",
          "url": "#5-react的启动模式",
          "items": []
        },
        {
          "title": "6. 总结",
          "url": "#6-总结",
          "items": []
        }
      ],
      "visible": true
    },
    "slugAsParams": "1.why-use-firber"
  },
  {
    "slug": "/content/react-source-code/2.create-task-queue",
    "title": "2. React Fiber架构：深入解析任务队列、可中断渲染、调度、同步模式",
    "description": "在React Fiber架构中，任务队列是实现可中断渲染和优先级调度的核心组件。本文主要讲`React源码`的`任务队列`、`可中断渲染`、`调度`、`同步模式`。理解了这一整节，几乎就把 `react` 中最重要的东西和主线理解了，其余都是散散碎碎的小细节。",
    "published": true,
    "date": "2023-01-08T00:00:00.000Z",
    "body": "const{Fragment:l,jsx:n,jsxs:e}=arguments[0];function _createMdxContent(r){const c={a:\"a\",code:\"code\",figure:\"figure\",h2:\"h2\",h3:\"h3\",h4:\"h4\",li:\"li\",ol:\"ol\",p:\"p\",pre:\"pre\",span:\"span\",strong:\"strong\",ul:\"ul\",...r.components};return e(l,{children:[e(c.h2,{id:\"1-react-fiber架构深入解析任务队列可中断渲染调度同步模式\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#1-react-fiber架构深入解析任务队列可中断渲染调度同步模式\",children:n(c.span,{className:\"icon icon-link\"})}),\"1. React Fiber架构：深入解析任务队列、可中断渲染、调度、同步模式\"]}),\"\\n\",e(c.p,{children:[\"在React Fiber架构中，任务队列是实现可中断渲染和优先级调度的核心组件。本文主要讲\",n(c.code,{children:\"React源码\"}),\"的\",n(c.code,{children:\"任务队列\"}),\"、\",n(c.code,{children:\"可中断渲染\"}),\"、\",n(c.code,{children:\"调度\"}),\"、\",n(c.code,{children:\"同步模式\"}),\"。\"]}),\"\\n\",e(c.p,{children:[\"理解了这一整节，几乎就把 \",n(c.code,{children:\"react\"}),\" 中最重要的东西和主线理解了，其余都是散散碎碎的小细节。\"]}),\"\\n\",e(c.h2,{id:\"2-任务队列的概念和作用\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#2-任务队列的概念和作用\",children:n(c.span,{className:\"icon icon-link\"})}),\"2. 任务队列的概念和作用\"]}),\"\\n\",n(c.p,{children:\"在深入源码之前，我们需要先理解任务队列在React Fiber架构中的重要性。\"}),\"\\n\",e(c.h3,{id:\"21-什么是任务队列\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#21-什么是任务队列\",children:n(c.span,{className:\"icon icon-link\"})}),\"2.1 什么是任务队列？\"]}),\"\\n\",n(c.p,{children:\"任务队列是一种数据结构，用于存储和管理需要执行的任务。在React Fiber中，任务队列主要用于管理更新和渲染过程中的各种操作，如组件更新、DOM操作等。\"}),\"\\n\",e(c.h3,{id:\"22-任务队列的作用\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#22-任务队列的作用\",children:n(c.span,{className:\"icon icon-link\"})}),\"2.2 任务队列的作用\"]}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[n(c.strong,{children:\"任务调度\"}),\"：根据优先级对任务进行排序和调度。\"]}),\"\\n\",e(c.li,{children:[n(c.strong,{children:\"中断与恢复\"}),\"：支持任务的中断和恢复，实现可中断渲染。\"]}),\"\\n\",e(c.li,{children:[n(c.strong,{children:\"优先级管理\"}),\"：为不同类型的更新分配不同的优先级。\"]}),\"\\n\",e(c.li,{children:[n(c.strong,{children:\"性能优化\"}),\"：通过合理调度任务，提高渲染性能和用户体验。\"]}),\"\\n\"]}),\"\\n\",e(c.h2,{id:\"3-react源码中的任务队列实现\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#3-react源码中的任务队列实现\",children:n(c.span,{className:\"icon icon-link\"})}),\"3. React源码中的任务队列实现\"]}),\"\\n\",n(c.p,{children:\"首先我们看任务队列是如何实现的。\"}),\"\\n\",e(c.h3,{id:\"31-数据结构\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#31-数据结构\",children:n(c.span,{className:\"icon icon-link\"})}),\"3.1 数据结构\"]}),\"\\n\",n(c.p,{children:\"React使用小顶堆（Min Heap）来实现任务队列。小顶堆是一种特殊的二叉树，其中每个节点的值都小于或等于其子节点的值。这种结构非常适合优先级队列的实现，因为它可以在O(log n)的时间复杂度内完成插入和删除操作。\"}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/scheduler/src/Scheduler.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" taskQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = []\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" timerQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = []\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// ... 其他代码\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" push\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"length\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"push\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  siftUp\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" peek\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"length\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" ?\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" null\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" :\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"]\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" pop\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"length\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" null\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" first\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"]\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" last\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"pop\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"last\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"first\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"last\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    siftDown\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"last\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" first\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:[\"在这段代码中，我们可以看到任务队列（\",n(c.code,{children:\"taskQueue\"}),\"）和定时器队列（\",n(c.code,{children:\"timerQueue\"}),\"）的定义，以及用于操作堆的基本函数：\",n(c.code,{children:\"push\"}),\"、\",n(c.code,{children:\"peek\"}),\"和\",n(c.code,{children:\"pop\"}),\"。\"]}),\"\\n\",e(c.h3,{id:\"32-任务的表示\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#32-任务的表示\",children:n(c.span,{className:\"icon icon-link\"})}),\"3.2 任务的表示\"]}),\"\\n\",n(c.p,{children:\"在React中，每个任务都被表示为一个对象，包含以下主要属性：\"}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/scheduler/src/Scheduler.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" newTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  id\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"taskIdCounter\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"++,\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  callback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  priorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  expirationTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  sortIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": -\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[n(c.code,{children:\"id\"}),\"：任务的唯一标识符。\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"callback\"}),\"：任务的回调函数。\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"priorityLevel\"}),\"：任务的优先级。\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"startTime\"}),\"：任务的开始时间。\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"expirationTime\"}),\"：任务的过期时间。\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"sortIndex\"}),\"：用于在队列中排序的索引。\"]}),\"\\n\"]}),\"\\n\",e(c.h3,{id:\"33-优先级的定义\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#33-优先级的定义\",children:n(c.span,{className:\"icon icon-link\"})}),\"3.3 优先级的定义\"]}),\"\\n\",n(c.p,{children:\"React定义了多个优先级级别，用于区分不同类型的任务：\"}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/scheduler/src/SchedulerPriorities.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"export\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" NoPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"export\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" ImmediatePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"export\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" UserBlockingPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"2\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"export\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" NormalPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"3\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"export\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" LowPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"4\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"export\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" IdlePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"5\"})]})]})})}),\"\\n\",n(c.p,{children:\"这些优先级从高到低排列，用于决定任务的执行顺序。\"}),\"\\n\",e(c.h2,{id:\"4-任务队列的创建过程\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#4-任务队列的创建过程\",children:n(c.span,{className:\"icon icon-link\"})}),\"4. 任务队列的创建过程\"]}),\"\\n\",n(c.p,{children:\"任务队列的创建是React Fiber架构的基础。\"}),\"\\n\",e(c.h3,{id:\"41-初始化\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#41-初始化\",children:n(c.span,{className:\"icon icon-link\"})}),\"4.1 初始化\"]}),\"\\n\",e(c.p,{children:[\"任务队列在React初始化时就会被创建。在\",n(c.code,{children:\"Scheduler.js\"}),\"文件中，我们可以看到队列的初始化：\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" taskQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = []\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" timerQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = []\"})]})]})})}),\"\\n\",n(c.p,{children:\"这里创建了两个队列：\"}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[n(c.code,{children:\"taskQueue\"}),\"用于存储准备执行的任务\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"timerQueue\"}),\"用于存储延迟执行的任务\"]}),\"\\n\"]}),\"\\n\",e(c.h3,{id:\"42-添加任务\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#42-添加任务\",children:n(c.span,{className:\"icon icon-link\"})}),\"4.2 添加任务\"]}),\"\\n\",e(c.p,{children:[\"当需要添加新任务时，React会调用\",n(c.code,{children:\"unstable_scheduleCallback\"}),\"函数：\"]}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/scheduler/src/Scheduler.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" unstable_scheduleCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"priorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"callback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"options\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"getCurrentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" startTime\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" options\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'object'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"options\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" delay\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"options\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"delay\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" delay\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'number'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"delay\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" > \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" + \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"delay\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" timeout\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  switch\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"priorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" ImmediatePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      timeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"IMMEDIATE_PRIORITY_TIMEOUT\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      break\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" UserBlockingPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      timeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"USER_BLOCKING_PRIORITY_TIMEOUT\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      break\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" IdlePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      timeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"IDLE_PRIORITY_TIMEOUT\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      break\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" LowPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      timeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"LOW_PRIORITY_TIMEOUT\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      break\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" NormalPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    default\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      timeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"NORMAL_PRIORITY_TIMEOUT\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      break\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" expirationTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" + \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"timeout\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" newTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    id\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"taskIdCounter\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"++,\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    callback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    priorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    expirationTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    sortIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": -\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" > \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // This is a delayed task.\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    newTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sortIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"startTime\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    push\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"timerQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"peek\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"taskQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"peek\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"timerQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // All tasks are delayed, and this is the task with the earliest delay.\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"isHostTimeoutScheduled\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"        // Cancel an existing timeout.\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"        cancelHostTimeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        isHostTimeoutScheduled\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // Schedule a timeout.\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      requestHostTimeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"handleTimeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" - \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    newTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sortIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"expirationTime\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    push\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"taskQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // Schedule a host callback, if needed. If we're already performing work,\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // wait until the next time we yield.\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (!\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"isHostCallbackScheduled\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && !\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"isPerformingWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      isHostCallbackScheduled\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      requestHostCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"flushWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" newTask\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个函数完成了以下几个关键步骤：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",n(c.li,{children:\"计算任务的开始时间和过期时间。\"}),\"\\n\",n(c.li,{children:\"根据优先级设置超时时间。\"}),\"\\n\",n(c.li,{children:\"创建新的任务对象。\"}),\"\\n\",e(c.li,{children:[\"将任务添加到适当的队列（\",n(c.code,{children:\"taskQueue\"}),\"或\",n(c.code,{children:\"timerQueue\"}),\"）。\"]}),\"\\n\",n(c.li,{children:\"如果需要，调度主机回调或超时。\"}),\"\\n\"]}),\"\\n\",e(c.h3,{id:\"43-任务排序\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#43-任务排序\",children:n(c.span,{className:\"icon icon-link\"})}),\"4.3 任务排序\"]}),\"\\n\",e(c.p,{children:[\"任务在添加到队列时会进行排序。排序的关键在于\",n(c.code,{children:\"sortIndex\"}),\"属性：\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[\"对于延迟任务（\",n(c.code,{children:\"timerQueue\"}),\"），\",n(c.code,{children:\"sortIndex\"}),\"是任务的开始时间。\"]}),\"\\n\",e(c.li,{children:[\"对于立即执行的任务（\",n(c.code,{children:\"taskQueue\"}),\"），\",n(c.code,{children:\"sortIndex\"}),\"是任务的过期时间。\"]}),\"\\n\"]}),\"\\n\",e(c.p,{children:[\"排序过程通过\",n(c.code,{children:\"push\"}),\"函数实现，该函数内部调用\",n(c.code,{children:\"siftUp\"}),\"来维护小顶堆的性质：\"]}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/scheduler/src/Scheduler.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" push\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"length\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"push\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  siftUp\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" siftUp\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"i\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"i\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"true\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" parentIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" - \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") >>> \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" parent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"parentIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"]\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"parent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"undefined\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"compare\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"parent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") > \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // The parent is larger. Swap positions.\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"parentIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"parent\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"parentIndex\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // The parent is smaller. Exit.\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个过程确保了队列中的任务始终按照正确的顺序排列，使得优先级最高的任务总是位于队列的顶部。\"}),\"\\n\",e(c.h2,{id:\"5-任务队列的调度过程\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#5-任务队列的调度过程\",children:n(c.span,{className:\"icon icon-link\"})}),\"5. 任务队列的调度过程\"]}),\"\\n\",n(c.p,{children:\"创建任务队列后，React需要有效地调度这些任务。\"}),\"\\n\",e(c.h3,{id:\"51-调度器的初始化\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#51-调度器的初始化\",children:n(c.span,{className:\"icon icon-link\"})}),\"5.1 调度器的初始化\"]}),\"\\n\",n(c.p,{children:\"React使用调度系统来管理任务的执行。这个系统的核心是Scheduler.js中的几个关键函数和机制。\"}),\"\\n\",e(c.ol,{children:[\"\\n\",n(c.li,{children:\"调度器初始化:\"}),\"\\n\"]}),\"\\n\",e(c.p,{children:[\"当我们调用\",n(c.code,{children:\"requestHostCallback\"}),\"时,它会设置\",n(c.code,{children:\"scheduledHostCallback\"}),\"并通过\",n(c.code,{children:\"MessageChannel\"}),\"发送一个消息:\"]}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/scheduler/src/Scheduler.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 创建一个MessageChannel用于任务调度\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" channel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"new\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" MessageChannel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" port\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"channel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"port2\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 请求主机回调函数\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" requestHostCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"callback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 设置调度回调函数\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  scheduledHostCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callback\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (!\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"isMessageLoopRunning\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    isMessageLoopRunning\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 通过MessageChannel发送消息,触发任务执行\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    port\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"postMessage\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 消息事件处理函数\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"channel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"port1\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"onmessage\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"performWorkUntilDeadline\"})]})]})})}),\"\\n\",n(c.p,{children:\"这段代码的工作原理如下:\"}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[\"创建一个\",n(c.code,{children:\"MessageChannel\"}),\"用于在主线程和调度器之间通信。\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"requestHostCallback\"}),\"函数用于设置要执行的回调函数。\"]}),\"\\n\",n(c.li,{children:\"当设置了新的回调函数时,如果消息循环还没有运行,就发送一个消息来启动它。\"}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"channel.port1.onmessage\"}),\"设置为\",n(c.code,{children:\"performWorkUntilDeadline\"}),\"函数,这个函数将在收到消息时被调用。\"]}),\"\\n\"]}),\"\\n\",e(c.ol,{start:\"2\",children:[\"\\n\",n(c.li,{children:\"执行调度任务:\"}),\"\\n\"]}),\"\\n\",e(c.p,{children:[n(c.code,{children:\"performWorkUntilDeadline\"}),\"函数是调度器的核心,它负责执行任务并管理时间:\"]}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/scheduler/src/Scheduler.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" scheduledHostCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" isMessageLoopRunning\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = -\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" performWorkUntilDeadline\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"scheduledHostCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 获取当前时间\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"getCurrentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 计算截止时间\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    deadline\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" + \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"yieldInterval\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 标记开始时间\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" hasTimeRemaining\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    try\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 执行调度的回调函数\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" hasMoreWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"scheduledHostCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"hasTimeRemaining\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (!\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"hasMoreWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"        // 如果没有更多工作,停止消息循环\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        isMessageLoopRunning\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        scheduledHostCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"        // 如果还有更多工作,继续发送消息\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        port\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"postMessage\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"catch\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"error\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 如果发生错误,继续发送消息并抛出错误\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      port\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"postMessage\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      throw\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" error\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    isMessageLoopRunning\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 重置开始时间\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = -\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个函数的工作流程如下:\"}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"检查是否有调度的回调函数。\"}),\"\\n\",n(c.li,{children:\"如果有,执行这个回调函数,并传入时间信息。\"}),\"\\n\",n(c.li,{children:\"根据回调函数的返回值决定是否继续循环。\"}),\"\\n\",n(c.li,{children:\"如果发生错误,确保继续发送消息以保持循环,然后抛出错误。\"}),\"\\n\",n(c.li,{children:\"如果没有回调函数,停止消息循环。\"}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"通过这种机制,React能够在主线程空闲时执行任务,并在需要时让出控制权,保证了页面的响应。\"}),\"\\n\",e(c.h3,{id:\"52-任务执行\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#52-任务执行\",children:n(c.span,{className:\"icon icon-link\"})}),\"5.2 任务执行\"]}),\"\\n\",e(c.p,{children:[\"任务的实际执行是在\",n(c.code,{children:\"workLoop\"}),\"函数中完成的。这个函数是React调度器的核心,负责循环执行队列中的任务。\"]}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/scheduler/src/Scheduler.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" workLoop\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"hasTimeRemaining\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"initialTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"initialTime\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 更新定时器队列中的任务\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  advanceTimers\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 获取任务队列中的第一个任务\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"peek\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"taskQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && !(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"enableSchedulerDebugging\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"isSchedulerPaused\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 检查任务是否过期,或者是否需要让出执行权\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"expirationTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" > \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && (!\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"hasTimeRemaining\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" || \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"shouldYieldToHost\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"())) {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 当前任务还没过期,但已经到达时间限制,需要中断执行\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      break\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" callback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callback\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" callback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'function'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 重置任务的回调,防止重复执行\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 设置当前优先级\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      currentPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"priorityLevel\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 检查任务是否已超时\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" didUserCallbackTimeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"expirationTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <= \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 执行任务回调\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" continuationCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"callback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"didUserCallbackTimeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 更新当前时间\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"getCurrentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" continuationCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'function'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"        // 如果回调返回一个函数,说明任务需要继续执行\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"continuationCallback\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"        // 任务完成,将其从队列中移除\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"peek\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"taskQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"          pop\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"taskQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"        }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 再次更新定时器队列\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      advanceTimers\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 如果回调不是函数,直接将任务从队列中移除\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      pop\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"taskQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 获取下一个任务\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"peek\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"taskQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 检查是否还有更多工作要做\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" true\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 如果任务队列为空,检查定时器队列\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" firstTimer\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"peek\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"timerQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"firstTimer\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 如果有延迟任务,安排一个新的超时回调\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      requestHostTimeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"handleTimeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"firstTimer\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" - \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" false\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个函数的工作流程如下:\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:\"首先更新定时器队列,将到期的定时器任务移到主任务队列中。\"}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:\"然后开始一个循环,不断从任务队列中取出任务执行:\"}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"检查任务是否过期或是否需要让出执行权。\"}),\"\\n\",n(c.li,{children:\"如果任务还没过期但已达到时间限制,就中断执行。\"}),\"\\n\",n(c.li,{children:\"执行任务的回调函数。\"}),\"\\n\",n(c.li,{children:\"如果回调返回一个新的函数,说明任务需要继续执行,就将这个新函数设置为任务的回调。\"}),\"\\n\",n(c.li,{children:\"如果任务执行完毕,就将其从队列中移除。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:\"每执行完一个任务,都会再次更新定时器队列,确保及时处理到期的定时器任务。\"}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:\"循环结束后,如果任务队列中还有任务,就返回true,表示还有工作要做。\"}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:\"如果任务队列为空,但定时器队列中有任务,就安排一个新的超时回调,以便在定时器到期时继续执行。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.h3,{id:\"53-任务中断与恢复\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#53-任务中断与恢复\",children:n(c.span,{className:\"icon icon-link\"})}),\"5.3 任务中断与恢复\"]}),\"\\n\",e(c.p,{children:[\"React Fiber的一个核心特性是可中断渲染，这允许React在长时间运行的任务中途暂停，将控制权交还给浏览器，从而保持UI的响应。这个机制主要通过任务调度和时间切片来实现，其中\",n(c.code,{children:\"shouldYieldToHost\"}),\"函数扮演了关键角色。\"]}),\"\\n\",e(c.h4,{id:\"531-shouldyieldtohost-函数\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#531-shouldyieldtohost-函数\",children:n(c.span,{className:\"icon icon-link\"})}),\"5.3.1 shouldYieldToHost 函数\"]}),\"\\n\",e(c.p,{children:[n(c.code,{children:\"shouldYieldToHost\"}),\"函数决定是否应该中断当前任务，将控制权交还给浏览器：\"]}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/scheduler/src/Scheduler.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" shouldYieldToHost\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 计算从任务开始到现在经过的时间\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" timeElapsed\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"getCurrentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() - \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"startTime\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 如果经过的时间小于一帧的时间，继续执行任务\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"timeElapsed\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"frameInterval\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 主线程被阻塞的时间很短，小于一帧的时间。\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 此时不需要让出控制权，继续执行当前任务。\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" false\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 检查是否启用了isInputPending API\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"enableIsInputPending\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 检查是否有待处理的绘制任务\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"needsPaint\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 有待处理的绘制任务，立即让出控制权\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" true\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 检查是否有待处理的离散输入事件（如点击）\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"timeElapsed\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"continuousInputInterval\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 如果阻塞时间不长，只在有待处理的离散输入时让出控制权\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" isInputPending\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 检查是否有任何类型的待处理输入事件\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"timeElapsed\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"maxInterval\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 已经阻塞了一段时间，但仍在可接受范围内\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 只在有待处理的输入（离散或连续）时让出控制权\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" isInputPending\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"continuousOptions\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 已经阻塞了很长时间，无条件让出控制权\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" true\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 如果isInputPending API不可用，总是让出控制权\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" true\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个函数有这几个因素来决定是否中断任务：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",n(c.li,{children:\"任务执行时间\"}),\"\\n\",n(c.li,{children:\"是否有待处理的绘制任务\"}),\"\\n\",n(c.li,{children:\"是否有待处理的用户输入（区分离散输入和连续输入）\"}),\"\\n\",e(c.li,{children:[\"浏览器是否支持\",n(c.code,{children:\"isInputPending\"}),\" API\"]}),\"\\n\"]}),\"\\n\",e(c.h4,{id:\"532-任务中断和恢复的实现\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#532-任务中断和恢复的实现\",children:n(c.span,{className:\"icon icon-link\"})}),\"5.3.2 任务中断和恢复的实现\"]}),\"\\n\",n(c.p,{children:\"任务的中断和恢复主要在React的工作循环中实现：\"}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/react-reconciler/src/ReactFiberWorkLoop.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" workLoopConcurrent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && !\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"shouldYield\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    performUnitOfWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:[\"在这个并发模式的工作循环中，React 会不断检查 \",n(c.code,{children:\"shouldYield()\"}),\" 函数（内部会调用 \",n(c.code,{children:\"shouldYieldToHost()\"}),\"）。如果需要让出控制权，React 会中断当前的渲染过程。\"]}),\"\\n\",n(c.p,{children:\"任务的恢复由React的调度器负责：\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" performConcurrentWorkOnRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"didTimeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  do\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    try\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"didTimeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"        renderRootSync\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"        renderRootConcurrent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      break\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"catch\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"thrownValue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      handleError\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"thrownValue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"true\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"originalCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 如果当前执行的任务节点与调度的节点相同，\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 返回一个继续执行的回调函数\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" performConcurrentWorkOnRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"bind\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" null\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:[\"如果任务被中断，\",n(c.code,{children:\"performConcurrentWorkOnRoot\"}),\" 函数会返回一个继续执行的回调，允许调度器在之后恢复这个任务。\"]}),\"\\n\",e(c.h4,{id:\"533-优先级管理和任务切换\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#533-优先级管理和任务切换\",children:n(c.span,{className:\"icon icon-link\"})}),\"5.3.3 优先级管理和任务切换\"]}),\"\\n\",n(c.p,{children:\"React 还通过优先级管理来决定任务的执行顺序：\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" ensureRootIsScheduled\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"FiberRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"number\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" newCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"getHighestPriorityLane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" existingCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"existingCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 优先级没有变化，可以复用现有任务\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"existingCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" != \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 取消现有的回调，准备调度新的回调\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    cancelCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"existingCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 调度新的回调\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" newCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"SyncLane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 同步优先级使用特殊的内部队列\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    newCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"scheduleSyncCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      performSyncWorkOnRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"bind\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    );\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" schedulerPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"lanePriorityToSchedulerPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#4BF3C8\"},children:\"      newCallbackPriority\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    );\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    newCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"scheduleCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      schedulerPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      performConcurrentWorkOnRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"bind\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    );\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个函数确保根节点被正确调度，它会根据任务的优先级来决定是否中断当前任务并调度新的高优先级任务。\"}),\"\\n\",n(c.p,{children:\"通过这种复杂的任务中断、恢复和优先级管理机制，React能够在执行长时间任务时保持对用户输入的响应，提供流畅的用户体验。\"}),\"\\n\",e(c.p,{children:[\"在实际应用中，我们可以利用这一机制来优化性能，例如将大型计算任务拆分成小块，使用\",n(c.code,{children:\"React.useCallback\"}),\"和\",n(c.code,{children:\"React.useMemo\"}),\"来缓存计算结果，或者使用\",n(c.code,{children:\"React.lazy\"}),\"和\",n(c.code,{children:\"Suspense\"}),\"来延迟加载不急需的组件。\"]}),\"\\n\",e(c.ol,{children:[\"\\n\",n(c.li,{children:\"React.useCallback 和 React.useMemo\"}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"这两个hooks都是用于性能优化，通过缓存计算结果来避免不必要的重新计算，从而减少渲染时间，他们的本质其实是让出更多时间给高优先级任务。\"}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/react-reconciler/src/ReactFiberHooks.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" updateMemo\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"T\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  nextCreate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": () \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" T\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  deps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Array\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"mixed\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"> | \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"void\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | null,\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"): \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"T\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" hook\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"updateWorkInProgressHook\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"();\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" nextDeps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"deps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"undefined\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" ?\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" null\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" :\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" deps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" prevState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"hook\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"memoizedState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"prevState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextDeps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" prevDeps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Array\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"mixed\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"> | null = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"prevState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"];\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"areHookInputsEqual\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextDeps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"prevDeps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" prevState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"];\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" nextValue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"nextCreate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"();\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  hook\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"memoizedState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = [\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextValue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextDeps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"];\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" nextValue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:[\"这是\",n(c.code,{children:\"useMemo\"}),\"的实现。它会检查依赖是否变化，如果没有变化，直接返回缓存的值，避免重新计算。这样可以减少不必要的计算，为其他高优先级任务留出更多时间。\"]}),\"\\n\",e(c.ol,{start:\"2\",children:[\"\\n\",n(c.li,{children:\"React.lazy 和 Suspense\"}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"这两个API允许我们延迟加载组件，减少初始加载时间，并在加载过程中显示fallback内容。\"}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/react/src/ReactLazy.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" lazy\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"T\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  ctor\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": () \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" Thenable\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"default\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"T\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", ...}>,\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"): \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"LazyComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"T\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Payload\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"T\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">> {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" payload\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Payload\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"T\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"> = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    _status\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Uninitialized\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    _result\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"ctor\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  };\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" lazyType\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"LazyComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"T\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Payload\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"T\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">> = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    $$typeof\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"REACT_LAZY_TYPE\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    _payload\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"payload\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    _init\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lazyInitializer\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  };\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" lazyType\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:[\"这是\",n(c.code,{children:\"React.lazy\"}),\"的实现。它创建一个特殊的组件类型，这个组件在渲染时会触发异步加载。\"]}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/react-reconciler/src/ReactFiberThrow.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" throwException\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"FiberRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  sourceFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  value\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"mixed\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  rootRenderLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"value\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" value\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'object'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" value\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"then\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'function'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // This is a wakeable.\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" wakeable\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Wakeable\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = (\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"value\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"any\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // ...\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // Schedule the nearest Suspense to re-render the timed out view.\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" suspenseBoundary\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"getNearestSuspenseBoundaryToCapture\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"suspenseBoundary\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      suspenseBoundary\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" &=\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" ~\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"ForceClientRender\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      markSuspenseBoundaryShouldCapture\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        suspenseBoundary\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        sourceFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        rootRenderLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      );\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // We only attach ping listeners in concurrent mode.\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"suspenseBoundary\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"mode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" & \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"ConcurrentMode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"        attachPingListener\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"wakeable\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"rootRenderLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // ...\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"当遇到一个Promise时，React会寻找最近的Suspense边界，并让它重新渲染。这允许React在异步内容加载时显示fallback内容，而不会阻塞整个应用的渲染。\"}),\"\\n\",n(c.p,{children:\"就是说\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.code,{children:\"useCallback\"}),\"和\",n(c.code,{children:\"useMemo\"}),\"通过减少不必要的计算和渲染，为其他可能被中断的高优先级任务留出更多时间。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.code,{children:\"React.lazy\"}),\"和\",n(c.code,{children:\"Suspense\"}),\"允许React在遇到尚未加载的组件时暂停渲染，显示fallback内容，然后在组件加载完成后恢复渲染。这整个过程都是可中断的，允许React在必要时处理更高优先级的任务。\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"例如，考虑以下场景：\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" HeavyComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"React\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"lazy\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(() \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" import\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'./HeavyComponent'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"))\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" App\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"showHeavy\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"setShowHeavy\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"false\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" heavyCalculation\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useMemo\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(() \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" computeExpensiveValue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"a\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"b\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"), [\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"a\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"b\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"])\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"button\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\" onClick\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"=\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" setShowHeavy\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"true\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Load Heavy Component</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"button\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"p\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"heavyCalculation\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"p\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Suspense\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\" fallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"=\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Loading...</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"showHeavy\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"HeavyComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"</\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Suspense\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    </\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  )\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"在这个例子中：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.code,{children:\"useMemo\"}),\"确保\",n(c.code,{children:\"heavyCalculation\"}),\"只在\",n(c.code,{children:\"a\"}),\"或\",n(c.code,{children:\"b\"}),\"改变时重新计算，避免在每次渲染时都进行昂贵的计算。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.code,{children:\"React.lazy\"}),\"和\",n(c.code,{children:\"Suspense\"}),\"允许\",n(c.code,{children:\"HeavyComponent\"}),\"延迟加载。当用户点击按钮时，React会开始加载组件，但不会阻塞UI，而是显示fallback内容。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:\"整个过程中，如果有更高优先级的任务（如用户输入），React可以中断当前任务，处理高优先级任务，然后再恢复之前的渲染。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"这其实就是这些API如何与React的任务中断、恢复和优先级管理机制协同工作，也是我们真正在开发的时候会遇到的场景。\"}),\"\\n\",e(c.h3,{id:\"54-优先级管理和饥饿问题的解决\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#54-优先级管理和饥饿问题的解决\",children:n(c.span,{className:\"icon icon-link\"})}),\"5.4 优先级管理和饥饿问题的解决\"]}),\"\\n\",n(c.p,{children:\"React的调度系统不仅要处理任务的执行，还需要解决由于持续的高优先级任务导致的低优先级任务饥饿问题（一直不执行）。\"}),\"\\n\",e(c.ol,{children:[\"\\n\",n(c.li,{children:n(c.strong,{children:\"标记饥饿车道\"})}),\"\\n\"]}),\"\\n\",e(c.p,{children:[\"在每次调度更新时，React都会调用\",n(c.code,{children:\"ensureRootIsScheduled\"}),\"函数，该函数会调用\",n(c.code,{children:\"markStarvedLanesAsExpired\"}),'来检查是否有被其他工作\"饿死\"的车道。']}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/react-reconciler/src/ReactFiberWorkLoop.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" ensureRootIsScheduled\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"FiberRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"number\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" existingCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 检查是否有任何车道被其他工作饿死。如果有，将它们标记为过期。\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  markStarvedLanesAsExpired\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ... [rest of the function]\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.ol,{start:\"2\",children:[\"\\n\",n(c.li,{children:n(c.strong,{children:\"计算过期时间\"})}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"对于每个待处理的车道，React会计算一个过期时间。这个过期时间根据车道的优先级而不同。\"}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/react-reconciler/src/ReactFiberLane.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" computeExpirationTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"lane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Lane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"number\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  switch\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" SyncLane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" InputContinuousLane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" + \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"250\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" DefaultLane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" TransitionLane1\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" TransitionLane16\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" + \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"5000\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // ... [other cases]\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.ol,{start:\"3\",children:[\"\\n\",n(c.li,{children:n(c.strong,{children:\"标记过期车道\"})}),\"\\n\"]}),\"\\n\",e(c.p,{children:[\"在后续的调度更新中，React会检查每个车道是否已经过期。如果过期，会在\",n(c.code,{children:\"root.expiredLanes\"}),\"上标记该车道。\"]}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/react-reconciler/src/ReactFiberLane.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"export\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" markStarvedLanesAsExpired\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"FiberRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"number\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"): \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"void\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" pendingLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"pendingLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" expirationTimes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"expirationTimes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"pendingLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" > \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"pickArbitraryLaneIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" lane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" << \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" expirationTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"expirationTimes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"];\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"expirationTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoTimestamp\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      expirationTimes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"computeExpirationTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"expirationTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <= \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"expiredLanes\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" |=\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" lane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    lanes\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" &=\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" ~\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.ol,{start:\"4\",children:[\"\\n\",n(c.li,{children:n(c.strong,{children:\"处理过期车道\"})}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"在执行更新时，React会检查是否有过期的车道。如果有，这些任务会被提升到同步优先级进行处理。\"}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/react-reconciler/src/ReactFiberWorkLoop.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" performConcurrentWorkOnRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" shouldTimeSlice\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" =\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    !\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"includesBlockingLane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") &&\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    !\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"includesExpiredLane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") &&\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"disableSchedulerTimeoutInWorkLoop\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" || !\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"didTimeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" exitStatus\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"shouldTimeSlice\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" ?\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" renderRootConcurrent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\":\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" renderRootSync\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"通过这种机制，React确保即使在有大量高优先级任务的情况下，低优先级任务最终也能得到执行，从而解决了饥饿问题。\"}),\"\\n\",e(c.h2,{id:\"6-任务队列与react的协调过程\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#6-任务队列与react的协调过程\",children:n(c.span,{className:\"icon icon-link\"})}),\"6. 任务队列与React的协调过程\"]}),\"\\n\",n(c.p,{children:\"任务队列不仅仅是一个独立的调度系统，它与React的协调过程紧密相连。在这个过程中，React的车道优先级（Lane Priority）和调度器的优先级（Scheduler Priority）扮演着重要角色。这两种优先级系统在实际应用中有着不同的作用和表现。\"}),\"\\n\",e(c.h3,{id:\"61-车道优先级lane-priority的实际应用\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#61-车道优先级lane-priority的实际应用\",children:n(c.span,{className:\"icon icon-link\"})}),\"6.1 车道优先级（Lane Priority）的实际应用\"]}),\"\\n\",n(c.p,{children:\"车道优先级主要用于React内部的更新调度。它允许React更细粒度地控制不同类型更新的优先级。例如：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[n(c.strong,{children:\"用户交互\"}),\"：如点击事件，通常被赋予高优先级车道。\"]}),\"\\n\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" Button\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"count\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"setCount\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" handleClick\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = () \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 这个更新会被分配高优先级车道\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    setCount\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"count\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" + \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"button\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\" onClick\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"=\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"handleClick\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Clicked \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"count\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" times</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"button\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.ol,{start:\"2\",children:[\"\\n\",e(c.li,{children:[n(c.strong,{children:\"数据获取\"}),\"：通常被赋予默认优先级车道。\"]}),\"\\n\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" DataFetcher\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"data\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"setData\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  useEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(() \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 这个更新会被分配默认优先级车道\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    fetchData\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"().\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"then\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"setData\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }, [])\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" data\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" ?\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"data\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"> \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\":\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Loading...</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.ol,{start:\"3\",children:[\"\\n\",e(c.li,{children:[n(c.strong,{children:\"后台计算\"}),\"：可以使用低优先级车道。\"]}),\"\\n\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" ExpensiveComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"result\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"setResult\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  useEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(() \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 使用 startTransition 将更新标记为低优先级\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    startTransition\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(() \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" computedResult\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"expensiveComputation\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      setResult\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"computedResult\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    })\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }, [])\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" result\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" ?\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"result\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"> \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\":\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Computing...</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.h3,{id:\"62-调度器优先级scheduler-priority的实际应用\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#62-调度器优先级scheduler-priority的实际应用\",children:n(c.span,{className:\"icon icon-link\"})}),\"6.2 调度器优先级（Scheduler Priority）的实际应用\"]}),\"\\n\",n(c.p,{children:\"调度器优先级主要用于决定任务在JavaScript运行时中的执行顺序。它直接影响到任务何时被执行，我写一下伪代码。\"}),\"\\n\",n(c.p,{children:\"例如：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[n(c.strong,{children:\"即时优先级\"}),\"：用于需要立即执行的任务，如动画或拖拽。\"]}),\"\\n\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" AnimatedComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"position\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"setPosition\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  useEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(() \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" animate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = () \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      Scheduler\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"unstable_runWithPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Scheduler\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"unstable_ImmediatePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", () \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"        setPosition\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"((\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"prev\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" prev\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" + \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      })\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      requestAnimationFrame\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"animate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    animate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }, [])\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\" style\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"=\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"{ \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"transform\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"`translateX(\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"${\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"position\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"px)`\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" }\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.ol,{start:\"2\",children:[\"\\n\",e(c.li,{children:[n(c.strong,{children:\"用户阻塞优先级\"}),\"：用于需要快速响应但不需要立即执行的任务，如文本输入。\"]}),\"\\n\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" SearchInput\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"query\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"setQuery\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"''\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" handleChange\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = (\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"e\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    Scheduler\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"unstable_runWithPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Scheduler\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"unstable_UserBlockingPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", () \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      setQuery\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"e\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"target\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"value\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    })\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"input\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\" value\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"=\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"query\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\" onChange\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"=\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"handleChange\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.ol,{start:\"3\",children:[\"\\n\",e(c.li,{children:[n(c.strong,{children:\"普通优先级\"}),\"：用于不需要立即响应的更新，如网络请求。\"]}),\"\\n\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" DataFetcher\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"data\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"setData\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  useEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(() \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    Scheduler\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"unstable_runWithPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Scheduler\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"unstable_NormalPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", () \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      fetchData\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"().\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"then\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"setData\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    })\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }, [])\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" data\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" ?\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"data\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"> \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\":\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Loading...</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"优先级在任务调度过程中起着关键作用。高优先级的任务（如用户输入）会中断低优先级的任务（如数据获取）。这是通过比较当前执行任务的优先级和新到来任务的优先级来实现的。\"}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/scheduler/src/Scheduler.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" unstable_runWithPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"priorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"eventHandler\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  switch\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"priorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" ImmediatePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" UserBlockingPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" NormalPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" LowPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" IdlePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      break\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    default\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      priorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NormalPriority\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" previousPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentPriorityLevel\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  currentPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"priorityLevel\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  try\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" eventHandler\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"finally\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    currentPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"previousPriorityLevel\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个函数允许在特定优先级下运行一个事件处理器。它临时改变当前的优先级级别，执行处理器，然后恢复原来的优先级级别。这确保了高优先级的操作能够及时响应，而不会被低优先级的任务阻塞。\"}),\"\\n\",e(c.h3,{id:\"63-混合优先级\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#63-混合优先级\",children:n(c.span,{className:\"icon icon-link\"})}),\"6.3 混合优先级\"]}),\"\\n\",n(c.p,{children:\"例子：\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" ComplexComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"text\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"setText\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"''\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"list\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"setList\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"([])\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"isPending\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"startTransition\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useTransition\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" handleInputChange\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = (\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"e\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" newText\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"e\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"target\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"value\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 高优先级更新：立即更新输入框\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    setText\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newText\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 低优先级更新：在transition中更新列表\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    startTransition\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(() \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" newList\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"generateLargeList\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newText\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      setList\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newList\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    })\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"input\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\" value\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"=\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"text\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\" onChange\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"=\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"handleInputChange\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      {\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"isPending\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" ?\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"p\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Updating list...</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"p\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"> \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\":\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" null\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"ul\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        {\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"list\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"map\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"((\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"item\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"          <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"li\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\" key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"=\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"item\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"id\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"item\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"text\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"li\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"        ))\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      </\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"ul\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    </\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  )\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"在这个例子中：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"车道优先级\"}),\"：\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[\"输入框的更新（\",n(c.code,{children:\"setText\"}),\"）被赋予高优先级车道，因为它直接响应用户输入。\"]}),\"\\n\",e(c.li,{children:[\"列表的更新（\",n(c.code,{children:\"setList\"}),\"）被包裹在 \",n(c.code,{children:\"startTransition\"}),\" 中，被赋予低优先级车道，因为它是一个可能耗时的操作。\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"调度器优先级\"}),\"：\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[\"React 内部会将高优先级车道的更新（输入框）转换为调度器的高优先级（如 \",n(c.code,{children:\"UserBlockingPriority\"}),\"）。\"]}),\"\\n\",e(c.li,{children:[\"低优先级车道的更新（列表）会被转换为较低的调度器优先级（如 \",n(c.code,{children:\"NormalPriority\"}),\"）。\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"优先级协同工作\"}),\"：\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"当用户输入时，输入框会立即更新，提供即时反馈。\"}),\"\\n\",n(c.li,{children:\"同时，列表更新被标记为低优先级，允许 React 在主线程空闲时才进行处理。\"}),\"\\n\",n(c.li,{children:\"如果用户继续输入，新的高优先级更新（输入框）会中断正在进行的低优先级更新（列表），确保界面始终响应。\"}),\"\\n\",n(c.li,{children:\"当输入停止，React 会完成被中断的列表更新。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"状态管理\"}),\"：\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[n(c.code,{children:\"isPending\"}),\" 状态允许我们在低优先级更新进行时显示加载指示器，提升用户体验。\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.h3,{id:\"64-在源码实现中\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#64-在源码实现中\",children:n(c.span,{className:\"icon icon-link\"})}),\"6.4 在源码实现中\"]}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"车道优先级（Lane Priority）\"}),\":\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"在 React 的协调过程中使用。\"}),\"\\n\",n(c.li,{children:\"用于标记更新的紧急程度和重要性。\"}),\"\\n\",n(c.li,{children:\"决定了更新在 React 内部处理的顺序。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"调度器优先级（Scheduler Priority）\"}),\":\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"在 React 的调度器中使用。\"}),\"\\n\",n(c.li,{children:\"决定任务在 JavaScript 运行时中的执行顺序。\"}),\"\\n\",n(c.li,{children:\"控制任务何时被执行。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"任务管理\"}),\":\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"涉及车道优先级和调度器优先级。\"}),\"\\n\",n(c.li,{children:\"使用车道优先级来标记任务的重要性。\"}),\"\\n\",n(c.li,{children:\"将车道优先级转换为调度器优先级，以决定任务的执行顺序。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"协调过程\"}),\":\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"主要使用车道优先级。\"}),\"\\n\",n(c.li,{children:\"决定哪些更新应该被优先处理。\"}),\"\\n\",n(c.li,{children:\"在构建和比较 Fiber 树时考虑车道优先级。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"优先级转换\"}),\":\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"发生在任务被调度时。\"}),\"\\n\",n(c.li,{children:\"React 内部将车道优先级转换为调度器优先级。\"}),\"\\n\",n(c.li,{children:\"这个转换确保了 React 的内部优先级系统与调度器的优先级系统能够协同工作。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" ensureRootIsScheduled\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"FiberRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"number\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" existingCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 检查是否有任何车道被其他工作饿死。如果有，将它们标记为过期，以便我们知道下一步要处理它们。\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  markStarvedLanesAsExpired\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 确定下一个要处理的车道，以及它们的优先级。\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" nextLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"getNextLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgressRoot\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" ?\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" workInProgressRootRenderLanes\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" :\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" NoLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  );\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 如果没有需要处理的车道，取消现有的回调并返回\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"existingCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      cancelCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"existingCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoLane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 使用最高优先级的车道来表示回调的优先级\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" newCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"getHighestPriorityLane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 检查是否存在现有任务。我们可能可以重用它。\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" existingCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"existingCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 优先级没有改变。我们可以重用现有的任务。\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 如果存在现有的回调节点，取消它\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"existingCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" != \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    cancelCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"existingCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 调度一个新的回调\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" newCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"SyncLane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 特殊情况：同步React回调被调度在一个特殊的内部队列中\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    newCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"scheduleSyncCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      performSyncWorkOnRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"bind\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"),\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    );\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 将车道优先级转换为调度器优先级\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" schedulerPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"lanePriorityToSchedulerPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      newCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    );\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 使用调度器优先级调度新的回调\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    newCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"scheduleCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      schedulerPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      performConcurrentWorkOnRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"bind\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"),\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    );\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 更新根节点的回调优先级和回调节点\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个函数负责确保根Fiber节点被正确调度。它会检查是否有新的工作需要执行，并根据优先级创建或重用任务。\"}),\"\\n\",e(c.h3,{id:\"65-车道和优先级转换\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#65-车道和优先级转换\",children:n(c.span,{className:\"icon icon-link\"})}),\"6.5 车道和优先级转换\"]}),\"\\n\",e(c.p,{children:[\"在理解源码前，我们要再次加深这两种优先级的意义，\",n(c.code,{children:\"枯燥\"}),\"的理解源码\",n(c.code,{children:\"毫无意义\"}),\"。\"]}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:\"调度器优先级（Scheduler Priority）：\"}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"这是最终决定任务执行顺序的关键因素。\"}),\"\\n\",n(c.li,{children:\"它直接与 JavaScript 运行时交互，决定哪些任务应该先执行，哪些可以稍后执行。\"}),\"\\n\",n(c.li,{children:n(c.code,{children:'调度器优先级是 React 与底层 JavaScript 引擎通信的\"语言\"。'})}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:\"车道优先级（Lane Priority）：\"}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"这是 React 内部使用的一个更细粒度的优先级系统。\"}),\"\\n\",n(c.li,{children:\"它允许 React 更精确地表达不同类型更新的重要性和紧急程度。\"}),\"\\n\",n(c.li,{children:n(c.code,{children:'车道优先级可以看作是 React 的内部\"思考过程\"，用于决定不同更新的相对重要性。'})}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:\"优先级转换：\"}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"React 需要将其内部的车道优先级转换为调度器可以理解的优先级。\"}),\"\\n\",n(c.li,{children:n(c.code,{children:'这个转换过程可以看作是 React 的\"决策过程\"，将其内部的复杂优先级系统映射到调度器的相对简单的优先级系统上。'})}),\"\\n\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"export\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" lanePriorityToSchedulerPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"lanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"LanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"): \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"ReactPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  switch\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" SyncLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" SyncBatchedLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" ImmediatePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" InputDiscreteHydrationLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" InputDiscreteLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" InputContinuousHydrationLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" InputContinuousLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" UserBlockingPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" DefaultHydrationLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" DefaultLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" TransitionHydrationPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" TransitionPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" SelectiveHydrationLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" RetryLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" NormalPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" IdleHydrationLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" IdleLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" OffscreenLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" IdlePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" NoLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" NoSchedulerPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    default\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      invariant\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#FFD493\"},children:\"        false\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#FFD493\"},children:\"        'Invalid update priority: %s. This is a bug in React.'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        lanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      );\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个函数负责将React的车道优先级转换为调度器的优先级。这种转换关系如下：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",n(c.li,{children:\"同步优先级（Sync）对应调度器的立即优先级（Immediate）\"}),\"\\n\",n(c.li,{children:\"输入优先级（Input）对应用户阻塞优先级（UserBlocking）\"}),\"\\n\",n(c.li,{children:\"默认优先级（Default）和过渡优先级（Transition）对应普通优先级（Normal）\"}),\"\\n\",n(c.li,{children:\"空闲优先级（Idle）对应调度器的空闲优先级（Idle）\"}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"这种转换确保了React内部的优先级系统能够与调度器的优先级系统协同工作，从而实现更精细的任务调度。\"}),\"\\n\",e(c.h2,{id:\"7-任务队列与react并发模式\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#7-任务队列与react并发模式\",children:n(c.span,{className:\"icon icon-link\"})}),\"7. 任务队列与React并发模式\"]}),\"\\n\",e(c.p,{children:[\"在我们上述讲的所有内容都是达成 \",n(c.code,{children:\"并发模式\"}),\" 的拼图，首先我们需要抓住关键词 \",n(c.code,{children:\"并发模式\"}),\"，而不是实现 \",n(c.code,{children:\"并发\"}),\"，\",n(c.code,{children:\"JavaScript\"}),\" 是单线程的，传统意义上的并发（如多线程）是同时处理多个任务。\"]}),\"\\n\",e(c.h3,{id:\"71-并发本质\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#71-并发本质\",children:n(c.span,{className:\"icon icon-link\"})}),\"7.1 并发本质\"]}),\"\\n\",n(c.p,{children:\"它的本质是：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[n(c.strong,{children:\"交错执行\"}),\"：在单一线程上交错执行多个任务。\"]}),\"\\n\",e(c.li,{children:[n(c.strong,{children:\"优先级调度\"}),\"：根据任务的优先级决定执行顺序。\"]}),\"\\n\",e(c.li,{children:[n(c.strong,{children:\"可中断渲染\"}),\"：允许高优先级任务打断低优先级任务。\"]}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"想象你正在做一个大型拼图（低优先级任务，如渲染一个复杂列表），突然电话响了（高优先级任务，如用户输入）。在 React 的并发模式下：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",n(c.li,{children:\"你可以暂停拼图（中断渲染）。\"}),\"\\n\",n(c.li,{children:\"接听电话（处理高优先级任务）。\"}),\"\\n\",n(c.li,{children:\"通话结束后，继续拼图（恢复渲染）。\"}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"代码层面的实现：\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" workLoopConcurrent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && !\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"shouldYield\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    performUnitOfWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" shouldYield\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    getCurrentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() >= \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"deadline\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" || \"}),n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 时间片用完\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    hasHigherPriorityWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() \"}),n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 有更高优先级的工作\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  )\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:[\"这里的 \",n(c.code,{children:\"shouldYield()\"}),\" 函数检查是否应该让出控制权。如果时间片用完或有更高优先级的工作，React 就会暂停当前任务。\"]}),\"\\n\",e(c.h3,{id:\"72-为什么这也算是并发\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#72-为什么这也算是并发\",children:n(c.span,{className:\"icon icon-link\"})}),'7.2 为什么这也算是\"并发\"？']}),\"\\n\",n(c.p,{children:\"React的任务管理机制、任务中断恢复和车道协调共同构成了实现并发的核心框架。\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"多任务交错执行\"}),\"：尽管在任何给定时刻只有一个任务在执行，但从宏观角度看，多个任务是交错进行的。这种交错执行创造了任务并行的错觉，类似于操作系统的时间片轮转调度。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"非阻塞\"}),\"：低优先级任务不会阻塞高优先级任务的执行。这确保了重要的用户交互和更新能够及时响应，提高了应用的整体响应性。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"响应式\"}),\"：系统能够快速响应用户交互，即使在处理大量后台工作时也是如此。这种能力模拟了真正并发系统的行为，多个处理单元同时处理不同的任务。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"公平调度\"}),\"：所有任务最终都会得到处理，只是执行顺序根据优先级动态调整。这种调度策略确保了资源的公平分配，避免了任务饥饿问题。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"细粒度控制\"}),\"：通过车道优先级系统，React能够对任务进行更细粒度的控制，实现了类似于抢占式多任务处理的效果。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"异步渲染\"}),'：React的并发模式支持异步渲染，允许组件\"暂停\"渲染等待数据，这种能力进一步增强了并发的特性。']}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"资源利用优化\"}),\"：通过智能地分配CPU时间，React能够在保持UI响应性的同时，最大化利用可用的计算资源，这其实就是并发追求的东西。\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.p,{children:[\"总的来说，虽然React的 \",n(c.code,{children:\"并发模式\"}),\" 在技术实现上与传统的多线程并发有所不同，但它在功能和效果上实现了类似的目标：提高系统的响应性、优化资源利用、平衡多个任务的执行。\"]}),\"\\n\",e(c.p,{children:[\"这就是 \",n(c.code,{children:\"react\"}),\" 的核心。\"]}),\"\\n\",e(c.h2,{id:\"8-总结\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#8-总结\",children:n(c.span,{className:\"icon icon-link\"})}),\"8. 总结\"]}),\"\\n\",n(c.p,{children:\"React Fiber架构中的任务队列是实现可中断渲染和优先级调度的核心组件。通过深入分析其创建和调度过程，我们可以得出以下几点结论：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"灵活的优先级系统\"}),\"：React使用多级优先级系统，能够精确控制不同类型任务的执行顺序，确保重要的更新能够及时响应。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"高效的数据结构\"}),\"：使用小顶堆实现的优先级队列，保证了任务的快速插入和获取，时间复杂度为O(log n)。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"可中断的执行模型\"}),\"：通过时间切片和yield机制，React能够在长任务执行过程中适时让出主线程，保证页面的响应性。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"与React核心的紧密集成\"}),\"：任务队列与React的协调过程、Lanes系统等核心概念紧密结合，支持了并发模式等高级特性。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"性能优化\"}),\"：通过批量更新、延迟任务处理等机制，任务队列在保证功能的同时也兼顾了性能。\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"其实看这些源码，都是为了写出更高效、更流畅的React应用。\"}),\"\\n\",n(c.p,{children:\"平时大家是靠感觉来使用这些优化手段，那么在理解这个任务队列和调度之后，会让我们心里更有底，也是知其所也然了。\"})]})}return{default:function(l={}){const{wrapper:e}=l.components||{};return e?n(e,{...l,children:n(_createMdxContent,{...l})}):_createMdxContent(l)}};",
    "toc": {
      "content": [
        {
          "title": "1. React Fiber架构：深入解析任务队列、可中断渲染、调度、同步模式",
          "url": "#1-react-fiber架构深入解析任务队列可中断渲染调度同步模式",
          "items": []
        },
        {
          "title": "2. 任务队列的概念和作用",
          "url": "#2-任务队列的概念和作用",
          "items": [
            {
              "title": "2.1 什么是任务队列？",
              "url": "#21-什么是任务队列",
              "items": []
            },
            {
              "title": "2.2 任务队列的作用",
              "url": "#22-任务队列的作用",
              "items": []
            }
          ]
        },
        {
          "title": "3. React源码中的任务队列实现",
          "url": "#3-react源码中的任务队列实现",
          "items": [
            {
              "title": "3.1 数据结构",
              "url": "#31-数据结构",
              "items": []
            },
            {
              "title": "3.2 任务的表示",
              "url": "#32-任务的表示",
              "items": []
            },
            {
              "title": "3.3 优先级的定义",
              "url": "#33-优先级的定义",
              "items": []
            }
          ]
        },
        {
          "title": "4. 任务队列的创建过程",
          "url": "#4-任务队列的创建过程",
          "items": [
            {
              "title": "4.1 初始化",
              "url": "#41-初始化",
              "items": []
            },
            {
              "title": "4.2 添加任务",
              "url": "#42-添加任务",
              "items": []
            },
            {
              "title": "4.3 任务排序",
              "url": "#43-任务排序",
              "items": []
            }
          ]
        },
        {
          "title": "5. 任务队列的调度过程",
          "url": "#5-任务队列的调度过程",
          "items": [
            {
              "title": "5.1 调度器的初始化",
              "url": "#51-调度器的初始化",
              "items": []
            },
            {
              "title": "5.2 任务执行",
              "url": "#52-任务执行",
              "items": []
            },
            {
              "title": "5.3 任务中断与恢复",
              "url": "#53-任务中断与恢复",
              "items": [
                {
                  "title": "5.3.1 shouldYieldToHost 函数",
                  "url": "#531-shouldyieldtohost-函数",
                  "items": []
                },
                {
                  "title": "5.3.2 任务中断和恢复的实现",
                  "url": "#532-任务中断和恢复的实现",
                  "items": []
                },
                {
                  "title": "5.3.3 优先级管理和任务切换",
                  "url": "#533-优先级管理和任务切换",
                  "items": []
                }
              ]
            },
            {
              "title": "5.4 优先级管理和饥饿问题的解决",
              "url": "#54-优先级管理和饥饿问题的解决",
              "items": []
            }
          ]
        },
        {
          "title": "6. 任务队列与React的协调过程",
          "url": "#6-任务队列与react的协调过程",
          "items": [
            {
              "title": "6.1 车道优先级（Lane Priority）的实际应用",
              "url": "#61-车道优先级lane-priority的实际应用",
              "items": []
            },
            {
              "title": "6.2 调度器优先级（Scheduler Priority）的实际应用",
              "url": "#62-调度器优先级scheduler-priority的实际应用",
              "items": []
            },
            {
              "title": "6.3 混合优先级",
              "url": "#63-混合优先级",
              "items": []
            },
            {
              "title": "6.4 在源码实现中",
              "url": "#64-在源码实现中",
              "items": []
            },
            {
              "title": "6.5 车道和优先级转换",
              "url": "#65-车道和优先级转换",
              "items": []
            }
          ]
        },
        {
          "title": "7. 任务队列与React并发模式",
          "url": "#7-任务队列与react并发模式",
          "items": [
            {
              "title": "7.1 并发本质",
              "url": "#71-并发本质",
              "items": []
            },
            {
              "title": "7.2 为什么这也算是\"并发\"？",
              "url": "#72-为什么这也算是并发",
              "items": []
            }
          ]
        },
        {
          "title": "8. 总结",
          "url": "#8-总结",
          "items": []
        }
      ],
      "visible": true
    },
    "slugAsParams": "2.create-task-queue"
  },
  {
    "slug": "/content/react-source-code/3.schedule",
    "title": "3.React调度核心原理（补）",
    "description": "深入探讨React的调度机制，解析其核心原理，并与requestIdleCallback API进行对比，揭示React如何实现高效的任务调度。",
    "published": true,
    "date": "2023-01-10T00:00:00.000Z",
    "body": "const{Fragment:l,jsx:n,jsxs:e}=arguments[0];function _createMdxContent(c){const r={a:\"a\",blockquote:\"blockquote\",code:\"code\",figure:\"figure\",h1:\"h1\",h2:\"h2\",h3:\"h3\",h4:\"h4\",img:\"img\",li:\"li\",ol:\"ol\",p:\"p\",pre:\"pre\",span:\"span\",strong:\"strong\",ul:\"ul\",...c.components};return e(l,{children:[e(r.h1,{id:\"react调度核心原理及其与requestidlecallback的关系\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#react调度核心原理及其与requestidlecallback的关系\",children:n(r.span,{className:\"icon icon-link\"})}),\"React调度核心原理及其与requestIdleCallback的关系\"]}),\"\\n\",e(r.p,{children:[\"在深入探讨 React 的 Fiber 架构之前，我们需要先了解 \",n(r.code,{children:\"requestIdleCallback\"}),' 这个 API。它允许我们在浏览器空闲时执行低优先级的任务，从而不影响高优先级任务的执行。这个 API 帮助我们理解\"空闲时间\"和\"让出主线程\"的概念。']}),\"\\n\",e(r.blockquote,{children:[\"\\n\",n(r.p,{children:\"25年1月31日穿越发言: 这文章我稍微修了一下，发现了个大问题就是只看这一段调度机制单独拿出来几乎是看不懂的，但不会大修了，而且现在react19了，它的调度机制加入了非常多的内容，可能在很长一段时间我也等着别人分析投喂我一下，有看到好的文章的小伙伴可以滴我一下。\"}),\"\\n\"]}),\"\\n\",e(r.h2,{id:\"1-requestidlecallback-简介\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#1-requestidlecallback-简介\",children:n(r.span,{className:\"icon icon-link\"})}),\"1. requestIdleCallback 简介\"]}),\"\\n\",e(r.p,{children:[n(r.strong,{children:\"空闲时间\"}),\"：页面渲染是以帧为单位的，流畅的页面通常保持 60 帧/秒，即每帧约 16ms。如果每帧的执行时间少于 16ms，剩余的时间就是空闲时间。\"]}),\"\\n\",e(r.p,{children:[n(r.strong,{children:\"API 介绍\"}),\"：\"]}),\"\\n\",n(r.p,{children:n(r.img,{src:\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7f056b718c9f485e92119ad1ea1666a5~tplv-k3u1fbpfcp-watermark.image?\",alt:\"requestIdleCallback API\"})}),\"\\n\",e(r.ul,{children:[\"\\n\",e(r.li,{children:[\"返回值 \",n(r.code,{children:\"2\"}),\" 是回调的 ID，可用于 \",n(r.code,{children:\"Window.cancelIdleCallback()\"}),\" 方法来取消回调。\"]}),\"\\n\",e(r.li,{children:[n(r.code,{children:\"didTimeout\"}),\" 是一个布尔值，当为 \",n(r.code,{children:\"true\"}),\" 时表示回调正在执行。\"]}),\"\\n\",e(r.li,{children:[n(r.code,{children:\"timeRemaining()\"}),\" 方法返回当前帧剩余的空闲时间。\"]}),\"\\n\"]}),\"\\n\",e(r.h2,{id:\"2-requestidlecallback-实战示例\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#2-requestidlecallback-实战示例\",children:n(r.span,{className:\"icon icon-link\"})}),\"2. requestIdleCallback 实战示例\"]}),\"\\n\",e(r.p,{children:[\"让我们通过两个对比示例来理解 \",n(r.code,{children:\"requestIdleCallback\"}),\" 的实际应用。\"]}),\"\\n\",e(r.h3,{id:\"21-不使用-requestidlecallback\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#21-不使用-requestidlecallback\",children:n(r.span,{className:\"icon icon-link\"})}),\"2.1 不使用 requestIdleCallback\"]}),\"\\n\",n(r.p,{children:\"在这个例子中，我们先模拟一个耗时的计算任务，同时尝试响应用户输入：\"}),\"\\n\",n(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" button\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"document\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"getElementById\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'button'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" input\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"document\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"getElementById\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'input'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" isPrimeNumber\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"button\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"addEventListener\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'click'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", () \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 模拟耗时计算\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  for\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"2\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"; \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"1000000000\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"; \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"++) {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"    isPrimeNumber\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    for\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" j\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"2\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"; \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"j\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"; \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"j\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"++) {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" % \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"j\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"        isPrimeNumber\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#54B9FF\"},children:\"        break\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"  console\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"log\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'计算完成'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"})\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"input\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"addEventListener\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'input'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", () \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"  console\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"log\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'输入值：'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"input\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"value\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"})\"})})]})})}),\"\\n\",n(r.p,{children:\"在这个例子中，当用户点击按钮时，会启动一个耗时的计算。在计算过程中，如果用户尝试在输入框中输入内容，会发现输入非常卡顿，甚至完全无响应，直到计算完成。\"}),\"\\n\",e(r.h3,{id:\"22-使用-requestidlecallback\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#22-使用-requestidlecallback\",children:n(r.span,{className:\"icon icon-link\"})}),\"2.2 使用 requestIdleCallback\"]}),\"\\n\",e(r.p,{children:[\"现在，让我们使用 \",n(r.code,{children:\"requestIdleCallback\"}),\" 来改进这个例子：\"]}),\"\\n\",n(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" button\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"document\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"getElementById\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'button'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" input\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"document\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"getElementById\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'input'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" isPrimeNumber\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"2\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"button\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"addEventListener\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'click'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", () \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  function\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\" doWork\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"deadline\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    while\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"1000000000\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"deadline\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"timeRemaining\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"() > \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"      isPrimeNumber\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"      for\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" j\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"2\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"; \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"j\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"; \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"j\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"++) {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"        if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" % \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"j\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"          isPrimeNumber\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#54B9FF\"},children:\"          break\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"        }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"      i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"++\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"1000000000\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"      requestIdleCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"doWork\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"      console\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"log\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'计算完成'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"  requestIdleCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"doWork\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"})\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"input\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"addEventListener\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'input'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", () \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"  console\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"log\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'输入值：'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"input\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"value\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"})\"})})]})})}),\"\\n\",e(r.p,{children:[\"在这个改进的版本中，我们将耗时的计算任务分割成多个小任务，并使用 \",n(r.code,{children:\"requestIdleCallback\"}),\" 在浏览器空闲时执行这些任务。这样，即使在进行大量计算的同时，用户仍然可以流畅地在输入框中输入内容，因为浏览器有机会在计算任务之间处理用户输入。\"]}),\"\\n\",e(r.p,{children:[\"这个例子更好地展示了 \",n(r.code,{children:\"requestIdleCallback\"}),\" 的核心优势：它允许我们在不阻塞主线程的情况下执行耗时的任务，从而提高应用的响应性和用户体验。\"]}),\"\\n\",e(r.p,{children:[\"通过这种方式，我们可以更清楚地看到 \",n(r.code,{children:\"requestIdleCallback\"}),\" 如何帮助我们在执行耗时任务的同时保持应用的响应性，这正是 React 在其调度系统中试图实现的目标。\"]}),\"\\n\",e(r.h2,{id:\"3-react-中的调度实现\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#3-react-中的调度实现\",children:n(r.span,{className:\"icon icon-link\"})}),\"3. React 中的调度实现\"]}),\"\\n\",e(r.p,{children:[\"虽然 \",n(r.code,{children:\"requestIdleCallback\"}),\" 展示了空闲时间和让出主线程的概念，但 React 实际上并不使用它来实现调度。关于 React 为什么不使用 \",n(r.code,{children:\"requestIdleCallback\"}),\"，可以参考\",n(r.a,{href:\"https://juejin.cn/post/7170095557443551246\",children:\"这篇文章\"}),\"。而完整的调度实现分为了两个部分。\"]}),\"\\n\",e(r.h3,{id:\"31-react-调度源码实现\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#31-react-调度源码实现\",children:n(r.span,{className:\"icon icon-link\"})}),\"3.1 React 调度源码实现\"]}),\"\\n\",e(r.p,{children:[\"React 使用 \",n(r.code,{children:\"MessageChannel\"}),\" 来实现消息的发送和接收，从而实现调度。这种实现可以分为两个核心部分：调度和时间切片。\"]}),\"\\n\",n(r.p,{children:n(r.img,{src:\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8378f03e4c04475391ddb76895a8b505~tplv-k3u1fbpfcp-zoom-1.image\",alt:\"React Scheduling Implementation\"})}),\"\\n\",n(r.p,{children:\"在我们开始之前先粗略的阅读这段源码：\"}),\"\\n\",n(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" scheduledHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" taskTimeoutID\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = -\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"1\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" yieldInterval\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"5\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" deadline\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"0\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// TODO: Make this configurable\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// TODO: Adjust this based on priority?\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" maxYieldInterval\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"300\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" needsPaint\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"  enableIsInputPending\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" &&\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"  navigator\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"undefined\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" &&\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"  navigator\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"scheduling\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"undefined\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" &&\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"  navigator\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"scheduling\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"isInputPending\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"undefined\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" scheduling\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"navigator\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"scheduling\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 17.02的源码这里比较简单，其实这都不用看直接看false,因为enableIsInputPending为false,就而且17.2里面isInputPending是不可以用的，我们直接看18把，然后我就发现18里面好像依然没解决这个问题\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"  shouldYieldToHost\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" () {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" currentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"getCurrentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" >= \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"deadline\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 简单的说就是长时间阻塞主线程的东西就给它打断了，绘制（交互）和用户输入之类的东西就给他打断了，都不是我们可以在最大延时里再看看\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"needsPaint\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" || \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"scheduling\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"isInputPending\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"()) {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"        // There is either a pending paint or a pending input.\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"        return\"}),n(r.span,{style:{color:\"#FFD493\"},children:\" true\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 300ms最大延时打断\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" currentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" >= \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"maxYieldInterval\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 不需要打断\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(r.span,{style:{color:\"#FFD493\"},children:\" false\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"  requestPaint\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" () {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"    needsPaint\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#EEF0F9\"},children:\"} \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 直接看这里这个deadline是在performWorkUntilDeadline执行任务的时候去设置的\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"  shouldYieldToHost\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" () {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\" getCurrentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"() >= \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"deadline\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // Since we yield every frame regardless, `requestPaint` has no effect.\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"  requestPaint\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" () {}\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 强制设置检测时间，源码没用到调试的时候可以设置,电脑越好，fps越高分片时间越短\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"forceFrameRate\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"fps\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"fps\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" || \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"fps\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" > \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"125\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // Using console['error'] to evade Babel and ESLint\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"    console\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'error'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"](\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#FFD493\"},children:\"      'forceFrameRate takes a positive int between 0 and 125, '\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" +\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#FFD493\"},children:\"        'forcing frame rates higher than 125 fps is not supported'\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"    )\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#54B9FF\"},children:\"    return\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"fps\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" > \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"    yieldInterval\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"Math\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"floor\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"1000\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" / \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"fps\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // reset the framerate\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"    yieldInterval\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"5\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\" performWorkUntilDeadline\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = () \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 有执行任务\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"scheduledHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" currentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"getCurrentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 计算一帧的打断检测时间\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"    deadline\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" + \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"yieldInterval\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" hasTimeRemaining\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    try\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 执行c回调\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" hasMoreWork\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"scheduledHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"hasTimeRemaining\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 执行完该回调后, 判断后续是否还有其他任务\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (!\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"hasMoreWork\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"        isMessageLoopRunning\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"        scheduledHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#EEF0F9\"},children:\"      } \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"        // 还有其他任务, 推进进入下一个宏任务队列中\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"        port\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"postMessage\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"catch\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"error\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // If a scheduler task throws, exit the current browser task so the\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // error can be observed.\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"      port\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"postMessage\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"      throw\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" error\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"    isMessageLoopRunning\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // Yielding to the browser will give it a chance to paint, so we can\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // reset this.\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 重置状态\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"  needsPaint\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" channel\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"new\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\" MessageChannel\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// port2 发送\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" port\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"channel\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"port2\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// port1 接收\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"channel\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"port1\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"onmessage\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"performWorkUntilDeadline\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 在每一帧中执行任务\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"requestHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"callback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 回调注册\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"  scheduledHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"callback\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (!\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"isMessageLoopRunning\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"    isMessageLoopRunning\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 进入宏任务队列\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"    port\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"postMessage\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 取消回调\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"cancelHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" () {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"  scheduledHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 设置超时回调\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"requestHostTimeout\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"callback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"ms\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"  taskTimeoutID\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"setTimeout\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(() \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"    callback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"getCurrentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"())\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#EEF0F9\"},children:\"  }, \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"ms\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 取消超时\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"cancelHostTimeout\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" () {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"  clearTimeout\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"taskTimeoutID\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"  taskTimeoutID\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = -\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"1\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(r.h4,{id:\"1-调度机制\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#1-调度机制\",children:n(r.span,{className:\"icon icon-link\"})}),\"1. 调度机制\"]}),\"\\n\",e(r.p,{children:[\"React 通过 \",n(r.code,{children:\"MessageChannel\"}),\" 建立通道，一个端口发送消息，另一个接收消息。主要代码如下：\"]}),\"\\n\",n(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" channel\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"new\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\" MessageChannel\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" port\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"channel\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"port2\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"channel\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"port1\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"onmessage\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"performWorkUntilDeadline\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"requestHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"callback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"  scheduledHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"callback\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (!\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"isMessageLoopRunning\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"    isMessageLoopRunning\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"    port\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"postMessage\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(r.p,{children:[\"这里，\",n(r.code,{children:\"performWorkUntilDeadline\"}),\" 函数在接收消息时被调用，它负责设置空闲时间 \",n(r.code,{children:\"deadline\"}),\" 并执行回调函数。\"]}),\"\\n\",e(r.h4,{id:\"2-时间切片\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#2-时间切片\",children:n(r.span,{className:\"icon icon-link\"})}),\"2. 时间切片\"]}),\"\\n\",e(r.p,{children:[\"React 通过 \",n(r.code,{children:\"shouldYieldToHost\"}),\" 函数根据 \",n(r.code,{children:\"deadline\"}),\" 决定是否中断构建，实现时间切片：\"]}),\"\\n\",n(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"shouldYieldToHost\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" () {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\" getCurrentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"() >= \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"deadline\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\" performWorkUntilDeadline\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = () \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"scheduledHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" currentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"getCurrentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"    deadline\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" + \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"yieldInterval\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" hasTimeRemaining\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    try\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" hasMoreWork\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"scheduledHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"hasTimeRemaining\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (!\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"hasMoreWork\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"        isMessageLoopRunning\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"        scheduledHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#EEF0F9\"},children:\"      } \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"        port\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"postMessage\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"catch\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"error\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"      port\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"postMessage\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"      throw\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" error\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"    isMessageLoopRunning\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"  needsPaint\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(r.p,{children:\"这种实现允许 React 在执行任务时能够及时响应用户交互，提高应用的性能和用户体验。\"}),\"\\n\",n(r.p,{children:\"通过这种方式，React 实现了高效的任务调度和时间切片，使得复杂的渲染过程能够被分割成小块，在不同的时间片段内执行，从而避免长时间阻塞主线程。\"}),\"\\n\",e(r.h3,{id:\"32-settimeout-降级实现\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#32-settimeout-降级实现\",children:n(r.span,{className:\"icon icon-link\"})}),\"3.2 setTimeout 降级实现\"]}),\"\\n\",e(r.p,{children:[\"React 的调度系统设计考虑了不同的运行环境，包括非浏览器环境。React使用了降级策略，使用 \",n(r.code,{children:\"setTimeout\"}),\" 来模拟类似的调度行为。\"]}),\"\\n\",n(r.p,{children:\"降级实现：\"}),\"\\n\",e(r.ol,{children:[\"\\n\",e(r.li,{children:[\"\\n\",e(r.p,{children:[n(r.strong,{children:\"环境检测\"}),\"：\\nReact 首先检查当前环境是否支持 \",n(r.code,{children:\"window\"}),\" 对象和 \",n(r.code,{children:\"MessageChannel\"}),\"。如果不支持，就会启用降级策略。\"]}),\"\\n\"]}),\"\\n\",e(r.li,{children:[\"\\n\",e(r.p,{children:[n(r.strong,{children:\"核心功能模拟\"}),\"：\"]}),\"\\n\",e(r.ul,{children:[\"\\n\",e(r.li,{children:[n(r.code,{children:\"_flushCallback\"}),\": 模拟了主要的调度逻辑，执行回调并处理异常。\"]}),\"\\n\",e(r.li,{children:[n(r.code,{children:\"requestHostCallback\"}),\": 安排回调的执行，防止重入。\"]}),\"\\n\",e(r.li,{children:[n(r.code,{children:\"cancelHostCallback\"}),\": 取消已安排的回调。\"]}),\"\\n\",e(r.li,{children:[n(r.code,{children:\"requestHostTimeout\"}),\" 和 \",n(r.code,{children:\"cancelHostTimeout\"}),\": 处理超时逻辑。\"]}),\"\\n\",e(r.li,{children:[n(r.code,{children:\"shouldYieldToHost\"}),\": 在降级模式下始终返回 \",n(r.code,{children:\"false\"}),\"，意味着任务不会主动让出控制权。\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  typeof\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" window\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'undefined'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" ||\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // Check if MessageChannel is supported, too.\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  typeof\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" MessageChannel\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'function'\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // If this accidentally gets imported in a non-browser environment, e.g. JavaScriptCore,\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // fallback to a naive implementation.\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" _callback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" _timeoutID\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\" _flushCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"_callback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"      try\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"        const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" currentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"getCurrentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"();\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"        const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" hasRemainingTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"true\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"        _callback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"hasRemainingTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"        _callback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#EEF0F9\"},children:\"      } \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"catch\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"e\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"        setTimeout\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"_flushCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"        throw\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" e\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  };\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"  requestHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"cb\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"_callback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // Protect against re-entrancy.\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"      setTimeout\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"requestHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"cb\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"      _callback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"cb\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"      setTimeout\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"_flushCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  };\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"  cancelHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"    _callback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  };\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"  requestHostTimeout\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"cb\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"ms\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"    _timeoutID\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"setTimeout\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"cb\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"ms\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  };\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"  cancelHostTimeout\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"    clearTimeout\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"_timeoutID\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  };\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"  shouldYieldToHost\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(r.span,{style:{color:\"#FFD493\"},children:\" false\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  };\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"  requestPaint\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"forceFrameRate\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"() {};\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#EEF0F9\"},children:\"} \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // Capture local references to native APIs, in case a polyfill overrides them.\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" setTimeout\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"window\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"setTimeout\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" clearTimeout\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"window\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"clearTimeout\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" console\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'undefined'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // TODO: Scheduler no longer requires these methods to be polyfilled. But\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // maybe we want to continue warning if they don't exist, to preserve the\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // option to rely on it in the future?\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" requestAnimationFrame\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"window\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"requestAnimationFrame\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" cancelAnimationFrame\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"window\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"cancelAnimationFrame\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" requestAnimationFrame\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'function'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // Using console['error'] to evade Babel and ESLint\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"      console\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'error'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"](\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#FFD493\"},children:'        \"This browser doesn\\'t support requestAnimationFrame. \"'}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" +\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#FFD493\"},children:\"          'Make sure that you load a '\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" +\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#FFD493\"},children:\"          'polyfill in older browsers. https://reactjs.org/link/react-polyfills'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"      );\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" cancelAnimationFrame\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'function'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // Using console['error'] to evade Babel and ESLint\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"      console\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'error'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"](\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#FFD493\"},children:'        \"This browser doesn\\'t support cancelAnimationFrame. \"'}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" +\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#FFD493\"},children:\"          'Make sure that you load a '\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" +\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#FFD493\"},children:\"          'polyfill in older browsers. https://reactjs.org/link/react-polyfills'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"      );\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})})]})})})]})}return{default:function(l={}){const{wrapper:e}=l.components||{};return e?n(e,{...l,children:n(_createMdxContent,{...l})}):_createMdxContent(l)}};",
    "toc": {
      "content": [
        {
          "title": "React调度核心原理及其与requestIdleCallback的关系",
          "url": "#react调度核心原理及其与requestidlecallback的关系",
          "items": [
            {
              "title": "1. requestIdleCallback 简介",
              "url": "#1-requestidlecallback-简介",
              "items": []
            },
            {
              "title": "2. requestIdleCallback 实战示例",
              "url": "#2-requestidlecallback-实战示例",
              "items": [
                {
                  "title": "2.1 不使用 requestIdleCallback",
                  "url": "#21-不使用-requestidlecallback",
                  "items": []
                },
                {
                  "title": "2.2 使用 requestIdleCallback",
                  "url": "#22-使用-requestidlecallback",
                  "items": []
                }
              ]
            },
            {
              "title": "3. React 中的调度实现",
              "url": "#3-react-中的调度实现",
              "items": [
                {
                  "title": "3.1 React 调度源码实现",
                  "url": "#31-react-调度源码实现",
                  "items": [
                    {
                      "title": "1. 调度机制",
                      "url": "#1-调度机制",
                      "items": []
                    },
                    {
                      "title": "2. 时间切片",
                      "url": "#2-时间切片",
                      "items": []
                    }
                  ]
                },
                {
                  "title": "3.2 setTimeout 降级实现",
                  "url": "#32-settimeout-降级实现",
                  "items": []
                }
              ]
            }
          ]
        }
      ],
      "visible": true
    },
    "slugAsParams": "3.schedule"
  },
  {
    "slug": "/content/react-source-code/4.fiber-structure",
    "title": "4. React Fiber链表结构深度解析",
    "description": "Fiber是React的核心架构，它使用链表结构来组织和管理组件树。",
    "published": true,
    "date": "2023-03-05T00:00:00.000Z",
    "body": "const{Fragment:l,jsx:n,jsxs:e}=arguments[0];function _createMdxContent(r){const c={a:\"a\",code:\"code\",figure:\"figure\",h1:\"h1\",h2:\"h2\",h3:\"h3\",li:\"li\",ol:\"ol\",p:\"p\",pre:\"pre\",span:\"span\",strong:\"strong\",ul:\"ul\",...r.components};return e(l,{children:[e(c.h1,{id:\"react-fiber链表结构深度解析\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#react-fiber链表结构深度解析\",children:n(c.span,{className:\"icon icon-link\"})}),\"React Fiber链表结构深度解析\"]}),\"\\n\",e(c.h2,{id:\"1-fiber结构深入剖析\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#1-fiber结构深入剖析\",children:n(c.span,{className:\"icon icon-link\"})}),\"1. Fiber结构深入剖析\"]}),\"\\n\",n(c.p,{children:\"Fiber是React的核心架构，它使用链表结构来组织和管理组件树。\"}),\"\\n\",e(c.h3,{id:\"11-fiber节点的结构\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#11-fiber节点的结构\",children:n(c.span,{className:\"icon icon-link\"})}),\"1.1 Fiber节点的结构\"]}),\"\\n\",n(c.p,{children:\"每个Fiber节点都是一个复杂的JavaScript对象，包含了组件的各种信息及其与其他节点的关系。以下是Fiber节点的详细结构：\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"{\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 标记组件类型\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  tag: \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"WorkTag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 唯一标识，用于优化更新过程\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  key: \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"string\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 组件的类型（函数组件、类组件等）\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  type: \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"any\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 对应的DOM节点或组件实例\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  stateNode: \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"any\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 链表结构\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  child: \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  sibling: \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 更新相关\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  pendingProps: \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"any\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  memoizedProps: \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"any\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  updateQueue: \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"UpdateQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"any\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"> | \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  memoizedState: \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"any\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 副作用相关\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  flags: \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Flags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  subtreeFlags: \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Flags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  deletions: \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Array\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"> | \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 调度优先级相关\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  lanes: \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  childLanes: \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 替身（用于并发模式）\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  alternate: \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 开发工具使用\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  _debugOwner\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"?:\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  _debugIsCurrentlyTiming\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"?:\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" boolean\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  _debugNeedsRemount\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"?:\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" boolean\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 其他属性...\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"它主要包含了组件的基本信息，还包括了更新、副作用和调度优先级等重要信息。\"}),\"\\n\",e(c.h3,{id:\"12-fiber的链表结构\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#12-fiber的链表结构\",children:n(c.span,{className:\"icon icon-link\"})}),\"1.2 Fiber的链表结构\"]}),\"\\n\",n(c.p,{children:\"Fiber树使用三个主要指针构建链表结构：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[n(c.code,{children:\"child\"}),\": 指向第一个子节点\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"sibling\"}),\": 指向下一个兄弟节点\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"return\"}),\": 指向父节点\"]}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"我们可以假设我们有以下的React组件结构：\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"App\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Header\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Main\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Article\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Sidebar\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  </\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Main\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Footer\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"</\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"App\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]})]})})}),\"\\n\",n(c.p,{children:\"这个结构可以用Fiber链表表示如下：\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" App\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'ClassComponent'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"App\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Header\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" Header\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'FunctionComponent'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Header\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Main\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"App\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" Main\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'FunctionComponent'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Main\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Article\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Footer\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"App\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" Article\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'FunctionComponent'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Article\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Sidebar\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Main\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" Sidebar\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'FunctionComponent'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Sidebar\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Main\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" Footer\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'FunctionComponent'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Footer\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"App\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"在这个例子中：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[n(c.code,{children:\"App\"}),\"的\",n(c.code,{children:\"child\"}),\"指向\",n(c.code,{children:\"Header\"}),\"，因为\",n(c.code,{children:\"Header\"}),\"是\",n(c.code,{children:\"App\"}),\"的第一个子节点。\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"Header\"}),\"的\",n(c.code,{children:\"sibling\"}),\"指向\",n(c.code,{children:\"Main\"}),\"，因为\",n(c.code,{children:\"Main\"}),\"是\",n(c.code,{children:\"Header\"}),\"的下一个兄弟节点。\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"Main\"}),\"的\",n(c.code,{children:\"child\"}),\"指向\",n(c.code,{children:\"Article\"}),\"，因为\",n(c.code,{children:\"Article\"}),\"是\",n(c.code,{children:\"Main\"}),\"的第一个子节点。\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"Article\"}),\"的\",n(c.code,{children:\"sibling\"}),\"指向\",n(c.code,{children:\"Sidebar\"}),\"，因为\",n(c.code,{children:\"Sidebar\"}),\"是\",n(c.code,{children:\"Article\"}),\"的下一个兄弟节点。\"]}),\"\\n\",e(c.li,{children:[\"所有节点的\",n(c.code,{children:\"return\"}),\"都指向它们的父节点。例如，\",n(c.code,{children:\"Header\"}),\"、\",n(c.code,{children:\"Main\"}),\"和\",n(c.code,{children:\"Footer\"}),\"的\",n(c.code,{children:\"return\"}),\"都指向\",n(c.code,{children:\"App\"}),\"。\"]}),\"\\n\"]}),\"\\n\",e(c.p,{children:[\"这种结构允许React在树中高效地向上、向下和横向移动，无论是在渲染过程中还是在进行更新时。例如，当React需要更新\",n(c.code,{children:\"Main\"}),\"组件时，它可以轻松地访问其子组件（通过\",n(c.code,{children:\"child\"}),\"指针）和兄弟组件（通过\",n(c.code,{children:\"sibling\"}),\"指针），同时也可以回到父组件（通过\",n(c.code,{children:\"return\"}),\"指针）。\"]}),\"\\n\",e(c.h2,{id:\"2-fiber树的构建和更新机制\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#2-fiber树的构建和更新机制\",children:n(c.span,{className:\"icon icon-link\"})}),\"2. Fiber树的构建和更新机制\"]}),\"\\n\",e(c.h3,{id:\"21-创建fiber节点的过程\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#21-创建fiber节点的过程\",children:n(c.span,{className:\"icon icon-link\"})}),\"2.1 创建Fiber节点的过程\"]}),\"\\n\",e(c.p,{children:[\"React使用\",n(c.code,{children:\"createFiberFromElement\"}),\"函数创建单个Fiber节点:\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" createFiberFromElement\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"mode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" owner\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"__DEV__\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    owner\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"_owner\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"key\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" pendingProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"props\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"createFiberFromTypeAndProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"pendingProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"owner\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"mode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"__DEV__\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"_debugSource\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"_source\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"_debugOwner\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"_owner\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" fiber\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:[\"这个函数创建了Fiber节点。它调用了\",n(c.code,{children:\"createFiberFromTypeAndProps\"}),\"来实际创建Fiber对象，这个函数会根据组件的类型（如函数组件、类组件、宿主组件等）创建不同的Fiber节点。\"]}),\"\\n\",e(c.h3,{id:\"22-构建fiber树的过程\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#22-构建fiber树的过程\",children:n(c.span,{className:\"icon icon-link\"})}),\"2.2 构建Fiber树的过程\"]}),\"\\n\",e(c.p,{children:[n(c.code,{children:\"reconcileChildFibers\"}),\"函数是构建和更新Fiber树的核心:\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" reconcileChildFibers\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"currentFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 处理不同类型的子节点（单个元素、数组等）\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'object'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    switch\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"$$typeof\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      case\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" REACT_ELEMENT_TYPE\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        return\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" placeSingleChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"reconcileSingleElement\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"))\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      case\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" REACT_PORTAL_TYPE\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        return\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" placeSingleChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"reconcileSinglePortal\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"))\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      case\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" REACT_LAZY_TYPE\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" payload\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"_payload\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" init\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"_init\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        return\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" reconcileChildFibers\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"init\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"payload\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"), \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"isArray\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" reconcileChildrenArray\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"getIteratorFn\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" reconcileChildrenIterator\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 处理文本节点\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'string'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" || \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'number'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" placeSingleChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"reconcileSingleTextNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"''\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" + \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"))\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 处理其他情况（如null，undefined等）\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" deleteRemainingChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个函数主要是处理不同类型的子节点，包括单个元素、数组、迭代器、文本节点等。\"}),\"\\n\",e(c.h3,{id:\"23-链接fiber节点的详细过程\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#23-链接fiber节点的详细过程\",children:n(c.span,{className:\"icon icon-link\"})}),\"2.3 链接Fiber节点的详细过程\"]}),\"\\n\",e(c.p,{children:[\"在构建过程中，React通过设置\",n(c.code,{children:\"child\"}),\"、\",n(c.code,{children:\"sibling\"}),\"和\",n(c.code,{children:\"return\"}),\"属性来链接Fiber节点。\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" appendAllChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"parent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"HostComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" || \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"HostText\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      appendInitialChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"parent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"stateNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"stateNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"HostPortal\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 不要遍历到portal的子节点\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      continue\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" || \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"        return\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"return\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"return\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sibling\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个函数展示了React如何深度优先遍历Fiber树，并在过程中建立正确的父子和兄弟关系。它还处理了特殊情况，如portal组件。\"}),\"\\n\",e(c.h3,{id:\"24-实际例子\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#24-实际例子\",children:n(c.span,{className:\"icon icon-link\"})}),\"2.4 实际例子\"]}),\"\\n\",n(c.p,{children:\"让我们以一个简单的React组件树为例:\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" App\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Header\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Main\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"        <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Article\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"        <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Sidebar\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      </\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Main\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Footer\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    </\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  )\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:[\"现在,我们来看看React如何使用\",n(c.code,{children:\"reconcileChildFibers\"}),\"函数来构建这个组件树的Fiber结构:\"]}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[\"首先,React会为\",n(c.code,{children:\"App\"}),\"组件创建一个Fiber节点。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[\"然后,React会调用\",n(c.code,{children:\"reconcileChildFibers\"}),\"来处理\",n(c.code,{children:\"App\"}),\"的子元素(即\",n(c.code,{children:\"div\"}),\"):\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"reconcileChildFibers\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"appFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">...</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">, \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]})})})}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[\"在\",n(c.code,{children:\"reconcileChildFibers\"}),\"中,React会识别出这是一个\",n(c.code,{children:\"REACT_ELEMENT_TYPE\"}),\",然后调用\",n(c.code,{children:\"reconcileSingleElement\"}),\":\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"case\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" REACT_ELEMENT_TYPE:\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" placeSingleChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"reconcileSingleElement\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"))\"})]})]})})}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.code,{children:\"reconcileSingleElement\"}),\"会创建一个新的Fiber节点表示\",n(c.code,{children:\"div\"}),\",并将其设置为\",n(c.code,{children:\"App\"}),\" Fiber的child。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[\"接下来,React会再次调用\",n(c.code,{children:\"reconcileChildFibers\"}),\"来处理\",n(c.code,{children:\"div\"}),\"的子元素:\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"reconcileChildFibers\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"divFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", [<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Header\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />, <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Main\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">...</\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Main\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">, <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Footer\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />], \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]})})})}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[\"这次,因为子元素是一个数组,React会进入\",n(c.code,{children:\"isArray(newChild)\"}),\"的分支:\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"isArray\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" reconcileChildrenArray\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[\"在\",n(c.code,{children:\"reconcileChildrenArray\"}),\"中,React会为\",n(c.code,{children:\"Header\"}),\"、\",n(c.code,{children:\"Main\"}),\"和\",n(c.code,{children:\"Footer\"}),\"各创建一个Fiber节点,并将它们链接起来形成一个兄弟链表。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[\"对于\",n(c.code,{children:\"Main\"}),\"组件,React会再次调用\",n(c.code,{children:\"reconcileChildFibers\"}),\"来处理其子元素:\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"reconcileChildFibers\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"mainFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", [<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Article\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />, <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Sidebar\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />], \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]})})})}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[\"同样,这会创建\",n(c.code,{children:\"Article\"}),\"和\",n(c.code,{children:\"Sidebar\"}),\"的Fiber节点,并将它们链接为兄弟节点。\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"通过这个过程,React最终会构建出如下的Fiber树结构:\"}),\"\\n\",n(c.pre,{children:n(c.code,{children:\"App\\n |\\n +-- div\\n      |\\n      +-- Header\\n      |\\n      +-- Main\\n      |    |\\n      |    +-- Article\\n      |    |\\n      |    +-- Sidebar\\n      |\\n      +-- Footer\\n\"})}),\"\\n\",n(c.p,{children:\"在这个结构中:\"}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"每个节点都是一个Fiber对象\"}),\"\\n\",e(c.li,{children:[\"父子关系通过\",n(c.code,{children:\"child\"}),\"和\",n(c.code,{children:\"return\"}),\"指针维护\"]}),\"\\n\",e(c.li,{children:[\"兄弟关系通过\",n(c.code,{children:\"sibling\"}),\"指针维护\"]}),\"\\n\"]}),\"\\n\",e(c.h2,{id:\"3-fiber链表查找\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#3-fiber链表查找\",children:n(c.span,{className:\"icon icon-link\"})}),\"3. Fiber链表查找\"]}),\"\\n\",n(c.p,{children:\"这一节主要讲链表查找，然后我思考了一下时间复杂度和传统树算法差不多，但空间复杂度大大减小了且对于gc回收的话只需要断裂链表。\"}),\"\\n\",n(c.p,{children:\"然后另外一个考虑应该就是，链表结构使得遍历可以在任意点暂停和恢复，这其实是React实现时间切片的基础。\"}),\"\\n\",e(c.h3,{id:\"31-向下查找特定类型的子节点\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#31-向下查找特定类型的子节点\",children:n(c.span,{className:\"icon icon-link\"})}),\"3.1 向下查找特定类型的子节点\"]}),\"\\n\",n(c.p,{children:\"有时我们需要查找特定类型的子节点，例如查找第一个类组件：\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" findFirstClassComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"ClassComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" child\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"HostComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" || \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"HostText\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 跳过宿主组件\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sibling\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 继续向下查找\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" result\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"findFirstClassComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"result\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" result\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sibling\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" null\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.h3,{id:\"32-向上查找特定条件的祖先节点\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#32-向上查找特定条件的祖先节点\",children:n(c.span,{className:\"icon icon-link\"})}),\"3.2 向上查找特定条件的祖先节点\"]}),\"\\n\",n(c.p,{children:\"在某些情况下，我们需要向上查找满足特定条件的祖先节点，例如查找最近的Provider组件：\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" findNearestProvider\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"contextType\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"return\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Provider\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"_context\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"contextType\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" current\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"return\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" null\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.h3,{id:\"33-复杂的树遍历操作\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#33-复杂的树遍历操作\",children:n(c.span,{className:\"icon icon-link\"})}),\"3.3 复杂的树遍历操作\"]}),\"\\n\",n(c.p,{children:\"有时我们需要进行更复杂的树遍历操作，例如同时向上和向下查找：\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" findNodeBetween\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"start\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"end\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"predicate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"start\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"end\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"predicate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" current\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"end\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"          current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sibling\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"          break\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"        }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"return\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" null\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.h2,{id:\"4-实际意义\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#4-实际意义\",children:n(c.span,{className:\"icon icon-link\"})}),\"4. 实际意义\"]}),\"\\n\",n(c.p,{children:\"理解fiber的结构能帮助我们去理解上层组件结构、避免嵌套、以及思考怎样的组件设计是最优解的性能这种问题，而不是漫无目的的有组件就套就写就好了。\"}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"示例 1：深度嵌套的结构\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" DeeplyNestedPage\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = () \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Header\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Navigation\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"        <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"NavItem\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Home</\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"NavItem\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"        <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"NavItem\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">About</\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"NavItem\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"        <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"NavItem\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Contact</\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"NavItem\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      </\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Navigation\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    </\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Header\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Content\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Sidebar\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"        <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"SidebarItem\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Item 1</\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"SidebarItem\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"        <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"SidebarItem\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Item 2</\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"SidebarItem\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      </\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Sidebar\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"MainContent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"        <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Article\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"          <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Title\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Welcome</\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Title\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"          <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Paragraph\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">This is the main content.</\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Paragraph\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"        </\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Article\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      </\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"MainContent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    </\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Content\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Footer\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Copyright\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">© 2023</\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Copyright\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    </\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Footer\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  </\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})})]})})}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"示例 2：扁平化的结构\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" FlatPage\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = () \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Header\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Navigation\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"NavItem\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Home</\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"NavItem\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"NavItem\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">About</\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"NavItem\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"NavItem\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Contact</\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"NavItem\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Content\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Sidebar\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"SidebarItem\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Item 1</\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"SidebarItem\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"SidebarItem\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Item 2</\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"SidebarItem\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"MainContent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Article\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Title\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Welcome</\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Title\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Paragraph\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">This is the main content.</\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Paragraph\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Footer\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Copyright\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">© 2023</\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Copyright\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  </\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})})]})})}),\"\\n\",n(c.p,{children:\"这两个例子最终都能达成相同的功能，但实现结构是不同的，我们可以分析一下这两种结构对 Fiber 树和性能的影响：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"Fiber 树的深度\"}),\"：\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"深度嵌套的结构会创建一个更深的 Fiber 树。每一层嵌套都会在 Fiber 树中增加一个层级。\"}),\"\\n\",n(c.li,{children:\"扁平化的结构创建的 Fiber 树更浅，大多数组件都是直接的子组件。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"更新效率\"}),\"：\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[\"在深度嵌套的结构中，如果顶层组件（如 \",n(c.code,{children:\"Header\"}),\"）发生变化，React 需要遍历更多的 Fiber 节点来确定需要更新的内容。\"]}),\"\\n\",n(c.li,{children:\"扁平化的结构使得 React 可以更快地定位到需要更新的组件，因为它们大多处于同一层级。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"组件复用和状态管理\"}),\"：\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[\"深度嵌套的结构其实经常会导致不必要的组件重渲染。例如，如果 \",n(c.code,{children:\"Content\"}),\" 组件的状态改变，它可能会导致 \",n(c.code,{children:\"Sidebar\"}),\" 和 \",n(c.code,{children:\"MainContent\"}),\" 都重新渲染。\"]}),\"\\n\",n(c.li,{children:\"而扁平化的结构允许更精确的控制哪些组件需要重新渲染。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"代码可维护性\"}),\"：\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"显然扁平化的结构通常更容易维护和重构，因为组件之间的依赖关系更清晰。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"性能优化空间\"}),\"：\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"扁平化的结构也更好优化。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\"]})]})}return{default:function(l={}){const{wrapper:e}=l.components||{};return e?n(e,{...l,children:n(_createMdxContent,{...l})}):_createMdxContent(l)}};",
    "toc": {
      "content": [
        {
          "title": "React Fiber链表结构深度解析",
          "url": "#react-fiber链表结构深度解析",
          "items": [
            {
              "title": "1. Fiber结构深入剖析",
              "url": "#1-fiber结构深入剖析",
              "items": [
                {
                  "title": "1.1 Fiber节点的结构",
                  "url": "#11-fiber节点的结构",
                  "items": []
                },
                {
                  "title": "1.2 Fiber的链表结构",
                  "url": "#12-fiber的链表结构",
                  "items": []
                }
              ]
            },
            {
              "title": "2. Fiber树的构建和更新机制",
              "url": "#2-fiber树的构建和更新机制",
              "items": [
                {
                  "title": "2.1 创建Fiber节点的过程",
                  "url": "#21-创建fiber节点的过程",
                  "items": []
                },
                {
                  "title": "2.2 构建Fiber树的过程",
                  "url": "#22-构建fiber树的过程",
                  "items": []
                },
                {
                  "title": "2.3 链接Fiber节点的详细过程",
                  "url": "#23-链接fiber节点的详细过程",
                  "items": []
                },
                {
                  "title": "2.4 实际例子",
                  "url": "#24-实际例子",
                  "items": []
                }
              ]
            },
            {
              "title": "3. Fiber链表查找",
              "url": "#3-fiber链表查找",
              "items": [
                {
                  "title": "3.1 向下查找特定类型的子节点",
                  "url": "#31-向下查找特定类型的子节点",
                  "items": []
                },
                {
                  "title": "3.2 向上查找特定条件的祖先节点",
                  "url": "#32-向上查找特定条件的祖先节点",
                  "items": []
                },
                {
                  "title": "3.3 复杂的树遍历操作",
                  "url": "#33-复杂的树遍历操作",
                  "items": []
                }
              ]
            },
            {
              "title": "4. 实际意义",
              "url": "#4-实际意义",
              "items": []
            }
          ]
        }
      ],
      "visible": true
    },
    "slugAsParams": "4.fiber-structure"
  },
  {
    "slug": "/content/react-source-code/5.fiber-commit",
    "title": "5.React Fiber对象的创建与更新",
    "description": "深入探讨React Fiber架构中Fiber对象的创建过程、初始化提交以及Fiber树的更新机制,揭示React内部工作原理。",
    "published": true,
    "date": "2023-03-09T00:00:00.000Z",
    "body": "const{Fragment:l,jsx:e,jsxs:n}=arguments[0];function _createMdxContent(r){const c={a:\"a\",code:\"code\",figure:\"figure\",h1:\"h1\",h2:\"h2\",h3:\"h3\",li:\"li\",ol:\"ol\",p:\"p\",pre:\"pre\",span:\"span\",...r.components};return n(l,{children:[n(c.h1,{id:\"react-fiber对象的创建与更新机制\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#react-fiber对象的创建与更新机制\",children:e(c.span,{className:\"icon icon-link\"})}),\"React Fiber对象的创建与更新机制\"]}),\"\\n\",n(c.p,{children:[\"在上一篇文章中，我们详细讨论了Fiber的整体结构和链表。本文将深入探讨Fiber对象的创建过程、初始化提交以及Fiber树的更新机制。本节\",e(c.code,{children:\"react\"}),\"版本18.3（新写的文章就不用看老版本了一样的）。\"]}),\"\\n\",n(c.h2,{id:\"1-创建fiber对象\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#1-创建fiber对象\",children:e(c.span,{className:\"icon icon-link\"})}),\"1. 创建Fiber对象\"]}),\"\\n\",n(c.p,{children:[\"Fiber对象的创建是React渲染过程的起点。当我们调用\",e(c.code,{children:\"ReactDOM.createRoot().render()\"}),\"时，React开始创建Fiber树。\"]}),\"\\n\",n(c.h3,{id:\"11-创建rootfiber\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#11-创建rootfiber\",children:e(c.span,{className:\"icon icon-link\"})}),\"1.1 创建RootFiber\"]}),\"\\n\",e(c.p,{children:\"首先，React会创建一个RootFiber，它是整个Fiber树的根节点。\"}),\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\" createFiberRoot\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"containerInfo\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"tag\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"hydrate\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"hydrationCallbacks\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" root\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#54B9FF\"},children:\"new\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\" FiberRootNode\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"containerInfo\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"tag\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"hydrate\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" uninitializedFiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"createHostRootFiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"tag\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  root\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"uninitializedFiber\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  uninitializedFiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"stateNode\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#00DAEF\"},children:\"  initializeUpdateQueue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"uninitializedFiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\" root\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:\"这个函数创建了FiberRoot和RootFiber。FiberRoot是整个应用的起点，而RootFiber则是组件树的根节点。\"}),\"\\n\",n(c.h3,{id:\"12-创建子fiber节点\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#12-创建子fiber节点\",children:e(c.span,{className:\"icon icon-link\"})}),\"1.2 创建子Fiber节点\"]}),\"\\n\",n(c.p,{children:[\"接下来，React会根据组件树递归地创建子Fiber节点。这个过程发生在\",e(c.code,{children:\"reconcileChildren\"}),\"函数中：\"]}),\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\" reconcileChildren\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"current\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"workInProgress\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"nextChildren\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"renderLanes\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"mountChildFibers\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"nextChildren\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"renderLanes\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),e(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"reconcileChildFibers\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"nextChildren\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"renderLanes\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:[e(c.code,{children:\"mountChildFibers\"}),\"和\",e(c.code,{children:\"reconcileChildFibers\"}),\"都是\",e(c.code,{children:\"ChildReconciler\"}),\"函数的返回值，它们的区别在于是否标记副作用。\"]}),\"\\n\",n(c.h3,{id:\"13-创建单个fiber节点\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#13-创建单个fiber节点\",children:e(c.span,{className:\"icon icon-link\"})}),\"1.3 创建单个Fiber节点\"]}),\"\\n\",n(c.p,{children:[\"创建单个Fiber节点的核心逻辑在\",e(c.code,{children:\"createFiberFromElement\"}),\"函数中：\"]}),\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\" createFiberFromElement\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"element\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"mode\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"lanes\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\" owner\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" type\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),e(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\" // 获取元素类型（如 'div', 自定义组件等）\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" key\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"key\"}),e(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\" // 获取元素的 key\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" pendingProps\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"props\"}),e(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\" // 获取元素的 props\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" fiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"createFiberFromTypeAndProps\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"key\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"pendingProps\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"owner\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"mode\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\" fiber\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:\"这个函数根据React元素的类型、key和props创建对应的Fiber节点。\"}),\"\\n\",n(c.h2,{id:\"2-初始化提交\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#2-初始化提交\",children:e(c.span,{className:\"icon icon-link\"})}),\"2. 初始化提交\"]}),\"\\n\",e(c.p,{children:'创建完Fiber树后，React需要将这些虚拟的Fiber节点渲染到实际的DOM中。这个过程称为\"提交\"(commit)。'}),\"\\n\",n(c.h3,{id:\"21-提交前的准备\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#21-提交前的准备\",children:e(c.span,{className:\"icon icon-link\"})}),\"2.1 提交前的准备\"]}),\"\\n\",e(c.p,{children:\"在进入提交阶段之前，React会做一些准备工作：\"}),\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\" commitRoot\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"root\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" renderPriorityLevel\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"getCurrentPriorityLevel\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#00DAEF\"},children:\"  runWithPriority\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"ImmediatePriority\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"commitRootImpl\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"bind\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"renderPriorityLevel\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"))\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),e(c.span,{style:{color:\"#FFD493\"},children:\" null\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:[\"这里，React将提交过程的优先级设置为最高(\",e(c.code,{children:\"ImmediatePriority\"}),\")，确保提交过程不会被打断。\"]}),\"\\n\",n(c.h3,{id:\"22-提交阶段\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#22-提交阶段\",children:e(c.span,{className:\"icon icon-link\"})}),\"2.2 提交阶段\"]}),\"\\n\",e(c.p,{children:\"提交阶段分为三个子阶段：Before mutation、Mutation和Layout。\"}),\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\" commitRootImpl\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"root\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"renderPriorityLevel\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // Before mutation阶段\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#00DAEF\"},children:\"  commitBeforeMutationEffects\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"renderPriorityLevel\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // Mutation阶段\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#00DAEF\"},children:\"  commitMutationEffects\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"renderPriorityLevel\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // Layout阶段\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  root\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"finishedWork\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#00DAEF\"},children:\"  commitLayoutEffects\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#00DAEF\"},children:\"  requestPaint\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),e(c.span,{style:{color:\"#FFD493\"},children:\" null\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:\"每个阶段都有特定的任务：\"}),\"\\n\",n(c.ol,{children:[\"\\n\",e(c.li,{children:\"Before mutation阶段：处理DOM操作前的准备工作，如调用getSnapshotBeforeUpdate生命周期方法。\"}),\"\\n\",e(c.li,{children:\"Mutation阶段：执行实际的DOM操作。\"}),\"\\n\",e(c.li,{children:\"Layout阶段：处理DOM操作后的工作，如调用componentDidUpdate生命周期方法。\"}),\"\\n\"]}),\"\\n\",n(c.h2,{id:\"3-fiber树的更新\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#3-fiber树的更新\",children:e(c.span,{className:\"icon icon-link\"})}),\"3. Fiber树的更新\"]}),\"\\n\",e(c.p,{children:\"当组件的状态发生变化时，React需要更新Fiber树并重新渲染。\"}),\"\\n\",n(c.h3,{id:\"31-调度更新\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#31-调度更新\",children:e(c.span,{className:\"icon icon-link\"})}),\"3.1 调度更新\"]}),\"\\n\",n(c.p,{children:[\"当我们调用\",e(c.code,{children:\"setState\"}),\"或使用Hooks时，React会创建一个更新并将其加入更新队列：\"]}),\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\" enqueueUpdate\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"fiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" updateQueue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"fiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"updateQueue\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" sharedQueue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"updateQueue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"shared\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" pending\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"sharedQueue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"pending\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"pending\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"update\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),e(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"pending\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    pending\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"update\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  sharedQueue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"pending\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"update\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.h3,{id:\"32-开始工作循环\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#32-开始工作循环\",children:e(c.span,{className:\"icon icon-link\"})}),\"3.2 开始工作循环\"]}),\"\\n\",e(c.p,{children:\"React使用工作循环来处理更新：\"}),\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\" workLoopConcurrent\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" && !\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"shouldYield\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"()) {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#00DAEF\"},children:\"    performUnitOfWork\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:\"这个循环会不断地处理工作单元，直到完成所有工作或需要让出控制权。\"}),\"\\n\",n(c.h3,{id:\"33-对比和更新\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#33-对比和更新\",children:e(c.span,{className:\"icon icon-link\"})}),\"3.3 对比和更新\"]}),\"\\n\",e(c.p,{children:\"在更新过程中，React会对比新旧Fiber树，找出需要更新的部分：\"}),\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\" reconcileChildFibers\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"returnFiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"currentFirstChild\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"newChild\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"lanes\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\" newChild\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"'object'\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"    switch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"$$typeof\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"      case\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" REACT_ELEMENT_TYPE\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"        return\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\" placeSingleChild\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"reconcileSingleElement\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"currentFirstChild\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"))\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 处理其他类型...\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 处理文本节点和其他情况...\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:\"这个过程会创建、更新或删除Fiber节点，最终形成一个新的Fiber树。\"})]})}return{default:function(l={}){const{wrapper:n}=l.components||{};return n?e(n,{...l,children:e(_createMdxContent,{...l})}):_createMdxContent(l)}};",
    "toc": {
      "content": [
        {
          "title": "React Fiber对象的创建与更新机制",
          "url": "#react-fiber对象的创建与更新机制",
          "items": [
            {
              "title": "1. 创建Fiber对象",
              "url": "#1-创建fiber对象",
              "items": [
                {
                  "title": "1.1 创建RootFiber",
                  "url": "#11-创建rootfiber",
                  "items": []
                },
                {
                  "title": "1.2 创建子Fiber节点",
                  "url": "#12-创建子fiber节点",
                  "items": []
                },
                {
                  "title": "1.3 创建单个Fiber节点",
                  "url": "#13-创建单个fiber节点",
                  "items": []
                }
              ]
            },
            {
              "title": "2. 初始化提交",
              "url": "#2-初始化提交",
              "items": [
                {
                  "title": "2.1 提交前的准备",
                  "url": "#21-提交前的准备",
                  "items": []
                },
                {
                  "title": "2.2 提交阶段",
                  "url": "#22-提交阶段",
                  "items": []
                }
              ]
            },
            {
              "title": "3. Fiber树的更新",
              "url": "#3-fiber树的更新",
              "items": [
                {
                  "title": "3.1 调度更新",
                  "url": "#31-调度更新",
                  "items": []
                },
                {
                  "title": "3.2 开始工作循环",
                  "url": "#32-开始工作循环",
                  "items": []
                },
                {
                  "title": "3.3 对比和更新",
                  "url": "#33-对比和更新",
                  "items": []
                }
              ]
            }
          ]
        }
      ],
      "visible": true
    },
    "slugAsParams": "5.fiber-commit"
  }
]