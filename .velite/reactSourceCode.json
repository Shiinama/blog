[
  {
    "slug": "/content/react-source-code/1.why-use-firber",
    "title": "1. React Fiber架构：初识Fiber",
    "description": "探讨React的Fiber架构，解析其核心原理，揭示如何实现高效的任务调度，以及对React性能的提升。",
    "published": true,
    "date": "2022-11-20T00:00:00.000Z",
    "body": "const{Fragment:i,jsx:n,jsxs:e}=arguments[0];function _createMdxContent(c){const l={a:\"a\",h1:\"h1\",h2:\"h2\",h3:\"h3\",li:\"li\",ol:\"ol\",p:\"p\",span:\"span\",ul:\"ul\",...c.components};return e(i,{children:[e(l.h1,{id:\"1-react-fiber架构初识fiber\",children:[n(l.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#1-react-fiber架构初识fiber\",children:n(l.span,{className:\"icon icon-link\"})}),\"1. React Fiber架构：初识Fiber\"]}),\"\\n\",n(l.p,{children:\"React Fiber 是 React 16 中引入的一种新的协调引擎或重新实现核心算法的方式。它的主要目标是解决 JavaScript 单线程执行模型带来的限制，通过实现时间切片（Time Slicing）来提高 React 应用的响应性和性能。\"}),\"\\n\",e(l.h2,{id:\"2-fiber-的核心问题单线程的局限性\",children:[n(l.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#2-fiber-的核心问题单线程的局限性\",children:n(l.span,{className:\"icon icon-link\"})}),\"2. Fiber 的核心问题：单线程的局限性\"]}),\"\\n\",n(l.p,{children:\"JavaScript 是单线程的，这意味着它一次只能执行一个任务。在 React 应用中，当需要渲染大量组件或处理复杂的状态更新时，这种单线程模型导致以下问题：\"}),\"\\n\",e(l.ol,{children:[\"\\n\",n(l.li,{children:\"长时间任务阻塞：大量的计算可能会阻塞主线程，导致用户交互、动画等其他任务无法及时响应。\"}),\"\\n\",n(l.li,{children:\"无法中断和恢复：一旦开始渲染过程，就必须完成整个过程，无法中途暂停或放弃。\"}),\"\\n\",n(l.li,{children:\"缺乏优先级概念：所有更新任务被视为同等重要，无法优先处理更紧急的更新。\"}),\"\\n\"]}),\"\\n\",e(l.h2,{id:\"3-fiber-的解决方案时间切片和新的协调算法\",children:[n(l.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#3-fiber-的解决方案时间切片和新的协调算法\",children:n(l.span,{className:\"icon icon-link\"})}),\"3. Fiber 的解决方案：时间切片和新的协调算法\"]}),\"\\n\",n(l.p,{children:\"Fiber 架构通过以下两个核心概念来解决单线程的局限性：\"}),\"\\n\",e(l.h3,{id:\"21-时间切片time-slicing\",children:[n(l.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#21-时间切片time-slicing\",children:n(l.span,{className:\"icon icon-link\"})}),\"2.1 时间切片（Time Slicing）\"]}),\"\\n\",n(l.p,{children:\"时间切片允许 React 将渲染工作分解成小的工作单元，并将这些工作单元分散到多个帧中执行。这意味着：\"}),\"\\n\",e(l.ul,{children:[\"\\n\",n(l.li,{children:\"React 可以在每一帧中执行一小部分工作。\"}),\"\\n\",n(l.li,{children:\"在两个工作单元之间，React 可以让出控制权给浏览器，允许浏览器处理用户输入、运行动画等高优先级的任务。\"}),\"\\n\",n(l.li,{children:\"如果有更高优先级的工作需要执行，React 可以中断当前的渲染过程，先处理紧急任务。\"}),\"\\n\"]}),\"\\n\",e(l.h3,{id:\"22-新的协调算法\",children:[n(l.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#22-新的协调算法\",children:n(l.span,{className:\"icon icon-link\"})}),\"2.2 新的协调算法\"]}),\"\\n\",n(l.p,{children:\"Fiber 引入了一个新的协调算法，它具有以下特点：\"}),\"\\n\",e(l.ul,{children:[\"\\n\",n(l.li,{children:\"可中断和恢复：渲染过程可以被中断和稍后恢复，而不会丢失状态。\"}),\"\\n\",n(l.li,{children:\"优先级调度：不同的更新可以被赋予不同的优先级，允许 React 首先处理最紧急的更新。\"}),\"\\n\",n(l.li,{children:\"错误边界改进：提供了更强大和一致的错误处理机制。\"}),\"\\n\"]}),\"\\n\",e(l.h2,{id:\"4-fiber-的工作原理\",children:[n(l.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#4-fiber-的工作原理\",children:n(l.span,{className:\"icon icon-link\"})}),\"4. Fiber 的工作原理\"]}),\"\\n\",n(l.p,{children:\"Fiber 架构的工作原理可以概括为以下几个关键点：\"}),\"\\n\",e(l.h3,{id:\"41-fiber-节点和-fiber-树\",children:[n(l.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#41-fiber-节点和-fiber-树\",children:n(l.span,{className:\"icon icon-link\"})}),\"4.1 Fiber 节点和 Fiber 树\"]}),\"\\n\",e(l.ul,{children:[\"\\n\",n(l.li,{children:\"每个 React 元素都对应一个 Fiber 节点。\"}),\"\\n\",n(l.li,{children:\"Fiber 节点构成了一个树状结构，称为 Fiber 树。\"}),\"\\n\",n(l.li,{children:\"每个 Fiber 节点包含了组件的状态、props、需要执行的工作等信息。\"}),\"\\n\"]}),\"\\n\",e(l.h3,{id:\"42-工作循环和优先级\",children:[n(l.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#42-工作循环和优先级\",children:n(l.span,{className:\"icon icon-link\"})}),\"4.2 工作循环和优先级\"]}),\"\\n\",e(l.ul,{children:[\"\\n\",n(l.li,{children:\"React 使用一个工作循环（work loop）来遍历 Fiber 树。\"}),\"\\n\",n(l.li,{children:\"在每一帧中，React 会检查是否还有时间继续执行工作。\"}),\"\\n\",n(l.li,{children:\"如果没有足够的时间，React 会暂停当前工作，将控制权交还给浏览器。\"}),\"\\n\",n(l.li,{children:\"工作会被赋予不同的优先级，React 会优先处理高优先级的工作。\"}),\"\\n\"]}),\"\\n\",e(l.h3,{id:\"43-两个主要阶段\",children:[n(l.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#43-两个主要阶段\",children:n(l.span,{className:\"icon icon-link\"})}),\"4.3 两个主要阶段\"]}),\"\\n\",n(l.p,{children:\"Fiber 的工作过程分为两个主要阶段：\"}),\"\\n\",e(l.ol,{children:[\"\\n\",e(l.li,{children:[\"Render 阶段（可中断）：\",\"\\n\",e(l.ul,{children:[\"\\n\",n(l.li,{children:\"构建或更新 Fiber 树\"}),\"\\n\",n(l.li,{children:\"执行协调（Reconciliation）过程\"}),\"\\n\",n(l.li,{children:\"收集需要执行的副作用（Effect List）\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(l.li,{children:[\"Commit 阶段（不可中断）：\",\"\\n\",e(l.ul,{children:[\"\\n\",n(l.li,{children:\"根据 Effect List 更新 DOM\"}),\"\\n\",n(l.li,{children:\"调用生命周期方法和 hooks\"}),\"\\n\",n(l.li,{children:\"处理 ref 等\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(l.h2,{id:\"5-fiber的学习路线\",children:[n(l.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#5-fiber的学习路线\",children:n(l.span,{className:\"icon icon-link\"})}),\"5. Fiber的学习路线\"]}),\"\\n\",n(l.p,{children:\"那么我们会分为四个章节去完成Fiber的学习，在理解这四个章节后，就理解Fiber的实现了。\"}),\"\\n\",e(l.ul,{children:[\"\\n\",n(l.li,{children:\"React Fiber架构：调度核心原理与实现\"}),\"\\n\",n(l.li,{children:\"React Fiber架构：深入解析任务队列、可中断渲染、调度、同步模式\"}),\"\\n\",n(l.li,{children:\"React Fiber架构：链表、Fiber节点与Fiber树\"}),\"\\n\",n(l.li,{children:\"React Fiber架构：React Fiber的创建、更新、提交\"}),\"\\n\"]})]})}return{default:function(i={}){const{wrapper:e}=i.components||{};return e?n(e,{...i,children:n(_createMdxContent,{...i})}):_createMdxContent(i)}};",
    "toc": {
      "content": [
        {
          "title": "1. React Fiber架构：初识Fiber",
          "url": "#1-react-fiber架构初识fiber",
          "items": [
            {
              "title": "2. Fiber 的核心问题：单线程的局限性",
              "url": "#2-fiber-的核心问题单线程的局限性",
              "items": []
            },
            {
              "title": "3. Fiber 的解决方案：时间切片和新的协调算法",
              "url": "#3-fiber-的解决方案时间切片和新的协调算法",
              "items": [
                {
                  "title": "2.1 时间切片（Time Slicing）",
                  "url": "#21-时间切片time-slicing",
                  "items": []
                },
                {
                  "title": "2.2 新的协调算法",
                  "url": "#22-新的协调算法",
                  "items": []
                }
              ]
            },
            {
              "title": "4. Fiber 的工作原理",
              "url": "#4-fiber-的工作原理",
              "items": [
                {
                  "title": "4.1 Fiber 节点和 Fiber 树",
                  "url": "#41-fiber-节点和-fiber-树",
                  "items": []
                },
                {
                  "title": "4.2 工作循环和优先级",
                  "url": "#42-工作循环和优先级",
                  "items": []
                },
                {
                  "title": "4.3 两个主要阶段",
                  "url": "#43-两个主要阶段",
                  "items": []
                }
              ]
            },
            {
              "title": "5. Fiber的学习路线",
              "url": "#5-fiber的学习路线",
              "items": []
            }
          ]
        }
      ],
      "visible": true
    },
    "slugAsParams": "1.why-use-firber"
  },
  {
    "slug": "/content/react-source-code/2.schedule",
    "title": "2.React Fiber架构：调度核心原理与实现",
    "description": "深入剖析React Fiber的调度机制，详细解读其源码实现，探讨React如何通过自定义调度器实现高效的任务调度和时间切片，以及与浏览器API的对比。",
    "published": true,
    "date": "2022-12-10T00:00:00.000Z",
    "body": "const{Fragment:l,jsx:n,jsxs:e}=arguments[0];function _createMdxContent(c){const r={a:\"a\",code:\"code\",figure:\"figure\",h1:\"h1\",h2:\"h2\",h3:\"h3\",h4:\"h4\",li:\"li\",ol:\"ol\",p:\"p\",pre:\"pre\",span:\"span\",ul:\"ul\",...c.components};return e(l,{children:[e(r.h1,{id:\"react-fiber架构调度核心原理与实现\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#react-fiber架构调度核心原理与实现\",children:n(r.span,{className:\"icon icon-link\"})}),\"React Fiber架构：调度核心原理与实现\"]}),\"\\n\",e(r.p,{children:[\"在深入探讨React Fiber的调度机制之前，我们可以通过浏览器提供的\",n(r.code,{children:\"requestIdleCallback\"}),' API获得一下启发。这个API虽然不是React实际使用的方案，但它为我们理解\"空闲时间\"和\"让出主线程\"的概念提供了很好的基础。']}),\"\\n\",e(r.h2,{id:\"1-requestidlecallback-简介\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#1-requestidlecallback-简介\",children:n(r.span,{className:\"icon icon-link\"})}),\"1. requestIdleCallback 简介\"]}),\"\\n\",n(r.p,{children:'浏览器的渲染过程是以帧为单位的，通常我们期望保持60帧/秒的刷新率，这意味着每帧大约有16.67ms的时间。如果一帧的工作在16ms内完成，剩余的时间就是所谓的\"空闲时间\"。'}),\"\\n\",e(r.h3,{id:\"11-api-详解\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#11-api-详解\",children:n(r.span,{className:\"icon icon-link\"})}),\"1.1 API 详解\"]}),\"\\n\",n(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" handle\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"window\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"requestIdleCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"callback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"[, \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"options\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"])\"})]})})})}),\"\\n\",e(r.ul,{children:[\"\\n\",e(r.li,{children:[n(r.code,{children:\"callback\"}),\": 一个在空闲期被调用的函数。\"]}),\"\\n\",e(r.li,{children:[n(r.code,{children:\"options\"}),\": 可选，包含 \",n(r.code,{children:\"timeout\"}),\" 属性，指定超时时间。\"]}),\"\\n\",e(r.li,{children:[\"返回值 \",n(r.code,{children:\"handle\"}),\": 可用于 \",n(r.code,{children:\"cancelIdleCallback()\"}),\" 取消回调。\"]}),\"\\n\"]}),\"\\n\",e(r.p,{children:[\"回调函数接收一个 \",n(r.code,{children:\"IdleDeadline\"}),\" 对象作为参数，包含：\"]}),\"\\n\",e(r.ul,{children:[\"\\n\",e(r.li,{children:[n(r.code,{children:\"timeRemaining()\"}),\": 返回当前空闲期剩余的估计毫秒数。\"]}),\"\\n\",e(r.li,{children:[n(r.code,{children:\"didTimeout\"}),\": 布尔值，表示回调是否因超时而被调用。\"]}),\"\\n\"]}),\"\\n\",e(r.h3,{id:\"12-实际应用示例\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#12-实际应用示例\",children:n(r.span,{className:\"icon icon-link\"})}),\"1.2 实际应用示例\"]}),\"\\n\",e(r.p,{children:[\"让我们通过两个对比示例来深入理解 \",n(r.code,{children:\"requestIdleCallback\"}),\" 的实际应用。\"]}),\"\\n\",e(r.h4,{id:\"不使用-requestidlecallback\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#不使用-requestidlecallback\",children:n(r.span,{className:\"icon icon-link\"})}),\"不使用 requestIdleCallback\"]}),\"\\n\",n(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" button\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"document\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"getElementById\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'button'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" input\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"document\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"getElementById\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'input'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" isPrimeNumber\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"button\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"addEventListener\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'click'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", () \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 模拟耗时计算\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  for\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"2\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"; \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"1000000000\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"; \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"++) {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"    isPrimeNumber\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    for\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" j\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"2\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"; \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"j\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"; \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"j\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"++) {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" % \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"j\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"        isPrimeNumber\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#54B9FF\"},children:\"        break\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"  console\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"log\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'计算完成'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"})\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"input\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"addEventListener\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'input'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", () \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"  console\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"log\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'输入值：'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"input\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"value\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"})\"})})]})})}),\"\\n\",n(r.p,{children:\"在这个例子中，点击按钮后的大量计算会阻塞主线程，导致输入框无法及时响应用户输入。\"}),\"\\n\",e(r.h4,{id:\"使用-requestidlecallback\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#使用-requestidlecallback\",children:n(r.span,{className:\"icon icon-link\"})}),\"使用 requestIdleCallback\"]}),\"\\n\",n(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" button\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"document\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"getElementById\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'button'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" input\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"document\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"getElementById\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'input'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" isPrimeNumber\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"2\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"button\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"addEventListener\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'click'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", () \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  function\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\" doWork\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"deadline\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    while\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"1000000000\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"deadline\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"timeRemaining\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"() > \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"      isPrimeNumber\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"      for\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" j\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"2\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"; \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"j\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"; \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"j\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"++) {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"        if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" % \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"j\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"          isPrimeNumber\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#54B9FF\"},children:\"          break\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"        }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"      i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"++\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"i\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"1000000000\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"      requestIdleCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"doWork\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"      console\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"log\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'计算完成'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"  requestIdleCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"doWork\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"})\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"input\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"addEventListener\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'input'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", () \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"  console\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"log\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'输入值：'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"input\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"value\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"})\"})})]})})}),\"\\n\",n(r.p,{children:\"这个改进版本将计算任务分割成多个小任务，在浏览器空闲时执行，从而保证了输入框的响应性。\"}),\"\\n\",e(r.h2,{id:\"2-react-中的调度实现\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#2-react-中的调度实现\",children:n(r.span,{className:\"icon icon-link\"})}),\"2. React 中的调度实现\"]}),\"\\n\",e(r.p,{children:[\"尽管 \",n(r.code,{children:\"requestIdleCallback\"}),\" 展示了空闲调度的概念，但React并未直接使用它。React实现了自己的\",n(r.code,{children:\"空闲调度\"}),\"，主要基于 \",n(r.code,{children:\"MessageChannel\"}),\" API。这个选择有几个重要原因：\"]}),\"\\n\",e(r.h3,{id:\"21-为什么选择-messagechannel\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#21-为什么选择-messagechannel\",children:n(r.span,{className:\"icon icon-link\"})}),\"2.1 为什么选择 MessageChannel\"]}),\"\\n\",e(r.ol,{children:[\"\\n\",e(r.li,{children:[\"\\n\",n(r.p,{children:\"高效性：MessageChannel 是一个轻量级且高效的 API，由浏览器原生实现，比 setTimeout 或 setInterval 更快、更可靠。\"}),\"\\n\"]}),\"\\n\",e(r.li,{children:[\"\\n\",n(r.p,{children:\"精确性：与 setTimeout 相比，MessageChannel 能提供更精确的计时。setTimeout 通常有最小 4ms 的延迟，而 MessageChannel 几乎没有这种限制。\"}),\"\\n\"]}),\"\\n\",e(r.li,{children:[\"\\n\",n(r.p,{children:\"优先级：MessageChannel 的消息处理通常比 setTimeout 有更高的优先级，在繁忙的 JavaScript 环境中能更快地得到执行。\"}),\"\\n\"]}),\"\\n\",e(r.li,{children:[\"\\n\",n(r.p,{children:\"性能优势：根据性能测试，MessageChannel 的延迟通常在 0-1ms 之间，而 setTimeout 在 4-16ms 之间。这种差异在需要频繁调度的场景中尤为明显。\"}),\"\\n\"]}),\"\\n\",e(r.li,{children:[\"\\n\",n(r.p,{children:\"细粒度控制：与 requestAnimationFrame（通常是 60Hz，约 16.7ms 间隔）相比，MessageChannel 可以在帧之间的任何时候触发，提供了更细粒度的控制。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(r.p,{children:\"这些特性使 MessageChannel 成为实现 React 调度器的理想选择，能够提供更细粒度和更可控的任务调度能力，对于 React 实现复杂的更新调度和保持应用的响应性至关重要。\"}),\"\\n\",e(r.h3,{id:\"22-react-调度源码实现\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#22-react-调度源码实现\",children:n(r.span,{className:\"icon icon-link\"})}),\"2.2 React 调度源码实现\"]}),\"\\n\",e(r.p,{children:[\"React的调度器使用 \",n(r.code,{children:\"MessageChannel\"}),\" 来实现消息的发送和接收。以下是核心实现的简化版本：\"]}),\"\\n\",n(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" scheduledHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" isMessageLoopRunning\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" yieldInterval\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"5\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" deadline\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"0\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" channel\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"new\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\" MessageChannel\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" port\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"channel\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"port2\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"channel\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"port1\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"onmessage\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"performWorkUntilDeadline\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\" requestHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"callback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"  scheduledHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"callback\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (!\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"isMessageLoopRunning\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"    isMessageLoopRunning\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"    port\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"postMessage\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\" performWorkUntilDeadline\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = () \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"scheduledHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" currentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"getCurrentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"    deadline\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" + \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"yieldInterval\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" hasTimeRemaining\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    try\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" hasMoreWork\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"scheduledHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"hasTimeRemaining\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (!\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"hasMoreWork\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"        isMessageLoopRunning\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"        scheduledHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#EEF0F9\"},children:\"      } \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"        port\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"postMessage\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"catch\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"error\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"      port\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"postMessage\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"      throw\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" error\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"    isMessageLoopRunning\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\" shouldYieldToHost\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" () {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\" getCurrentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"() >= \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"deadline\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(r.p,{children:\"这个实现的关键点在于：\"}),\"\\n\",e(r.ol,{children:[\"\\n\",e(r.li,{children:[\"使用 \",n(r.code,{children:\"MessageChannel\"}),\" 创建一个消息通道。\"]}),\"\\n\",e(r.li,{children:[n(r.code,{children:\"requestHostCallback\"}),\" 函数用于注册回调并启动消息循环。\"]}),\"\\n\",e(r.li,{children:[n(r.code,{children:\"performWorkUntilDeadline\"}),\" 函数在每次接收到消息时执行，它会运行回调函数并决定是否需要继续工作。\"]}),\"\\n\",e(r.li,{children:[n(r.code,{children:\"shouldYieldToHost\"}),\" 函数用于判断是否应该中断当前工作，让出主线程。\"]}),\"\\n\"]}),\"\\n\",e(r.h3,{id:\"23-时间切片实现\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#23-时间切片实现\",children:n(r.span,{className:\"icon icon-link\"})}),\"2.3 时间切片实现\"]}),\"\\n\",e(r.p,{children:[\"React通过设置一个时间片（默认为5ms，见 \",n(r.code,{children:\"yieldInterval\"}),\" 变量）来实现任务的分割。在每个时间片内，React会尝试执行尽可能多的工作，但一旦超过时间限制，就会暂停当前工作，将控制权交还给浏览器。\"]}),\"\\n\",n(r.p,{children:\"这种实现允许React在执行复杂更新时保持应用的响应性，有效防止了长时间任务阻塞主线程的问题。通过 MessageChannel 的高效特性，React 能够在每一帧中多次执行调度，实现更平滑的任务分割和更响应的用户界面。\"}),\"\\n\",e(r.h2,{id:\"3-settimeout-降级实现\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#3-settimeout-降级实现\",children:n(r.span,{className:\"icon icon-link\"})}),\"3. setTimeout 降级实现\"]}),\"\\n\",e(r.p,{children:[\"当然为了兼容不支持 \",n(r.code,{children:\"MessageChannel\"}),\" 的环境，React还提供了一个基于 \",n(r.code,{children:\"setTimeout\"}),\" 的降级实现：\"]}),\"\\n\",n(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"//简化版\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" window\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'undefined'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" || \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" MessageChannel\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"'function'\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" _callback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" _timeoutID\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(r.span,{style:{color:\"#00DAEF\"},children:\" _flushCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" () {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"_callback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"      try\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"        const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" currentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#00DAEF\"},children:\"getCurrentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"        const\"}),n(r.span,{style:{color:\"#ACAFFF\"},children:\" hasRemainingTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"        _callback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"hasRemainingTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"        _callback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#EEF0F9\"},children:\"      } \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"catch\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"e\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"        setTimeout\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"_flushCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"        throw\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\" e\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"  requestHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"cb\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"_callback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"      setTimeout\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"requestHostCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"cb\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(r.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#4BF3C8\"},children:\"      _callback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"cb\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:[n(r.span,{style:{color:\"#00DAEF\"},children:\"      setTimeout\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(r.span,{style:{color:\"#4BF3C8\"},children:\"_flushCallback\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(r.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ... 其他相关函数的降级实现\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:n(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(r.p,{children:[\"这个降级实现虽然不如 \",n(r.code,{children:\"MessageChannel\"}),\" 版本精确，但仍然保证了基本的调度功能。\"]}),\"\\n\",e(r.h2,{id:\"4-总结与思考\",children:[n(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#4-总结与思考\",children:n(r.span,{className:\"icon icon-link\"})}),\"4. 总结与思考\"]}),\"\\n\",n(r.p,{children:\"React的调度器是性能优化的核心之一。通过自定义的调度机制，React能够更好地控制任务执行的时机和顺序，从而在复杂应用中保持良好的性能和响应性。\"}),\"\\n\",n(r.p,{children:\"理解React的调度机制不仅有助于我们更好地使用React，也为我们在其他场景下进行性能优化提供了宝贵的思路。\"}),\"\\n\",n(r.p,{children:\"那么在下一章我们将直接进入到任务队列、可中断渲染、调度、同步模式的讲解和学习。\"})]})}return{default:function(l={}){const{wrapper:e}=l.components||{};return e?n(e,{...l,children:n(_createMdxContent,{...l})}):_createMdxContent(l)}};",
    "toc": {
      "content": [
        {
          "title": "React Fiber架构：调度核心原理与实现",
          "url": "#react-fiber架构调度核心原理与实现",
          "items": [
            {
              "title": "1. requestIdleCallback 简介",
              "url": "#1-requestidlecallback-简介",
              "items": [
                {
                  "title": "1.1 API 详解",
                  "url": "#11-api-详解",
                  "items": []
                },
                {
                  "title": "1.2 实际应用示例",
                  "url": "#12-实际应用示例",
                  "items": [
                    {
                      "title": "不使用 requestIdleCallback",
                      "url": "#不使用-requestidlecallback",
                      "items": []
                    },
                    {
                      "title": "使用 requestIdleCallback",
                      "url": "#使用-requestidlecallback",
                      "items": []
                    }
                  ]
                }
              ]
            },
            {
              "title": "2. React 中的调度实现",
              "url": "#2-react-中的调度实现",
              "items": [
                {
                  "title": "2.1 为什么选择 MessageChannel",
                  "url": "#21-为什么选择-messagechannel",
                  "items": []
                },
                {
                  "title": "2.2 React 调度源码实现",
                  "url": "#22-react-调度源码实现",
                  "items": []
                },
                {
                  "title": "2.3 时间切片实现",
                  "url": "#23-时间切片实现",
                  "items": []
                }
              ]
            },
            {
              "title": "3. setTimeout 降级实现",
              "url": "#3-settimeout-降级实现",
              "items": []
            },
            {
              "title": "4. 总结与思考",
              "url": "#4-总结与思考",
              "items": []
            }
          ]
        }
      ],
      "visible": true
    },
    "slugAsParams": "2.schedule"
  },
  {
    "slug": "/content/react-source-code/3.react_task_queue",
    "title": "3.React Fiber架构：深入解析任务队列、可中断渲染、调度、同步模式",
    "description": "React Fiber架构：深入解析任务队列、可中断渲染、调度、同步模式",
    "published": true,
    "date": "2023-01-08T00:00:00.000Z",
    "body": "const{Fragment:l,jsx:n,jsxs:e}=arguments[0];function _createMdxContent(r){const c={a:\"a\",code:\"code\",figure:\"figure\",h2:\"h2\",h3:\"h3\",h4:\"h4\",li:\"li\",ol:\"ol\",p:\"p\",pre:\"pre\",span:\"span\",strong:\"strong\",ul:\"ul\",...r.components};return e(l,{children:[e(c.h2,{id:\"1-react-fiber架构深入解析任务队列可中断渲染调度同步模式\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#1-react-fiber架构深入解析任务队列可中断渲染调度同步模式\",children:n(c.span,{className:\"icon icon-link\"})}),\"1. React Fiber架构：深入解析任务队列、可中断渲染、调度、同步模式\"]}),\"\\n\",e(c.p,{children:[\"在React Fiber架构中，任务队列是实现可中断渲染和优先级调度的核心组件。本文主要讲\",n(c.code,{children:\"Fiber\"}),\"的\",n(c.code,{children:\"任务队列\"}),\"、\",n(c.code,{children:\"可中断渲染\"}),\"、\",n(c.code,{children:\"调度\"}),\"、\",n(c.code,{children:\"同步模式\"}),\"。\"]}),\"\\n\",e(c.p,{children:[\"理解了这一整节，几乎就把 \",n(c.code,{children:\"Fiber\"}),\" 中最重要的东西和主线理解了，其余都是散散碎碎的小细节。\"]}),\"\\n\",e(c.h2,{id:\"2-任务队列的概念和作用\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#2-任务队列的概念和作用\",children:n(c.span,{className:\"icon icon-link\"})}),\"2. 任务队列的概念和作用\"]}),\"\\n\",n(c.p,{children:\"在深入源码之前，我们需要先理解任务队列在React Fiber架构中的重要性。\"}),\"\\n\",e(c.h3,{id:\"21-什么是任务队列\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#21-什么是任务队列\",children:n(c.span,{className:\"icon icon-link\"})}),\"2.1 什么是任务队列？\"]}),\"\\n\",n(c.p,{children:\"任务队列是一种数据结构，用于存储和管理需要执行的任务。在React Fiber中，任务队列主要用于管理更新和渲染过程中的各种操作，如组件更新、DOM操作等。\"}),\"\\n\",e(c.h3,{id:\"22-任务队列的作用\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#22-任务队列的作用\",children:n(c.span,{className:\"icon icon-link\"})}),\"2.2 任务队列的作用\"]}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[n(c.strong,{children:\"任务调度\"}),\"：根据优先级对任务进行排序和调度。\"]}),\"\\n\",e(c.li,{children:[n(c.strong,{children:\"中断与恢复\"}),\"：支持任务的中断和恢复，实现可中断渲染。\"]}),\"\\n\",e(c.li,{children:[n(c.strong,{children:\"优先级管理\"}),\"：为不同类型的更新分配不同的优先级。\"]}),\"\\n\",e(c.li,{children:[n(c.strong,{children:\"性能优化\"}),\"：通过合理调度任务，提高渲染性能和用户体验。\"]}),\"\\n\"]}),\"\\n\",e(c.h2,{id:\"3-react源码中的任务队列实现\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#3-react源码中的任务队列实现\",children:n(c.span,{className:\"icon icon-link\"})}),\"3. React源码中的任务队列实现\"]}),\"\\n\",n(c.p,{children:\"首先我们看任务队列是如何实现的。\"}),\"\\n\",e(c.h3,{id:\"31-数据结构\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#31-数据结构\",children:n(c.span,{className:\"icon icon-link\"})}),\"3.1 数据结构\"]}),\"\\n\",n(c.p,{children:\"React使用小顶堆（Min Heap）来实现任务队列。小顶堆是一种特殊的二叉树，其中每个节点的值都小于或等于其子节点的值。这种结构非常适合优先级队列的实现，因为它可以在O(log n)的时间复杂度内完成插入和删除操作。\"}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/scheduler/src/Scheduler.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" taskQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = []\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" timerQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = []\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// ... 其他代码\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" push\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"length\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"push\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  siftUp\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" peek\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"length\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" ?\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" null\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" :\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"]\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" pop\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"length\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" null\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" first\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"]\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" last\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"pop\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"last\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"first\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"last\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    siftDown\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"last\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" first\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:[\"在这段代码中，我们可以看到任务队列（\",n(c.code,{children:\"taskQueue\"}),\"）和定时器队列（\",n(c.code,{children:\"timerQueue\"}),\"）的定义，以及用于操作堆的基本函数：\",n(c.code,{children:\"push\"}),\"、\",n(c.code,{children:\"peek\"}),\"和\",n(c.code,{children:\"pop\"}),\"。\"]}),\"\\n\",e(c.h3,{id:\"32-任务的表示\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#32-任务的表示\",children:n(c.span,{className:\"icon icon-link\"})}),\"3.2 任务的表示\"]}),\"\\n\",n(c.p,{children:\"在React中，每个任务都被表示为一个对象，包含以下主要属性：\"}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/scheduler/src/Scheduler.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" newTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  id\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"taskIdCounter\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"++,\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  callback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  priorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  expirationTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  sortIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": -\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[n(c.code,{children:\"id\"}),\"：任务的唯一标识符。\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"callback\"}),\"：任务的回调函数。\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"priorityLevel\"}),\"：任务的优先级。\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"startTime\"}),\"：任务的开始时间。\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"expirationTime\"}),\"：任务的过期时间。\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"sortIndex\"}),\"：用于在队列中排序的索引。\"]}),\"\\n\"]}),\"\\n\",e(c.h3,{id:\"33-优先级的定义\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#33-优先级的定义\",children:n(c.span,{className:\"icon icon-link\"})}),\"3.3 优先级的定义\"]}),\"\\n\",n(c.p,{children:\"React定义了多个优先级级别，用于区分不同类型的任务：\"}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/scheduler/src/SchedulerPriorities.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"export\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" NoPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"export\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" ImmediatePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"export\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" UserBlockingPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"2\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"export\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" NormalPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"3\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"export\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" LowPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"4\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"export\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" IdlePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"5\"})]})]})})}),\"\\n\",n(c.p,{children:\"这些优先级从高到低排列，用于决定任务的执行顺序。\"}),\"\\n\",e(c.h2,{id:\"4-任务队列的创建过程\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#4-任务队列的创建过程\",children:n(c.span,{className:\"icon icon-link\"})}),\"4. 任务队列的创建过程\"]}),\"\\n\",n(c.p,{children:\"任务队列的创建是React Fiber架构的基础。\"}),\"\\n\",e(c.h3,{id:\"41-初始化\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#41-初始化\",children:n(c.span,{className:\"icon icon-link\"})}),\"4.1 初始化\"]}),\"\\n\",e(c.p,{children:[\"任务队列在React初始化时就会被创建。在\",n(c.code,{children:\"Scheduler.js\"}),\"文件中，我们可以看到队列的初始化：\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" taskQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = []\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" timerQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = []\"})]})]})})}),\"\\n\",n(c.p,{children:\"这里创建了两个队列：\"}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[n(c.code,{children:\"taskQueue\"}),\"用于存储准备执行的任务\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"timerQueue\"}),\"用于存储延迟执行的任务\"]}),\"\\n\"]}),\"\\n\",e(c.h3,{id:\"42-添加任务\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#42-添加任务\",children:n(c.span,{className:\"icon icon-link\"})}),\"4.2 添加任务\"]}),\"\\n\",e(c.p,{children:[\"当需要添加新任务时，React会调用\",n(c.code,{children:\"unstable_scheduleCallback\"}),\"函数：\"]}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/scheduler/src/Scheduler.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" unstable_scheduleCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"priorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"callback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"options\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"getCurrentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" startTime\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" options\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'object'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"options\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" delay\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"options\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"delay\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" delay\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'number'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"delay\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" > \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" + \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"delay\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" timeout\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  switch\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"priorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" ImmediatePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      timeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"IMMEDIATE_PRIORITY_TIMEOUT\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      break\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" UserBlockingPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      timeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"USER_BLOCKING_PRIORITY_TIMEOUT\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      break\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" IdlePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      timeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"IDLE_PRIORITY_TIMEOUT\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      break\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" LowPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      timeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"LOW_PRIORITY_TIMEOUT\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      break\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" NormalPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    default\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      timeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"NORMAL_PRIORITY_TIMEOUT\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      break\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" expirationTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" + \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"timeout\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" newTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    id\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"taskIdCounter\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"++,\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    callback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    priorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    expirationTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    sortIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": -\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" > \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // This is a delayed task.\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    newTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sortIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"startTime\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    push\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"timerQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"peek\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"taskQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"peek\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"timerQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // All tasks are delayed, and this is the task with the earliest delay.\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"isHostTimeoutScheduled\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"        // Cancel an existing timeout.\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"        cancelHostTimeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        isHostTimeoutScheduled\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // Schedule a timeout.\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      requestHostTimeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"handleTimeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" - \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    newTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sortIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"expirationTime\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    push\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"taskQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // Schedule a host callback, if needed. If we're already performing work,\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // wait until the next time we yield.\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (!\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"isHostCallbackScheduled\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && !\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"isPerformingWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      isHostCallbackScheduled\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      requestHostCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"flushWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" newTask\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个函数完成了以下几个关键步骤：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",n(c.li,{children:\"计算任务的开始时间和过期时间。\"}),\"\\n\",n(c.li,{children:\"根据优先级设置超时时间。\"}),\"\\n\",n(c.li,{children:\"创建新的任务对象。\"}),\"\\n\",e(c.li,{children:[\"将任务添加到适当的队列（\",n(c.code,{children:\"taskQueue\"}),\"或\",n(c.code,{children:\"timerQueue\"}),\"）。\"]}),\"\\n\",n(c.li,{children:\"如果需要，调度主机回调或超时。\"}),\"\\n\"]}),\"\\n\",e(c.h3,{id:\"43-任务排序\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#43-任务排序\",children:n(c.span,{className:\"icon icon-link\"})}),\"4.3 任务排序\"]}),\"\\n\",e(c.p,{children:[\"任务在添加到队列时会进行排序。排序的关键在于\",n(c.code,{children:\"sortIndex\"}),\"属性：\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[\"对于延迟任务（\",n(c.code,{children:\"timerQueue\"}),\"），\",n(c.code,{children:\"sortIndex\"}),\"是任务的开始时间。\"]}),\"\\n\",e(c.li,{children:[\"对于立即执行的任务（\",n(c.code,{children:\"taskQueue\"}),\"），\",n(c.code,{children:\"sortIndex\"}),\"是任务的过期时间。\"]}),\"\\n\"]}),\"\\n\",e(c.p,{children:[\"排序过程通过\",n(c.code,{children:\"push\"}),\"函数实现，该函数内部调用\",n(c.code,{children:\"siftUp\"}),\"来维护小顶堆的性质：\"]}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/scheduler/src/Scheduler.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" push\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"length\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"push\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  siftUp\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" siftUp\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"i\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"i\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"true\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" parentIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" - \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") >>> \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" parent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"parentIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"]\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"parent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"undefined\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"compare\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"parent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") > \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // The parent is larger. Swap positions.\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"parentIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"node\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      heap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"parent\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"parentIndex\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // The parent is smaller. Exit.\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个过程确保了队列中的任务始终按照正确的顺序排列，使得优先级最高的任务总是位于队列的顶部。\"}),\"\\n\",e(c.h2,{id:\"5-任务队列的调度过程\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#5-任务队列的调度过程\",children:n(c.span,{className:\"icon icon-link\"})}),\"5. 任务队列的调度过程\"]}),\"\\n\",n(c.p,{children:\"创建任务队列后，React需要有效地调度这些任务。\"}),\"\\n\",e(c.h3,{id:\"51-调度器的初始化\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#51-调度器的初始化\",children:n(c.span,{className:\"icon icon-link\"})}),\"5.1 调度器的初始化\"]}),\"\\n\",n(c.p,{children:\"React使用调度系统来管理任务的执行。这个系统的核心是Scheduler.js中的几个关键函数和机制。\"}),\"\\n\",e(c.ol,{children:[\"\\n\",n(c.li,{children:\"调度器初始化:\"}),\"\\n\"]}),\"\\n\",e(c.p,{children:[\"当我们调用\",n(c.code,{children:\"requestHostCallback\"}),\"时,它会设置\",n(c.code,{children:\"scheduledHostCallback\"}),\"并通过\",n(c.code,{children:\"MessageChannel\"}),\"发送一个消息:\"]}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/scheduler/src/Scheduler.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 创建一个MessageChannel用于任务调度\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" channel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"new\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" MessageChannel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" port\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"channel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"port2\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 请求主机回调函数\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" requestHostCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"callback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 设置调度回调函数\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  scheduledHostCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callback\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (!\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"isMessageLoopRunning\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    isMessageLoopRunning\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 通过MessageChannel发送消息,触发任务执行\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    port\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"postMessage\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 消息事件处理函数\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"channel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"port1\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"onmessage\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"performWorkUntilDeadline\"})]})]})})}),\"\\n\",n(c.p,{children:\"这段代码的工作原理如下:\"}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[\"创建一个\",n(c.code,{children:\"MessageChannel\"}),\"用于在主线程和调度器之间通信。\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"requestHostCallback\"}),\"函数用于设置要执行的回调函数。\"]}),\"\\n\",n(c.li,{children:\"当设置了新的回调函数时,如果消息循环还没有运行,就发送一个消息来启动它。\"}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"channel.port1.onmessage\"}),\"设置为\",n(c.code,{children:\"performWorkUntilDeadline\"}),\"函数,这个函数将在收到消息时被调用。\"]}),\"\\n\"]}),\"\\n\",e(c.ol,{start:\"2\",children:[\"\\n\",n(c.li,{children:\"执行调度任务:\"}),\"\\n\"]}),\"\\n\",e(c.p,{children:[n(c.code,{children:\"performWorkUntilDeadline\"}),\"函数是调度器的核心,它负责执行任务并管理时间:\"]}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/scheduler/src/Scheduler.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" scheduledHostCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" isMessageLoopRunning\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = -\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" performWorkUntilDeadline\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"scheduledHostCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 获取当前时间\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"getCurrentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 计算截止时间\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    deadline\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" + \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"yieldInterval\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 标记开始时间\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" hasTimeRemaining\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    try\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 执行调度的回调函数\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" hasMoreWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"scheduledHostCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"hasTimeRemaining\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (!\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"hasMoreWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"        // 如果没有更多工作,停止消息循环\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        isMessageLoopRunning\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        scheduledHostCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"        // 如果还有更多工作,继续发送消息\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        port\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"postMessage\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"catch\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"error\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 如果发生错误,继续发送消息并抛出错误\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      port\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"postMessage\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      throw\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" error\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    isMessageLoopRunning\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 重置开始时间\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = -\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个函数的工作流程如下:\"}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"检查是否有调度的回调函数。\"}),\"\\n\",n(c.li,{children:\"如果有,执行这个回调函数,并传入时间信息。\"}),\"\\n\",n(c.li,{children:\"根据回调函数的返回值决定是否继续循环。\"}),\"\\n\",n(c.li,{children:\"如果发生错误,确保继续发送消息以保持循环,然后抛出错误。\"}),\"\\n\",n(c.li,{children:\"如果没有回调函数,停止消息循环。\"}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"通过这种机制,React能够在主线程空闲时执行任务,并在需要时让出控制权,保证了页面的响应。\"}),\"\\n\",e(c.h3,{id:\"52-任务执行\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#52-任务执行\",children:n(c.span,{className:\"icon icon-link\"})}),\"5.2 任务执行\"]}),\"\\n\",e(c.p,{children:[\"任务的实际执行是在\",n(c.code,{children:\"workLoop\"}),\"函数中完成的。这个函数是React调度器的核心,负责循环执行队列中的任务。\"]}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/scheduler/src/Scheduler.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" workLoop\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"hasTimeRemaining\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"initialTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"initialTime\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 更新定时器队列中的任务\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  advanceTimers\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 获取任务队列中的第一个任务\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"peek\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"taskQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && !(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"enableSchedulerDebugging\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"isSchedulerPaused\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 检查任务是否过期,或者是否需要让出执行权\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"expirationTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" > \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && (!\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"hasTimeRemaining\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" || \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"shouldYieldToHost\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"())) {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 当前任务还没过期,但已经到达时间限制,需要中断执行\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      break\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" callback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callback\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" callback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'function'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 重置任务的回调,防止重复执行\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 设置当前优先级\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      currentPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"priorityLevel\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 检查任务是否已超时\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" didUserCallbackTimeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"expirationTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <= \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 执行任务回调\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" continuationCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"callback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"didUserCallbackTimeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 更新当前时间\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"getCurrentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" continuationCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'function'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"        // 如果回调返回一个函数,说明任务需要继续执行\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"continuationCallback\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"        // 任务完成,将其从队列中移除\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"peek\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"taskQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"          pop\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"taskQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"        }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 再次更新定时器队列\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      advanceTimers\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 如果回调不是函数,直接将任务从队列中移除\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      pop\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"taskQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 获取下一个任务\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"peek\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"taskQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 检查是否还有更多工作要做\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTask\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" true\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 如果任务队列为空,检查定时器队列\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" firstTimer\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"peek\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"timerQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"firstTimer\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 如果有延迟任务,安排一个新的超时回调\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      requestHostTimeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"handleTimeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"firstTimer\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"startTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" - \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" false\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个函数的工作流程如下:\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:\"首先更新定时器队列,将到期的定时器任务移到主任务队列中。\"}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:\"然后开始一个循环,不断从任务队列中取出任务执行:\"}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"检查任务是否过期或是否需要让出执行权。\"}),\"\\n\",n(c.li,{children:\"如果任务还没过期但已达到时间限制,就中断执行。\"}),\"\\n\",n(c.li,{children:\"执行任务的回调函数。\"}),\"\\n\",n(c.li,{children:\"如果回调返回一个新的函数,说明任务需要继续执行,就将这个新函数设置为任务的回调。\"}),\"\\n\",n(c.li,{children:\"如果任务执行完毕,就将其从队列中移除。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:\"每执行完一个任务,都会再次更新定时器队列,确保及时处理到期的定时器任务。\"}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:\"循环结束后,如果任务队列中还有任务,就返回true,表示还有工作要做。\"}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:\"如果任务队列为空,但定时器队列中有任务,就安排一个新的超时回调,以便在定时器到期时继续执行。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.h3,{id:\"53-任务中断与恢复\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#53-任务中断与恢复\",children:n(c.span,{className:\"icon icon-link\"})}),\"5.3 任务中断与恢复\"]}),\"\\n\",e(c.p,{children:[\"React Fiber的一个核心特性是可中断渲染，这允许React在长时间运行的任务中途暂停，将控制权交还给浏览器，从而保持UI的响应。这个机制主要通过任务调度和时间切片来实现，其中\",n(c.code,{children:\"shouldYieldToHost\"}),\"函数扮演了关键角色。\"]}),\"\\n\",e(c.h4,{id:\"531-shouldyieldtohost-函数\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#531-shouldyieldtohost-函数\",children:n(c.span,{className:\"icon icon-link\"})}),\"5.3.1 shouldYieldToHost 函数\"]}),\"\\n\",e(c.p,{children:[n(c.code,{children:\"shouldYieldToHost\"}),\"函数决定是否应该中断当前任务，将控制权交还给浏览器：\"]}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/scheduler/src/Scheduler.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" shouldYieldToHost\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 计算从任务开始到现在经过的时间\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" timeElapsed\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"getCurrentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() - \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"startTime\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 如果经过的时间小于一帧的时间，继续执行任务\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"timeElapsed\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"frameInterval\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 主线程被阻塞的时间很短，小于一帧的时间。\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 此时不需要让出控制权，继续执行当前任务。\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" false\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 检查是否启用了isInputPending API\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"enableIsInputPending\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 检查是否有待处理的绘制任务\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"needsPaint\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 有待处理的绘制任务，立即让出控制权\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" true\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 检查是否有待处理的离散输入事件（如点击）\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"timeElapsed\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"continuousInputInterval\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 如果阻塞时间不长，只在有待处理的离散输入时让出控制权\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" isInputPending\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 检查是否有任何类型的待处理输入事件\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"timeElapsed\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"maxInterval\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 已经阻塞了一段时间，但仍在可接受范围内\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 只在有待处理的输入（离散或连续）时让出控制权\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" isInputPending\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"continuousOptions\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 已经阻塞了很长时间，无条件让出控制权\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" true\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 如果isInputPending API不可用，总是让出控制权\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" true\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个函数有这几个因素来决定是否中断任务：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",n(c.li,{children:\"任务执行时间\"}),\"\\n\",n(c.li,{children:\"是否有待处理的绘制任务\"}),\"\\n\",n(c.li,{children:\"是否有待处理的用户输入（区分离散输入和连续输入）\"}),\"\\n\",e(c.li,{children:[\"浏览器是否支持\",n(c.code,{children:\"isInputPending\"}),\" API\"]}),\"\\n\"]}),\"\\n\",e(c.h4,{id:\"532-任务中断和恢复的实现\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#532-任务中断和恢复的实现\",children:n(c.span,{className:\"icon icon-link\"})}),\"5.3.2 任务中断和恢复的实现\"]}),\"\\n\",n(c.p,{children:\"任务的中断和恢复主要在React的工作循环中实现：\"}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/react-reconciler/src/ReactFiberWorkLoop.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" workLoopConcurrent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && !\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"shouldYield\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    performUnitOfWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:[\"在这个并发模式的工作循环中，React 会不断检查 \",n(c.code,{children:\"shouldYield()\"}),\" 函数（内部会调用 \",n(c.code,{children:\"shouldYieldToHost()\"}),\"）。如果需要让出控制权，React 会中断当前的渲染过程。\"]}),\"\\n\",n(c.p,{children:\"任务的恢复由React的调度器负责：\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" performConcurrentWorkOnRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"didTimeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  do\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    try\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"didTimeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"        renderRootSync\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"        renderRootConcurrent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      break\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"catch\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"thrownValue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      handleError\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"thrownValue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"true\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"originalCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 如果当前执行的任务节点与调度的节点相同，\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 返回一个继续执行的回调函数\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" performConcurrentWorkOnRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"bind\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" null\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:[\"如果任务被中断，\",n(c.code,{children:\"performConcurrentWorkOnRoot\"}),\" 函数会返回一个继续执行的回调，允许调度器在之后恢复这个任务。\"]}),\"\\n\",e(c.h4,{id:\"533-优先级管理和任务切换\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#533-优先级管理和任务切换\",children:n(c.span,{className:\"icon icon-link\"})}),\"5.3.3 优先级管理和任务切换\"]}),\"\\n\",n(c.p,{children:\"React 还通过优先级管理来决定任务的执行顺序：\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" ensureRootIsScheduled\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"FiberRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"number\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" newCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"getHighestPriorityLane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" existingCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"existingCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 优先级没有变化，可以复用现有任务\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"existingCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" != \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 取消现有的回调，准备调度新的回调\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    cancelCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"existingCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 调度新的回调\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" newCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"SyncLane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 同步优先级使用特殊的内部队列\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    newCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"scheduleSyncCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      performSyncWorkOnRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"bind\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    );\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" schedulerPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"lanePriorityToSchedulerPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#4BF3C8\"},children:\"      newCallbackPriority\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    );\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    newCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"scheduleCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      schedulerPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      performConcurrentWorkOnRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"bind\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    );\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个函数确保根节点被正确调度，它会根据任务的优先级来决定是否中断当前任务并调度新的高优先级任务。\"}),\"\\n\",n(c.p,{children:\"通过这种复杂的任务中断、恢复和优先级管理机制，React能够在执行长时间任务时保持对用户输入的响应，提供流畅的用户体验。\"}),\"\\n\",e(c.p,{children:[\"在实际应用中，我们可以利用这一机制来优化性能，例如将大型计算任务拆分成小块，使用\",n(c.code,{children:\"React.useCallback\"}),\"和\",n(c.code,{children:\"React.useMemo\"}),\"来缓存计算结果，或者使用\",n(c.code,{children:\"React.lazy\"}),\"和\",n(c.code,{children:\"Suspense\"}),\"来延迟加载不急需的组件。\"]}),\"\\n\",e(c.ol,{children:[\"\\n\",n(c.li,{children:\"React.useCallback 和 React.useMemo\"}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"这两个hooks都是用于性能优化，通过缓存计算结果来避免不必要的重新计算，从而减少渲染时间，他们的本质其实是让出更多时间给高优先级任务。\"}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/react-reconciler/src/ReactFiberHooks.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" updateMemo\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"T\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  nextCreate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": () \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" T\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  deps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Array\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"mixed\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"> | \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"void\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | null,\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"): \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"T\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" hook\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"updateWorkInProgressHook\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"();\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" nextDeps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"deps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"undefined\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" ?\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" null\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" :\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" deps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" prevState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"hook\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"memoizedState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"prevState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextDeps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" prevDeps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Array\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"mixed\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"> | null = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"prevState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"];\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"areHookInputsEqual\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextDeps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"prevDeps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" prevState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"];\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" nextValue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"nextCreate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"();\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  hook\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"memoizedState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = [\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextValue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextDeps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"];\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" nextValue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:[\"这是\",n(c.code,{children:\"useMemo\"}),\"的实现。它会检查依赖是否变化，如果没有变化，直接返回缓存的值，避免重新计算。这样可以减少不必要的计算，为其他高优先级任务留出更多时间。\"]}),\"\\n\",e(c.ol,{start:\"2\",children:[\"\\n\",n(c.li,{children:\"React.lazy 和 Suspense\"}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"这两个API允许我们延迟加载组件，减少初始加载时间，并在加载过程中显示fallback内容。\"}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/react/src/ReactLazy.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" lazy\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"T\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  ctor\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": () \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" Thenable\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"default\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"T\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", ...}>,\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"): \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"LazyComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"T\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Payload\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"T\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">> {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" payload\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Payload\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"T\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"> = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    _status\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Uninitialized\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    _result\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"ctor\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  };\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" lazyType\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"LazyComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"T\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Payload\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"T\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">> = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    $$typeof\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"REACT_LAZY_TYPE\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    _payload\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"payload\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    _init\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lazyInitializer\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  };\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" lazyType\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:[\"这是\",n(c.code,{children:\"React.lazy\"}),\"的实现。它创建一个特殊的组件类型，这个组件在渲染时会触发异步加载。\"]}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/react-reconciler/src/ReactFiberThrow.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" throwException\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"FiberRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  sourceFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  value\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"mixed\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  rootRenderLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"value\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" value\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'object'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" value\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"then\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'function'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // This is a wakeable.\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" wakeable\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Wakeable\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = (\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"value\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"any\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // ...\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // Schedule the nearest Suspense to re-render the timed out view.\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" suspenseBoundary\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"getNearestSuspenseBoundaryToCapture\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"suspenseBoundary\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      suspenseBoundary\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" &=\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" ~\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"ForceClientRender\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      markSuspenseBoundaryShouldCapture\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        suspenseBoundary\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        sourceFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        rootRenderLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      );\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // We only attach ping listeners in concurrent mode.\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"suspenseBoundary\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"mode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" & \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"ConcurrentMode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"        attachPingListener\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"wakeable\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"rootRenderLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // ...\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"当遇到一个Promise时，React会寻找最近的Suspense边界，并让它重新渲染。这允许React在异步内容加载时显示fallback内容，而不会阻塞整个应用的渲染。\"}),\"\\n\",n(c.p,{children:\"就是说\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.code,{children:\"useCallback\"}),\"和\",n(c.code,{children:\"useMemo\"}),\"通过减少不必要的计算和渲染，为其他可能被中断的高优先级任务留出更多时间。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.code,{children:\"React.lazy\"}),\"和\",n(c.code,{children:\"Suspense\"}),\"允许React在遇到尚未加载的组件时暂停渲染，显示fallback内容，然后在组件加载完成后恢复渲染。这整个过程都是可中断的，允许React在必要时处理更高优先级的任务。\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"例如，考虑以下场景：\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" HeavyComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"React\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"lazy\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(() \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" import\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'./HeavyComponent'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"))\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" App\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"showHeavy\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"setShowHeavy\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"false\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" heavyCalculation\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useMemo\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(() \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" computeExpensiveValue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"a\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"b\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"), [\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"a\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"b\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"])\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"button\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\" onClick\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"=\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" setShowHeavy\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"true\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Load Heavy Component</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"button\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"p\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"heavyCalculation\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"p\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Suspense\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\" fallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"=\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Loading...</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"showHeavy\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"HeavyComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"</\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Suspense\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    </\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  )\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"在这个例子中：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.code,{children:\"useMemo\"}),\"确保\",n(c.code,{children:\"heavyCalculation\"}),\"只在\",n(c.code,{children:\"a\"}),\"或\",n(c.code,{children:\"b\"}),\"改变时重新计算，避免在每次渲染时都进行昂贵的计算。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.code,{children:\"React.lazy\"}),\"和\",n(c.code,{children:\"Suspense\"}),\"允许\",n(c.code,{children:\"HeavyComponent\"}),\"延迟加载。当用户点击按钮时，React会开始加载组件，但不会阻塞UI，而是显示fallback内容。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:\"整个过程中，如果有更高优先级的任务（如用户输入），React可以中断当前任务，处理高优先级任务，然后再恢复之前的渲染。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"这其实就是这些API如何与React的任务中断、恢复和优先级管理机制协同工作，也是我们真正在开发的时候会遇到的场景。\"}),\"\\n\",e(c.h3,{id:\"54-优先级管理和饥饿问题的解决\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#54-优先级管理和饥饿问题的解决\",children:n(c.span,{className:\"icon icon-link\"})}),\"5.4 优先级管理和饥饿问题的解决\"]}),\"\\n\",n(c.p,{children:\"React的调度系统不仅要处理任务的执行，还需要解决由于持续的高优先级任务导致的低优先级任务饥饿问题（一直不执行）。\"}),\"\\n\",e(c.ol,{children:[\"\\n\",n(c.li,{children:n(c.strong,{children:\"标记饥饿车道\"})}),\"\\n\"]}),\"\\n\",e(c.p,{children:[\"在每次调度更新时，React都会调用\",n(c.code,{children:\"ensureRootIsScheduled\"}),\"函数，该函数会调用\",n(c.code,{children:\"markStarvedLanesAsExpired\"}),'来检查是否有被其他工作\"饿死\"的车道。']}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/react-reconciler/src/ReactFiberWorkLoop.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" ensureRootIsScheduled\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"FiberRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"number\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" existingCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 检查是否有任何车道被其他工作饿死。如果有，将它们标记为过期。\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  markStarvedLanesAsExpired\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ... [rest of the function]\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.ol,{start:\"2\",children:[\"\\n\",n(c.li,{children:n(c.strong,{children:\"计算过期时间\"})}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"对于每个待处理的车道，React会计算一个过期时间。这个过期时间根据车道的优先级而不同。\"}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/react-reconciler/src/ReactFiberLane.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" computeExpirationTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"lane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Lane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"number\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  switch\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" SyncLane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" InputContinuousLane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" + \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"250\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" DefaultLane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" TransitionLane1\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" TransitionLane16\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" + \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"5000\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // ... [other cases]\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.ol,{start:\"3\",children:[\"\\n\",n(c.li,{children:n(c.strong,{children:\"标记过期车道\"})}),\"\\n\"]}),\"\\n\",e(c.p,{children:[\"在后续的调度更新中，React会检查每个车道是否已经过期。如果过期，会在\",n(c.code,{children:\"root.expiredLanes\"}),\"上标记该车道。\"]}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/react-reconciler/src/ReactFiberLane.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"export\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" markStarvedLanesAsExpired\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"FiberRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"number\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"): \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"void\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" pendingLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"pendingLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" expirationTimes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"expirationTimes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"pendingLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" > \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"pickArbitraryLaneIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" lane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" << \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" expirationTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"expirationTimes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"];\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"expirationTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoTimestamp\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      expirationTimes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"computeExpirationTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"expirationTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <= \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"expiredLanes\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" |=\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" lane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    lanes\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" &=\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" ~\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.ol,{start:\"4\",children:[\"\\n\",n(c.li,{children:n(c.strong,{children:\"处理过期车道\"})}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"在执行更新时，React会检查是否有过期的车道。如果有，这些任务会被提升到同步优先级进行处理。\"}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/react-reconciler/src/ReactFiberWorkLoop.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" performConcurrentWorkOnRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" shouldTimeSlice\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" =\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    !\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"includesBlockingLane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") &&\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    !\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"includesExpiredLane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") &&\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"disableSchedulerTimeoutInWorkLoop\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" || !\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"didTimeout\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" exitStatus\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"shouldTimeSlice\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" ?\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" renderRootConcurrent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\":\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" renderRootSync\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"通过这种机制，React确保即使在有大量高优先级任务的情况下，低优先级任务最终也能得到执行，从而解决了饥饿问题。\"}),\"\\n\",e(c.h2,{id:\"6-任务队列与react的协调过程\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#6-任务队列与react的协调过程\",children:n(c.span,{className:\"icon icon-link\"})}),\"6. 任务队列与React的协调过程\"]}),\"\\n\",n(c.p,{children:\"任务队列不仅仅是一个独立的调度系统，它与React的协调过程紧密相连。在这个过程中，React的车道优先级（Lane Priority）和调度器的优先级（Scheduler Priority）扮演着重要角色。这两种优先级系统在实际应用中有着不同的作用和表现。\"}),\"\\n\",e(c.h3,{id:\"61-车道优先级lane-priority的实际应用\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#61-车道优先级lane-priority的实际应用\",children:n(c.span,{className:\"icon icon-link\"})}),\"6.1 车道优先级（Lane Priority）的实际应用\"]}),\"\\n\",n(c.p,{children:\"车道优先级主要用于React内部的更新调度。它允许React更细粒度地控制不同类型更新的优先级。例如：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[n(c.strong,{children:\"用户交互\"}),\"：如点击事件，通常被赋予高优先级车道。\"]}),\"\\n\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" Button\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"count\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"setCount\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" handleClick\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = () \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 这个更新会被分配高优先级车道\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    setCount\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"count\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" + \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"button\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\" onClick\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"=\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"handleClick\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Clicked \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"count\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" times</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"button\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.ol,{start:\"2\",children:[\"\\n\",e(c.li,{children:[n(c.strong,{children:\"数据获取\"}),\"：通常被赋予默认优先级车道。\"]}),\"\\n\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" DataFetcher\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"data\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"setData\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  useEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(() \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 这个更新会被分配默认优先级车道\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    fetchData\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"().\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"then\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"setData\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }, [])\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" data\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" ?\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"data\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"> \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\":\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Loading...</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.ol,{start:\"3\",children:[\"\\n\",e(c.li,{children:[n(c.strong,{children:\"后台计算\"}),\"：可以使用低优先级车道。\"]}),\"\\n\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" ExpensiveComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"result\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"setResult\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  useEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(() \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 使用 startTransition 将更新标记为低优先级\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    startTransition\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(() \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" computedResult\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"expensiveComputation\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      setResult\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"computedResult\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    })\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }, [])\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" result\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" ?\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"result\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"> \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\":\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Computing...</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.h3,{id:\"62-调度器优先级scheduler-priority的实际应用\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#62-调度器优先级scheduler-priority的实际应用\",children:n(c.span,{className:\"icon icon-link\"})}),\"6.2 调度器优先级（Scheduler Priority）的实际应用\"]}),\"\\n\",n(c.p,{children:\"调度器优先级主要用于决定任务在JavaScript运行时中的执行顺序。它直接影响到任务何时被执行，我写一下伪代码。\"}),\"\\n\",n(c.p,{children:\"例如：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[n(c.strong,{children:\"即时优先级\"}),\"：用于需要立即执行的任务，如动画或拖拽。\"]}),\"\\n\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" AnimatedComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"position\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"setPosition\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  useEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(() \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" animate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = () \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      Scheduler\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"unstable_runWithPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Scheduler\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"unstable_ImmediatePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", () \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"        setPosition\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"((\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"prev\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" prev\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" + \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      })\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      requestAnimationFrame\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"animate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    animate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }, [])\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\" style\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"=\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"{ \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"transform\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"`translateX(\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"${\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"position\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"px)`\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" }\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.ol,{start:\"2\",children:[\"\\n\",e(c.li,{children:[n(c.strong,{children:\"用户阻塞优先级\"}),\"：用于需要快速响应但不需要立即执行的任务，如文本输入。\"]}),\"\\n\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" SearchInput\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"query\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"setQuery\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"''\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" handleChange\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = (\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"e\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    Scheduler\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"unstable_runWithPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Scheduler\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"unstable_UserBlockingPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", () \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      setQuery\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"e\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"target\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"value\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    })\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"input\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\" value\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"=\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"query\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\" onChange\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"=\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"handleChange\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.ol,{start:\"3\",children:[\"\\n\",e(c.li,{children:[n(c.strong,{children:\"普通优先级\"}),\"：用于不需要立即响应的更新，如网络请求。\"]}),\"\\n\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" DataFetcher\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"data\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"setData\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  useEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(() \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    Scheduler\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"unstable_runWithPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Scheduler\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"unstable_NormalPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", () \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      fetchData\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"().\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"then\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"setData\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    })\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }, [])\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" data\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" ?\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"data\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"> \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\":\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Loading...</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"优先级在任务调度过程中起着关键作用。高优先级的任务（如用户输入）会中断低优先级的任务（如数据获取）。这是通过比较当前执行任务的优先级和新到来任务的优先级来实现的。\"}),\"\\n\",n(c.p,{children:n(c.strong,{children:\"File: packages/scheduler/src/Scheduler.js\"})}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" unstable_runWithPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"priorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"eventHandler\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  switch\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"priorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" ImmediatePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" UserBlockingPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" NormalPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" LowPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" IdlePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      break\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    default\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      priorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NormalPriority\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  var\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" previousPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentPriorityLevel\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  currentPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"priorityLevel\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  try\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" eventHandler\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"finally\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    currentPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"previousPriorityLevel\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个函数允许在特定优先级下运行一个事件处理器。它临时改变当前的优先级级别，执行处理器，然后恢复原来的优先级级别。这确保了高优先级的操作能够及时响应，而不会被低优先级的任务阻塞。\"}),\"\\n\",e(c.h3,{id:\"63-混合优先级\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#63-混合优先级\",children:n(c.span,{className:\"icon icon-link\"})}),\"6.3 混合优先级\"]}),\"\\n\",n(c.p,{children:\"例子：\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" ComplexComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"text\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"setText\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"''\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"list\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"setList\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"([])\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"isPending\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"startTransition\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useTransition\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" handleInputChange\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = (\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"e\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" newText\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"e\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"target\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"value\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 高优先级更新：立即更新输入框\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    setText\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newText\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 低优先级更新：在transition中更新列表\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    startTransition\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(() \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" newList\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"generateLargeList\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newText\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      setList\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newList\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    })\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"input\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\" value\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"=\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"text\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\" onChange\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"=\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"handleInputChange\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      {\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"isPending\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" ?\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"p\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Updating list...</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"p\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"> \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\":\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" null\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"ul\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        {\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"list\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"map\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"((\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"item\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"          <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"li\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\" key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"=\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"item\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"id\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"item\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"text\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"li\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"        ))\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      </\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"ul\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    </\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  )\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"在这个例子中：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"车道优先级\"}),\"：\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[\"输入框的更新（\",n(c.code,{children:\"setText\"}),\"）被赋予高优先级车道，因为它直接响应用户输入。\"]}),\"\\n\",e(c.li,{children:[\"列表的更新（\",n(c.code,{children:\"setList\"}),\"）被包裹在 \",n(c.code,{children:\"startTransition\"}),\" 中，被赋予低优先级车道，因为它是一个可能耗时的操作。\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"调度器优先级\"}),\"：\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[\"React 内部会将高优先级车道的更新（输入框）转换为调度器的高优先级（如 \",n(c.code,{children:\"UserBlockingPriority\"}),\"）。\"]}),\"\\n\",e(c.li,{children:[\"低优先级车道的更新（列表）会被转换为较低的调度器优先级（如 \",n(c.code,{children:\"NormalPriority\"}),\"）。\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"优先级协同工作\"}),\"：\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"当用户输入时，输入框会立即更新，提供即时反馈。\"}),\"\\n\",n(c.li,{children:\"同时，列表更新被标记为低优先级，允许 React 在主线程空闲时才进行处理。\"}),\"\\n\",n(c.li,{children:\"如果用户继续输入，新的高优先级更新（输入框）会中断正在进行的低优先级更新（列表），确保界面始终响应。\"}),\"\\n\",n(c.li,{children:\"当输入停止，React 会完成被中断的列表更新。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"状态管理\"}),\"：\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[n(c.code,{children:\"isPending\"}),\" 状态允许我们在低优先级更新进行时显示加载指示器，提升用户体验。\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.h3,{id:\"64-在源码实现中\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#64-在源码实现中\",children:n(c.span,{className:\"icon icon-link\"})}),\"6.4 在源码实现中\"]}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"车道优先级（Lane Priority）\"}),\":\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"在 React 的协调过程中使用。\"}),\"\\n\",n(c.li,{children:\"用于标记更新的紧急程度和重要性。\"}),\"\\n\",n(c.li,{children:\"决定了更新在 React 内部处理的顺序。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"调度器优先级（Scheduler Priority）\"}),\":\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"在 React 的调度器中使用。\"}),\"\\n\",n(c.li,{children:\"决定任务在 JavaScript 运行时中的执行顺序。\"}),\"\\n\",n(c.li,{children:\"控制任务何时被执行。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"任务管理\"}),\":\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"涉及车道优先级和调度器优先级。\"}),\"\\n\",n(c.li,{children:\"使用车道优先级来标记任务的重要性。\"}),\"\\n\",n(c.li,{children:\"将车道优先级转换为调度器优先级，以决定任务的执行顺序。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"协调过程\"}),\":\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"主要使用车道优先级。\"}),\"\\n\",n(c.li,{children:\"决定哪些更新应该被优先处理。\"}),\"\\n\",n(c.li,{children:\"在构建和比较 Fiber 树时考虑车道优先级。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"优先级转换\"}),\":\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"发生在任务被调度时。\"}),\"\\n\",n(c.li,{children:\"React 内部将车道优先级转换为调度器优先级。\"}),\"\\n\",n(c.li,{children:\"这个转换确保了 React 的内部优先级系统与调度器的优先级系统能够协同工作。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" ensureRootIsScheduled\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"FiberRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"number\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" existingCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 检查是否有任何车道被其他工作饿死。如果有，将它们标记为过期，以便我们知道下一步要处理它们。\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  markStarvedLanesAsExpired\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 确定下一个要处理的车道，以及它们的优先级。\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" nextLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"getNextLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgressRoot\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" ?\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" workInProgressRootRenderLanes\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" :\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" NoLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  );\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 如果没有需要处理的车道，取消现有的回调并返回\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"existingCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      cancelCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"existingCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoLane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 使用最高优先级的车道来表示回调的优先级\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" newCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"getHighestPriorityLane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 检查是否存在现有任务。我们可能可以重用它。\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" existingCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"existingCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 优先级没有改变。我们可以重用现有的任务。\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 如果存在现有的回调节点，取消它\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"existingCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" != \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    cancelCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"existingCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 调度一个新的回调\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" newCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"SyncLane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 特殊情况：同步React回调被调度在一个特殊的内部队列中\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    newCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"scheduleSyncCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      performSyncWorkOnRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"bind\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"),\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    );\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 将车道优先级转换为调度器优先级\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" schedulerPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"lanePriorityToSchedulerPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      newCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    );\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 使用调度器优先级调度新的回调\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    newCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"scheduleCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      schedulerPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      performConcurrentWorkOnRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"bind\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"),\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    );\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 更新根节点的回调优先级和回调节点\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newCallbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newCallbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个函数负责确保根Fiber节点被正确调度。它会检查是否有新的工作需要执行，并根据优先级创建或重用任务。\"}),\"\\n\",e(c.h3,{id:\"65-车道和优先级转换\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#65-车道和优先级转换\",children:n(c.span,{className:\"icon icon-link\"})}),\"6.5 车道和优先级转换\"]}),\"\\n\",e(c.p,{children:[\"在理解源码前，我们要再次加深这两种优先级的意义，\",n(c.code,{children:\"枯燥\"}),\"的理解源码\",n(c.code,{children:\"毫无意义\"}),\"。\"]}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:\"调度器优先级（Scheduler Priority）：\"}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"这是最终决定任务执行顺序的关键因素。\"}),\"\\n\",n(c.li,{children:\"它直接与 JavaScript 运行时交互，决定哪些任务应该先执行，哪些可以稍后执行。\"}),\"\\n\",n(c.li,{children:n(c.code,{children:'调度器优先级是 React 与底层 JavaScript 引擎通信的\"语言\"。'})}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:\"车道优先级（Lane Priority）：\"}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"这是 React 内部使用的一个更细粒度的优先级系统。\"}),\"\\n\",n(c.li,{children:\"它允许 React 更精确地表达不同类型更新的重要性和紧急程度。\"}),\"\\n\",n(c.li,{children:n(c.code,{children:'车道优先级可以看作是 React 的内部\"思考过程\"，用于决定不同更新的相对重要性。'})}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:\"优先级转换：\"}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"React 需要将其内部的车道优先级转换为调度器可以理解的优先级。\"}),\"\\n\",n(c.li,{children:n(c.code,{children:'这个转换过程可以看作是 React 的\"决策过程\"，将其内部的复杂优先级系统映射到调度器的相对简单的优先级系统上。'})}),\"\\n\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"export\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" lanePriorityToSchedulerPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"lanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"LanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"): \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"ReactPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  switch\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" SyncLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" SyncBatchedLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" ImmediatePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" InputDiscreteHydrationLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" InputDiscreteLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" InputContinuousHydrationLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" InputContinuousLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" UserBlockingPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" DefaultHydrationLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" DefaultLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" TransitionHydrationPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" TransitionPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" SelectiveHydrationLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" RetryLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" NormalPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" IdleHydrationLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" IdleLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" OffscreenLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" IdlePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" NoLanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" NoSchedulerPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    default\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      invariant\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#FFD493\"},children:\"        false\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#FFD493\"},children:\"        'Invalid update priority: %s. This is a bug in React.'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        lanePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      );\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个函数负责将React的车道优先级转换为调度器的优先级。这种转换关系如下：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",n(c.li,{children:\"同步优先级（Sync）对应调度器的立即优先级（Immediate）\"}),\"\\n\",n(c.li,{children:\"输入优先级（Input）对应用户阻塞优先级（UserBlocking）\"}),\"\\n\",n(c.li,{children:\"默认优先级（Default）和过渡优先级（Transition）对应普通优先级（Normal）\"}),\"\\n\",n(c.li,{children:\"空闲优先级（Idle）对应调度器的空闲优先级（Idle）\"}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"这种转换确保了React内部的优先级系统能够与调度器的优先级系统协同工作，从而实现更精细的任务调度。\"}),\"\\n\",e(c.h2,{id:\"7-任务队列与react并发模式\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#7-任务队列与react并发模式\",children:n(c.span,{className:\"icon icon-link\"})}),\"7. 任务队列与React并发模式\"]}),\"\\n\",e(c.p,{children:[\"在我们上述讲的所有内容都是达成 \",n(c.code,{children:\"并发模式\"}),\" 的拼图，首先我们需要抓住关键词 \",n(c.code,{children:\"并发模式\"}),\"，而不是实现 \",n(c.code,{children:\"并发\"}),\"，\",n(c.code,{children:\"JavaScript\"}),\" 是单线程的，传统意义上的并发（如多线程）是同时处理多个任务。\"]}),\"\\n\",e(c.h3,{id:\"71-并发本质\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#71-并发本质\",children:n(c.span,{className:\"icon icon-link\"})}),\"7.1 并发本质\"]}),\"\\n\",n(c.p,{children:\"它的本质是：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[n(c.strong,{children:\"交错执行\"}),\"：在单一线程上交错执行多个任务。\"]}),\"\\n\",e(c.li,{children:[n(c.strong,{children:\"优先级调度\"}),\"：根据任务的优先级决定执行顺序。\"]}),\"\\n\",e(c.li,{children:[n(c.strong,{children:\"可中断渲染\"}),\"：允许高优先级任务打断低优先级任务。\"]}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"想象你正在做一个大型拼图（低优先级任务，如渲染一个复杂列表），突然电话响了（高优先级任务，如用户输入）。在 React 的并发模式下：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",n(c.li,{children:\"你可以暂停拼图（中断渲染）。\"}),\"\\n\",n(c.li,{children:\"接听电话（处理高优先级任务）。\"}),\"\\n\",n(c.li,{children:\"通话结束后，继续拼图（恢复渲染）。\"}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"代码层面的实现：\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" workLoopConcurrent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && !\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"shouldYield\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    performUnitOfWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" shouldYield\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    getCurrentTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() >= \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"deadline\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" || \"}),n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 时间片用完\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    hasHigherPriorityWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() \"}),n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 有更高优先级的工作\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  )\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:[\"这里的 \",n(c.code,{children:\"shouldYield()\"}),\" 函数检查是否应该让出控制权。如果时间片用完或有更高优先级的工作，React 就会暂停当前任务。\"]}),\"\\n\",e(c.h3,{id:\"72-为什么这也算是并发\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#72-为什么这也算是并发\",children:n(c.span,{className:\"icon icon-link\"})}),'7.2 为什么这也算是\"并发\"？']}),\"\\n\",n(c.p,{children:\"React的任务管理机制、任务中断恢复和车道协调共同构成了实现伪并发的核心框架。\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"多任务交错执行\"}),\"：尽管在任何给定时刻只有一个任务在执行，但从宏观角度看，多个任务是交错进行的。这种交错执行创造了任务并行的错觉，类似于操作系统的时间片轮转调度。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"非阻塞\"}),\"：低优先级任务不会阻塞高优先级任务的执行。这确保了重要的用户交互和更新能够及时响应，提高了应用的整体响应性。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"响应式\"}),\"：系统能够快速响应用户交互，即使在处理大量后台工作时也是如此。这种能力模拟了真正并发系统的行为，多个处理单元同时处理不同的任务。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"公平调度\"}),\"：所有任务最终都会得到处理，只是执行顺序根据优先级动态调整。这种调度策略确保了资源的公平分配，避免了任务饥饿问题。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"细粒度控制\"}),\"：通过车道优先级系统，React能够对任务进行更细粒度的控制，实现了类似于抢占式多任务处理的效果。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"异步渲染\"}),'：React的并发模式支持异步渲染，允许组件\"暂停\"渲染等待数据，这种能力进一步增强了并发的特性。']}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.p,{children:[\"总的来说，虽然React的 \",n(c.code,{children:\"并发模式\"}),\" 在技术实现上与传统的多线程并发有所不同，但它在功能和效果上实现了类似的目标：提高系统的响应性、优化资源利用、平衡多个任务的执行。\"]}),\"\\n\",e(c.p,{children:[\"这就是 \",n(c.code,{children:\"react\"}),\" 的核心。\"]}),\"\\n\",e(c.h2,{id:\"8-总结\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#8-总结\",children:n(c.span,{className:\"icon icon-link\"})}),\"8. 总结\"]}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"灵活的优先级系统\"}),\"：React使用多级优先级系统，能够精确控制不同类型任务的执行顺序，确保重要的更新能够及时响应。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"高效的数据结构\"}),\"：使用小顶堆实现的优先级队列，保证了任务的快速插入和获取，时间复杂度为O(log n)。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"可中断的执行模型\"}),\"：通过时间切片和yield机制，React能够在长任务执行过程中适时让出主线程，保证页面的响应性。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"与React核心的紧密集成\"}),\"：任务队列与React的协调过程、Lanes系统等核心概念紧密结合，支持了并发模式等高级特性。\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"性能优化\"}),\"：通过批量更新、延迟任务处理等机制，任务队列在保证功能的同时也兼顾了性能。\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"其实看这些源码，都是为了写出更高效、更流畅的React应用。\"}),\"\\n\",n(c.p,{children:\"平时大家是靠感觉来使用这些优化手段，那么在理解这个任务队列和调度之后，会让我们心里更有底，也是知其所也然了。\"})]})}return{default:function(l={}){const{wrapper:e}=l.components||{};return e?n(e,{...l,children:n(_createMdxContent,{...l})}):_createMdxContent(l)}};",
    "toc": {
      "content": [
        {
          "title": "1. React Fiber架构：深入解析任务队列、可中断渲染、调度、同步模式",
          "url": "#1-react-fiber架构深入解析任务队列可中断渲染调度同步模式",
          "items": []
        },
        {
          "title": "2. 任务队列的概念和作用",
          "url": "#2-任务队列的概念和作用",
          "items": [
            {
              "title": "2.1 什么是任务队列？",
              "url": "#21-什么是任务队列",
              "items": []
            },
            {
              "title": "2.2 任务队列的作用",
              "url": "#22-任务队列的作用",
              "items": []
            }
          ]
        },
        {
          "title": "3. React源码中的任务队列实现",
          "url": "#3-react源码中的任务队列实现",
          "items": [
            {
              "title": "3.1 数据结构",
              "url": "#31-数据结构",
              "items": []
            },
            {
              "title": "3.2 任务的表示",
              "url": "#32-任务的表示",
              "items": []
            },
            {
              "title": "3.3 优先级的定义",
              "url": "#33-优先级的定义",
              "items": []
            }
          ]
        },
        {
          "title": "4. 任务队列的创建过程",
          "url": "#4-任务队列的创建过程",
          "items": [
            {
              "title": "4.1 初始化",
              "url": "#41-初始化",
              "items": []
            },
            {
              "title": "4.2 添加任务",
              "url": "#42-添加任务",
              "items": []
            },
            {
              "title": "4.3 任务排序",
              "url": "#43-任务排序",
              "items": []
            }
          ]
        },
        {
          "title": "5. 任务队列的调度过程",
          "url": "#5-任务队列的调度过程",
          "items": [
            {
              "title": "5.1 调度器的初始化",
              "url": "#51-调度器的初始化",
              "items": []
            },
            {
              "title": "5.2 任务执行",
              "url": "#52-任务执行",
              "items": []
            },
            {
              "title": "5.3 任务中断与恢复",
              "url": "#53-任务中断与恢复",
              "items": [
                {
                  "title": "5.3.1 shouldYieldToHost 函数",
                  "url": "#531-shouldyieldtohost-函数",
                  "items": []
                },
                {
                  "title": "5.3.2 任务中断和恢复的实现",
                  "url": "#532-任务中断和恢复的实现",
                  "items": []
                },
                {
                  "title": "5.3.3 优先级管理和任务切换",
                  "url": "#533-优先级管理和任务切换",
                  "items": []
                }
              ]
            },
            {
              "title": "5.4 优先级管理和饥饿问题的解决",
              "url": "#54-优先级管理和饥饿问题的解决",
              "items": []
            }
          ]
        },
        {
          "title": "6. 任务队列与React的协调过程",
          "url": "#6-任务队列与react的协调过程",
          "items": [
            {
              "title": "6.1 车道优先级（Lane Priority）的实际应用",
              "url": "#61-车道优先级lane-priority的实际应用",
              "items": []
            },
            {
              "title": "6.2 调度器优先级（Scheduler Priority）的实际应用",
              "url": "#62-调度器优先级scheduler-priority的实际应用",
              "items": []
            },
            {
              "title": "6.3 混合优先级",
              "url": "#63-混合优先级",
              "items": []
            },
            {
              "title": "6.4 在源码实现中",
              "url": "#64-在源码实现中",
              "items": []
            },
            {
              "title": "6.5 车道和优先级转换",
              "url": "#65-车道和优先级转换",
              "items": []
            }
          ]
        },
        {
          "title": "7. 任务队列与React并发模式",
          "url": "#7-任务队列与react并发模式",
          "items": [
            {
              "title": "7.1 并发本质",
              "url": "#71-并发本质",
              "items": []
            },
            {
              "title": "7.2 为什么这也算是\"并发\"？",
              "url": "#72-为什么这也算是并发",
              "items": []
            }
          ]
        },
        {
          "title": "8. 总结",
          "url": "#8-总结",
          "items": []
        }
      ],
      "visible": true
    },
    "slugAsParams": "3.react_task_queue"
  },
  {
    "slug": "/content/react-source-code/4.fiber-structure",
    "title": "4.React Fiber架构:链表、Fiber节点与Fiber树",
    "description": "深入解析React Fiber架构的核心概念,包括链表基础、Fiber节点结构、Fiber树的构建以及双缓冲更新机制。",
    "published": true,
    "date": "2023-01-08T00:00:00.000Z",
    "body": "const{Fragment:l,jsx:n,jsxs:e}=arguments[0];function _createMdxContent(r){const c={a:\"a\",code:\"code\",figure:\"figure\",h1:\"h1\",h2:\"h2\",h3:\"h3\",h4:\"h4\",li:\"li\",ol:\"ol\",p:\"p\",pre:\"pre\",span:\"span\",strong:\"strong\",ul:\"ul\",...r.components};return e(l,{children:[e(c.h1,{id:\"4react-fiber架构链表fiber节点与fiber树\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#4react-fiber架构链表fiber节点与fiber树\",children:n(c.span,{className:\"icon icon-link\"})}),\"4.React Fiber架构:链表、Fiber节点与Fiber树\"]}),\"\\n\",n(c.p,{children:\"React Fiber是React的核心架构,它基于链表结构组织和管理组件树。本文将从链表基础开始,逐步深入探讨Fiber节点、Fiber树和双缓冲机制,以及它们之间的关系。\"}),\"\\n\",e(c.h2,{id:\"1-链表基础\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#1-链表基础\",children:n(c.span,{className:\"icon icon-link\"})}),\"1. 链表基础\"]}),\"\\n\",n(c.p,{children:\"在深入Fiber架构之前,我们需要先理解链表这一基础数据结构。链表是由一系列节点组成的线性集合,每个节点包含数据和指向下一个节点的指针。\"}),\"\\n\",e(c.h3,{id:\"11-链表的基本操作及复杂度分析\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#11-链表的基本操作及复杂度分析\",children:n(c.span,{className:\"icon icon-link\"})}),\"1.1 链表的基本操作及复杂度分析\"]}),\"\\n\",n(c.p,{children:\"以下是链表的基本操作实现及其时间复杂度分析:\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"class\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" Node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  constructor\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"data\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"    this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"data\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"data\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"    this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"class\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" LinkedList\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  constructor\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"    this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"head\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 在链表末尾添加节点 - O(n)\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  append\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"data\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" newNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"new\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" Node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"data\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (!\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"head\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"      this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"head\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newNode\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"head\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newNode\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 在链表开头插入节点 - O(1)\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  prepend\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"data\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" newNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"new\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" Node\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"data\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    newNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"head\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"    this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"head\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newNode\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 删除指定数据的节点 - O(n)\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  delete\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"data\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (!\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"head\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"return\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"head\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"data\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"data\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"      this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"head\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"head\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"head\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"data\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"data\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#54B9FF\"},children:\"        return\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 遍历链表 - O(n)\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  traverse\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"head\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      console\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"log\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"data\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"复杂度分析:\"}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[\"插入操作:\",\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"在头部插入(prepend): O(1)\"}),\"\\n\",n(c.li,{children:\"在尾部插入(append): O(n)\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(c.li,{children:\"删除操作: 平均O(n)\"}),\"\\n\",n(c.li,{children:\"查找操作: O(n)\"}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"链表的主要优势在于插入和删除操作的灵活性,特别是在已知位置的插入和删除可以达到O(1)的时间复杂度。\"}),\"\\n\",e(c.h2,{id:\"2-fiber节点结构\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#2-fiber节点结构\",children:n(c.span,{className:\"icon icon-link\"})}),\"2. Fiber节点结构\"]}),\"\\n\",n(c.p,{children:\"Fiber节点是React内部用来表示组件的核心数据结构。每个Fiber节点对应一个React元素,包含了该元素的类型、属性、状态等信息。Fiber节点构成了一个双向链表树结构,这种结构允许React实现可中断的渲染过程。\"}),\"\\n\",e(c.h3,{id:\"21-fiber节点的完整结构\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#21-fiber节点的完整结构\",children:n(c.span,{className:\"icon icon-link\"})}),\"2.1 Fiber节点的完整结构\"]}),\"\\n\",n(c.p,{children:\"以下是Fiber节点的完整结构:\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" FiberNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"WorkTag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  pendingProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"mixed\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": null | \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"string\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  mode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"TypeOfMode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // Instance\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"elementType\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"stateNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // Fiber\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"ref\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"pendingProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"pendingProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"memoizedProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"updateQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"memoizedState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"dependencies\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"mode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"mode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // Effects\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoFlags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"subtreeFlags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoFlags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"deletions\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"childLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#ACAFFF\"},children:\"  this\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ... 性能计时相关代码（省略）\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ... 开发环境相关代码（省略）\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.h3,{id:\"22-fiber节点属性解释\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#22-fiber节点属性解释\",children:n(c.span,{className:\"icon icon-link\"})}),\"2.2 Fiber节点属性解释\"]}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:n(c.strong,{children:\"Instance 相关\"})}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[n(c.code,{children:\"tag\"}),\": 标识 Fiber 节点类型（如函数组件、类组件、原生 DOM 等）\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"key\"}),\": 用于优化更新过程的唯一标识符\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"elementType\"}),\": 元素的类型（如对于 DOM 元素是字符串，对于组件是函数或类）\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"type\"}),\": 与 elementType 类似，但可能会被特殊处理（如在懒加载时）\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"stateNode\"}),\": 保存与 Fiber 相关的本地状态（如对于 DOM 元素，它是实际的 DOM 节点）\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:n(c.strong,{children:\"Fiber 树结构\"})}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[n(c.code,{children:\"return\"}),\": 指向父 Fiber 节点\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"child\"}),\": 指向第一个子 Fiber 节点\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"sibling\"}),\": 指向下一个兄弟 Fiber 节点\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"index\"}),\": 在父节点的子节点列表中的索引\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:n(c.strong,{children:\"数据相关\"})}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[n(c.code,{children:\"ref\"}),\": 如果元素定义了 ref，这里存储 ref 的值\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"pendingProps\"}),\": 新的待处理的 props\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"memoizedProps\"}),\": 上一次渲染时的 props\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"updateQueue\"}),\": 存储状态更新的队列\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"memoizedState\"}),\": 上一次渲染时的 state\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"dependencies\"}),\": 依赖项（如 context、事件等）\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:n(c.strong,{children:\"模式与副作用\"})}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[n(c.code,{children:\"mode\"}),\": 标识当前 Fiber 树的渲染模式（如 Concurrent、Strict 等）\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"flags\"}),\": 标记需要执行的副作用（如需要插入、更新、删除等）\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"subtreeFlags\"}),\": 子树中的副作用标记\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"deletions\"}),\": 需要删除的子节点列表\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:n(c.strong,{children:\"调度相关\"})}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[n(c.code,{children:\"lanes\"}),\": 表示更新的优先级\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"childLanes\"}),\": 子树中的优先级\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",n(c.p,{children:n(c.strong,{children:\"其他\"})}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[n(c.code,{children:\"alternate\"}),\": 指向内存中的另一个 Fiber，用于双缓冲\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.h3,{id:\"23-创建fiber节点的源码\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#23-创建fiber节点的源码\",children:n(c.span,{className:\"icon icon-link\"})}),\"2.3 创建Fiber节点的源码\"]}),\"\\n\",e(c.p,{children:[\"React 使用 \",n(c.code,{children:\"createFiberFromElement\"}),\" 函数来创建 Fiber 节点:\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" createFiberFromElement\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"ReactElement\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"mode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"TypeOfMode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"): \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" owner\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"__DEV__\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    owner\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"_owner\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" pendingProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"props\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"createFiberFromTypeAndProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    pendingProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    owner\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    mode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  );\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"__DEV__\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"_debugSource\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"_source\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"_debugOwner\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"_owner\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个函数根据 React 元素创建对应的 Fiber 节点,处理元素的类型、key、props 等信息,并创建一个新的 Fiber 对象。\"}),\"\\n\",e(c.h3,{id:\"24-深入理解react元素\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#24-深入理解react元素\",children:n(c.span,{className:\"icon icon-link\"})}),\"2.4 深入理解React元素\"]}),\"\\n\",n(c.p,{children:\"React元素是描述UI中一部分的普通JavaScript对象。它们是React应用的最小构建块,用于表示界面上应该渲染的内容。\"}),\"\\n\",e(c.h4,{id:\"241-react元素的结构\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#241-react元素的结构\",children:n(c.span,{className:\"icon icon-link\"})}),\"2.4.1 React元素的结构\"]}),\"\\n\",n(c.p,{children:\"一个典型的React元素对象结构如下:\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'div'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  props\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    className\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'container'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    children\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": [\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      { \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'h1'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"props\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": { \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"children\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'Hello, World!'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" } },\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      { \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'p'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"props\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": { \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"children\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'This is a paragraph.'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" } }\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    ]\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  },\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  ref\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  $$typeof\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Symbol\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"for\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'react.element'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"),\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  _owner\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  _store\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": {}\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.h4,{id:\"242-react元素的主要属性\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#242-react元素的主要属性\",children:n(c.span,{className:\"icon icon-link\"})}),\"2.4.2 React元素的主要属性\"]}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.code,{children:\"type\"}),\": 指定了React元素的类型。它可以是:\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"字符串(如 'div', 'span')表示原生DOM元素\"}),\"\\n\",n(c.li,{children:\"函数或类表示自定义React组件\"}),\"\\n\",n(c.li,{children:\"React内置组件(如React.Fragment)\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.code,{children:\"props\"}),\": 包含了传递给组件的所有属性,包括:\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"常规属性(如className, style等)\"}),\"\\n\",n(c.li,{children:\"特殊属性children,表示子元素\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.code,{children:\"key\"}),\": 用于在列表中唯一标识元素,帮助React高效地更新DOM\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.code,{children:\"ref\"}),\": 用于获取对DOM节点或组件实例的引用\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.code,{children:\"$$typeof\"}),\": 一个Symbol,用于标识这是一个React元素,防止XSS攻击\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.code,{children:\"_owner\"}),\": 内部使用,指向创建该元素的组件\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.h4,{id:\"243-创建react元素\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#243-创建react元素\",children:n(c.span,{className:\"icon icon-link\"})}),\"2.4.3 创建React元素\"]}),\"\\n\",n(c.p,{children:\"通常,我们使用JSX来创建React元素:\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = (\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\" className\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"=\"}),n(c.span,{style:{color:\"#FFD493\"},children:'\"container\"'}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"h1\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Hello, World!</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"h1\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"p\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">This is a paragraph.</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"p\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  </\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})})]})})}),\"\\n\",e(c.p,{children:[\"JSX会被Babel等工具转译为\",n(c.code,{children:\"React.createElement()\"}),\"调用:\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"React\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"createElement\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#FFD493\"},children:\"  'div'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  { \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"className\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'container'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" },\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  React\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"createElement\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'h1'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'Hello, World!'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"),\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  React\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"createElement\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'p'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'This is a paragraph.'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})})]})})}),\"\\n\",e(c.h4,{id:\"244-react元素与fiber节点的关系\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#244-react元素与fiber节点的关系\",children:n(c.span,{className:\"icon icon-link\"})}),\"2.4.4 React元素与Fiber节点的关系\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"React元素是描述UI的静态结构,而Fiber节点是React内部用于管理组件树和执行更新的动态数据结构。\"}),\"\\n\",n(c.li,{children:\"每个React元素最终都会对应到一个Fiber节点。\"}),\"\\n\"]}),\"\\n\",e(c.h2,{id:\"3-fiber树结构\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#3-fiber树结构\",children:n(c.span,{className:\"icon icon-link\"})}),\"3. Fiber树结构\"]}),\"\\n\",n(c.p,{children:\"Fiber树是由Fiber节点构成的树形结构,它反映了React组件的层次关系。Fiber树使用三个主要指针构建链表结构:\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[n(c.code,{children:\"child\"}),\": 指向第一个子节点\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"sibling\"}),\": 指向下一个兄弟节点\"]}),\"\\n\",e(c.li,{children:[n(c.code,{children:\"return\"}),\": 指向父节点\"]}),\"\\n\"]}),\"\\n\",e(c.h3,{id:\"31-fiber树的构建过程\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#31-fiber树的构建过程\",children:n(c.span,{className:\"icon icon-link\"})}),\"3.1 Fiber树的构建过程\"]}),\"\\n\",n(c.p,{children:\"以下是一个简化的Fiber树构建过程:\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" createFiberFromElement\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" { \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"props\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" } = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"new\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" FiberNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"getFiberTag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"), \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"props\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoMode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" fiber\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" reconcileChildrenArray\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"currentFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"newChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" prevSibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentFirstChild\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  for\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (; \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"length\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"; \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"++) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"]\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"shouldTrackSideEffects\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && !\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"sameNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      deleteChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sibling\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"createFiberFromElement\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newFiber\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      prevSibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newFiber\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    prevSibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newFiber\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.h3,{id:\"32-实际代码例子\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#32-实际代码例子\",children:n(c.span,{className:\"icon icon-link\"})}),\"3.2 实际代码例子\"]}),\"\\n\",n(c.p,{children:\"考虑以下React组件结构:\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" App\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Header\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Main\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"        <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Article\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"        <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Sidebar\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      </\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Main\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Footer\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    </\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  )\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"对应的Fiber树结构可能如下:\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" AppFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"FunctionComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"App\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"DivFiber\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...其他属性\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" DivFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"HostComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'div'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"AppFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"HeaderFiber\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...其他属性\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" HeaderFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"FunctionComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Header\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"DivFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"MainFiber\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...其他属性\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" MainFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"FunctionComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Main\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"DivFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"ArticleFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"FooterFiber\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...其他属性\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" ArticleFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"FunctionComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Article\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"MainFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"SidebarFiber\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...其他属性\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" SidebarFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"FunctionComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Sidebar\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"MainFiber\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...其他属性\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" FooterFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"FunctionComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Footer\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"DivFiber\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...其他属性\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:[\"这个例子展示了Fiber节点如何通过\",n(c.code,{children:\"child\"}),\"、\",n(c.code,{children:\"sibling\"}),\"和\",n(c.code,{children:\"return\"}),\"指针相互连接,形成一个完整的树结构。\"]}),\"\\n\",e(c.h2,{id:\"4-双缓冲机制\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#4-双缓冲机制\",children:n(c.span,{className:\"icon icon-link\"})}),\"4. 双缓冲机制\"]}),\"\\n\",n(c.p,{children:\"React Fiber 架构中的双缓冲机制是优化渲染性能的关键策略。\"}),\"\\n\",e(c.h3,{id:\"41-双缓冲的核心概念\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#41-双缓冲的核心概念\",children:n(c.span,{className:\"icon icon-link\"})}),\"4.1 双缓冲的核心概念\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[n(c.strong,{children:\"current 树\"}),\": 当前在屏幕上显示的 UI 对应的 Fiber 树。\"]}),\"\\n\",e(c.li,{children:[n(c.strong,{children:\"workInProgress 树\"}),\": 用于构建下一个状态的 Fiber 树。\"]}),\"\\n\"]}),\"\\n\",e(c.p,{children:[\"每个 Fiber 节点都有一个 \",n(c.code,{children:\"alternate\"}),\" 属性，指向另一棵树中对应的节点。\"]}),\"\\n\",e(c.h3,{id:\"42-双缓冲的创建和更新流程\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#42-双缓冲的创建和更新流程\",children:n(c.span,{className:\"icon icon-link\"})}),\"4.2 双缓冲的创建和更新流程\"]}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"初始渲染\"}),\":\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"React 创建 current 树。\"}),\"\\n\",n(c.li,{children:\"同时创建一个对应的 workInProgress 树，但不使用。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"更新过程\"}),\":\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"当有更新时，React 不会创建新的 workInProgress 树。\"}),\"\\n\",n(c.li,{children:\"而是重用已存在的 workInProgress 树，基于 current 树进行更新。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"树的切换\"}),\":\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"更新完成后，workInProgress 树变为新的 current 树。\"}),\"\\n\",n(c.li,{children:\"原来的 current 树变为新的 workInProgress 树，等待下次更新。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.h3,{id:\"43-源码实现\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#43-源码实现\",children:n(c.span,{className:\"icon icon-link\"})}),\"4.3 源码实现\"]}),\"\\n\",e(c.p,{children:[\"React 中的 \",n(c.code,{children:\"createWorkInProgress\"}),\" 函数展示了这一机制：\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" createWorkInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"pendingProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"any\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"): \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 首次渲染时创建 workInProgress\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"createFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      pendingProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"mode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    );\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"elementType\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"elementType\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"stateNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"stateNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 后续更新时重用已存在的 workInProgress\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"pendingProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"pendingProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoFlags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // ... 重置其他属性\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 复制必要的属性\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"memoizedProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"memoizedProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"memoizedState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"memoizedState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"updateQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"updateQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ... 复制其他属性\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.h3,{id:\"44-实际例子局部替换和双缓存\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#44-实际例子局部替换和双缓存\",children:n(c.span,{className:\"icon icon-link\"})}),\"4.4 实际例子：局部替换和双缓存\"]}),\"\\n\",n(c.p,{children:\"让我们通过一个具体的例子来说明 React 如何使用双缓存和局部替换来更新 UI。\"}),\"\\n\",n(c.p,{children:\"假设我们有以下组件结构：\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"jsx\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"jsx\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" App\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"count\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"setCount\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"] = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Header\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Main\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\" count\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"=\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"count\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Footer\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" />\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    </\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  )\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" Main\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"({ \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"count\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" }) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"h2\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Count: \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"count\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"h2\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      <\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"button\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\" onClick\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"=\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"{\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" setCount\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"count\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" + \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"}\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">Increment</\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"button\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    </\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"div\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  )\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"初始渲染后，Fiber 树结构可能如下：\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// current 树\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" currentRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"HostRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"FunctionComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"App\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"HostComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'div'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"FunctionComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Header\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"          tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"FunctionComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"          type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Main\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"          memoizedState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": { \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"count\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" },\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"          sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"            tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"FunctionComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"            type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Footer\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"          }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"        }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// workInProgress 树（初始为 null）\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" workInProgressRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"})]})]})})}),\"\\n\",n(c.p,{children:'当用户点击 \"Increment\" 按钮时，React 会触发更新。这时，React 会创建或重用 workInProgress 树：'}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 更新过程中的 workInProgress 树\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgressRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"HostRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"FunctionComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"App\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"HostComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'div'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"FunctionComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Header\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"          tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"FunctionComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"          type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Main\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"          memoizedState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": { \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"count\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"1\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" }, \"}),n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 注意这里的状态更新\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"          sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"            tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"FunctionComponent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"            type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Footer\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"          }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"        }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"在这个过程中，React 只需要更新 Main 组件对应的 Fiber 节点，其他节点可以直接复用 current 树中的节点。这就是局部替换的体现。\"}),\"\\n\",n(c.p,{children:\"更新完成后，React 会交换 current 和 workInProgress 的引用：\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 交换引用\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" temp\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentRoot\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgressRoot\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgressRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"temp\"})]})]})})}),\"\\n\",n(c.p,{children:\"这样，新的 current 树就反映了更新后的 UI 状态，而旧的 current 树成为了新的 workInProgress 树，等待下一次更新。\"}),\"\\n\",n(c.p,{children:\"这个例子展示了 React 如何通过双缓存机制和局部替换来高效地管理更新。它只修改必要的部分，复用大部分现有结构。\"})]})}return{default:function(l={}){const{wrapper:e}=l.components||{};return e?n(e,{...l,children:n(_createMdxContent,{...l})}):_createMdxContent(l)}};",
    "toc": {
      "content": [
        {
          "title": "4.React Fiber架构:链表、Fiber节点与Fiber树",
          "url": "#4react-fiber架构链表fiber节点与fiber树",
          "items": [
            {
              "title": "1. 链表基础",
              "url": "#1-链表基础",
              "items": [
                {
                  "title": "1.1 链表的基本操作及复杂度分析",
                  "url": "#11-链表的基本操作及复杂度分析",
                  "items": []
                }
              ]
            },
            {
              "title": "2. Fiber节点结构",
              "url": "#2-fiber节点结构",
              "items": [
                {
                  "title": "2.1 Fiber节点的完整结构",
                  "url": "#21-fiber节点的完整结构",
                  "items": []
                },
                {
                  "title": "2.2 Fiber节点属性解释",
                  "url": "#22-fiber节点属性解释",
                  "items": []
                },
                {
                  "title": "2.3 创建Fiber节点的源码",
                  "url": "#23-创建fiber节点的源码",
                  "items": []
                },
                {
                  "title": "2.4 深入理解React元素",
                  "url": "#24-深入理解react元素",
                  "items": [
                    {
                      "title": "2.4.1 React元素的结构",
                      "url": "#241-react元素的结构",
                      "items": []
                    },
                    {
                      "title": "2.4.2 React元素的主要属性",
                      "url": "#242-react元素的主要属性",
                      "items": []
                    },
                    {
                      "title": "2.4.3 创建React元素",
                      "url": "#243-创建react元素",
                      "items": []
                    },
                    {
                      "title": "2.4.4 React元素与Fiber节点的关系",
                      "url": "#244-react元素与fiber节点的关系",
                      "items": []
                    }
                  ]
                }
              ]
            },
            {
              "title": "3. Fiber树结构",
              "url": "#3-fiber树结构",
              "items": [
                {
                  "title": "3.1 Fiber树的构建过程",
                  "url": "#31-fiber树的构建过程",
                  "items": []
                },
                {
                  "title": "3.2 实际代码例子",
                  "url": "#32-实际代码例子",
                  "items": []
                }
              ]
            },
            {
              "title": "4. 双缓冲机制",
              "url": "#4-双缓冲机制",
              "items": [
                {
                  "title": "4.1 双缓冲的核心概念",
                  "url": "#41-双缓冲的核心概念",
                  "items": []
                },
                {
                  "title": "4.2 双缓冲的创建和更新流程",
                  "url": "#42-双缓冲的创建和更新流程",
                  "items": []
                },
                {
                  "title": "4.3 源码实现",
                  "url": "#43-源码实现",
                  "items": []
                },
                {
                  "title": "4.4 实际例子：局部替换和双缓存",
                  "url": "#44-实际例子局部替换和双缓存",
                  "items": []
                }
              ]
            }
          ]
        }
      ],
      "visible": true
    },
    "slugAsParams": "4.fiber-structure"
  },
  {
    "slug": "/content/react-source-code/5.fiber-commit",
    "title": "5. React Fiber架构：React Fiber对象的创建、更新、提交",
    "description": "深入探讨React Fiber架构中Fiber对象的创建过程、初始化提交以及Fiber树的更新机制,揭示React内部工作原理。",
    "published": true,
    "date": "2023-03-09T00:00:00.000Z",
    "body": "const{Fragment:l,jsx:n,jsxs:e}=arguments[0];function _createMdxContent(r){const c={a:\"a\",code:\"code\",figure:\"figure\",h1:\"h1\",h2:\"h2\",h3:\"h3\",h4:\"h4\",li:\"li\",ol:\"ol\",p:\"p\",pre:\"pre\",span:\"span\",strong:\"strong\",ul:\"ul\",...r.components};return e(l,{children:[e(c.h1,{id:\"react-fiber架构react-fiber对象的创建更新提交\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#react-fiber架构react-fiber对象的创建更新提交\",children:n(c.span,{className:\"icon icon-link\"})}),\"React Fiber架构：React Fiber对象的创建、更新、提交\"]}),\"\\n\",n(c.p,{children:\"在上一篇文章中，我们详细讨论了Fiber的整体结构和链表。本文将深入探讨Fiber对象的创建过程、初始化提交以及Fiber树的更新机制。\"}),\"\\n\",e(c.h2,{id:\"1-创建fiber对象\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#1-创建fiber对象\",children:n(c.span,{className:\"icon icon-link\"})}),\"1. 创建Fiber对象\"]}),\"\\n\",e(c.p,{children:[\"Fiber对象的创建是React渲染过程的起点。当我们调用\",n(c.code,{children:\"ReactDOM.createRoot().render()\"}),\"时，React开始创建Fiber树。\"]}),\"\\n\",e(c.h3,{id:\"11-创建rootfiber\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#11-创建rootfiber\",children:n(c.span,{className:\"icon icon-link\"})}),\"1.1 创建RootFiber\"]}),\"\\n\",n(c.p,{children:\"首先，React会创建一个RootFiber，它是整个Fiber树的根节点。\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" createFiberRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"containerInfo\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"hydrate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"hydrationCallbacks\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"new\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" FiberRootNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"containerInfo\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"hydrate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" uninitializedFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"createHostRootFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"uninitializedFiber\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  uninitializedFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"stateNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  initializeUpdateQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"uninitializedFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" root\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" createHostRootFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" mode\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"ConcurrentRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    mode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"ConcurrentMode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"BlockingMode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"StrictMode\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"BlockingRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    mode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"BlockingMode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"StrictMode\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    mode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoMode\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" createFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"HostRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"mode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个过程创建了FiberRoot和RootFiber。FiberRoot是整个应用的起点，而RootFiber则是组件树的根节点。\"}),\"\\n\",e(c.h3,{id:\"12-创建子fiber节点\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#12-创建子fiber节点\",children:n(c.span,{className:\"icon icon-link\"})}),\"1.2 创建子Fiber节点\"]}),\"\\n\",e(c.p,{children:[\"接下来，React会根据组件树递归地创建子Fiber节点。这个过程发生在\",n(c.code,{children:\"reconcileChildren\"}),\"函数中：\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" reconcileChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"nextChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"renderLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 如果是首次渲染，使用 mountChildFibers\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"mountChildFibers\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"renderLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 如果是更新，使用 reconcileChildFibers\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"reconcileChildFibers\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"renderLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:[n(c.code,{children:\"mountChildFibers\"}),\"和\",n(c.code,{children:\"reconcileChildFibers\"}),\"都是\",n(c.code,{children:\"ChildReconciler\"}),\"函数的返回值，它们的区别在于是否标记副作用。\"]}),\"\\n\",e(c.h3,{id:\"13-创建单个fiber节点\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#13-创建单个fiber节点\",children:n(c.span,{className:\"icon icon-link\"})}),\"1.3 创建单个Fiber节点\"]}),\"\\n\",e(c.p,{children:[\"创建单个Fiber节点的核心逻辑在\",n(c.code,{children:\"createFiberFromElement\"}),\"函数中：\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" createFiberFromElement\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"mode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" owner\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"key\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" pendingProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"props\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"createFiberFromTypeAndProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"pendingProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"owner\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"mode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" fiber\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" createFiberFromTypeAndProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"pendingProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"owner\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"mode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" fiberTag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"IndeterminateComponent\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 根据组件类型确定 fiberTag\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'function'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"shouldConstruct\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      fiberTag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"ClassComponent\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'string'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    fiberTag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"HostComponent\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"createFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"fiberTag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"pendingProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"mode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"elementType\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" fiber\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个过程根据React元素的类型、key和props创建对应的Fiber节点。\"}),\"\\n\",e(c.h2,{id:\"2-初始化提交\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#2-初始化提交\",children:n(c.span,{className:\"icon icon-link\"})}),\"2. 初始化提交\"]}),\"\\n\",n(c.p,{children:'创建完Fiber树后，React需要将这些虚拟的Fiber节点渲染到实际的DOM中。这个过程称为\"提交\"(commit)。'}),\"\\n\",e(c.h3,{id:\"21-提交前的准备\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#21-提交前的准备\",children:n(c.span,{className:\"icon icon-link\"})}),\"2.1 提交前的准备\"]}),\"\\n\",n(c.p,{children:\"在进入提交阶段之前，React会做一些准备工作：\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" commitRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" renderPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"getCurrentPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  runWithPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"ImmediatePriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"commitRootImpl\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"bind\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"renderPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"))\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" null\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" commitRootImpl\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"renderPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  do\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    flushPassiveEffects\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"rootWithPendingPassiveEffects\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  flushRenderPhaseStrictModeWarningsInDEV\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" ((\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"executionContext\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" & (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"RenderContext\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"CommitContext\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")) !== \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoContext\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    throw\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" new\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" Error\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'Should not already be working.'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" finishedWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"finishedWork\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"finishedLanes\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"finishedWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" null\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"finishedWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"finishedLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoLanes\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"finishedWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    throw\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" new\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" Error\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#FFD493\"},children:\"      'Cannot commit the same tree as before. This error is likely caused by '\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" + \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'a bug in React. Please file an issue.'\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    )\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 提交阶段开始\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"callbackPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoLane\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 更新 remainingLanes 和 pendingLanes\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" remainingLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"mergeLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"finishedWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"finishedWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"childLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  markRootFinished\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"remainingLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgressRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgressRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgressRootRenderLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoLanes\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 获取副作用列表\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" firstEffect\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"finishedWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" > \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"PerformedWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"finishedWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lastEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      finishedWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lastEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"finishedWork\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      firstEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"finishedWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"firstEffect\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      firstEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"finishedWork\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    firstEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"finishedWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"firstEffect\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 开始提交三个子阶段\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:[\"这里，React将提交过程的优先级设置为最高(\",n(c.code,{children:\"ImmediatePriority\"}),\")，确保提交过程不会被打断。同时，它还处理了一些准备工作，如刷新被动效果和获取副作用列表。\"]}),\"\\n\",n(c.p,{children:\"而使用最高优先级执行提交过程，确保更新能够尽快应用到DOM，我理解其实有几个原因：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",n(c.li,{children:\"用户体验：提交阶段直接影响到用户可见的UI变化。通过给予最高优先级，React确保这些变化能够尽快呈现给用户，提高应用的响应性。\"}),\"\\n\",n(c.li,{children:\"一致性保证：提交阶段需要同步执行以保证UI的一致性。如果这个过程被中断，可能会导致UI处于不一致的状态。\"}),\"\\n\"]}),\"\\n\",e(c.h3,{id:\"22-提交阶段\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#22-提交阶段\",children:n(c.span,{className:\"icon icon-link\"})}),\"2.2 提交阶段\"]}),\"\\n\",n(c.p,{children:\"提交阶段分为三个子阶段：Before mutation、Mutation和Layout,简化后代码如下\"}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" commitRootImpl\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"renderPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 第一阶段：Before mutation\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  commitBeforeMutationEffects\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 第二阶段：Mutation\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  commitMutationEffects\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"renderPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 切换当前树\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"finishedWork\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 第三阶段：Layout\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  commitLayoutEffects\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ...\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"每个阶段都有特定的任务：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"Before mutation阶段：\",\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"处理DOM操作前的准备工作\"}),\"\\n\",n(c.li,{children:\"调度useEffect\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" commitBeforeMutationEffects\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (!\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"shouldFireAfterActiveInstanceBlur\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"focusedInstanceHandle\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // ...\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" flags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"flags\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" ((\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" & \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Snapshot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") !== \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoFlags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      commitBeforeMutationEffectOnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" ((\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" & \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Passive\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") !== \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoFlags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (!\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"rootDoesHavePassiveEffects\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        rootDoesHavePassiveEffects\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"        scheduleCallback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NormalSchedulerPriority\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", () \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"          flushPassiveEffects\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"          return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" null\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"        })\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.ol,{start:\"2\",children:[\"\\n\",e(c.li,{children:[\"Mutation阶段：\",\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"执行实际的DOM操作\"}),\"\\n\",n(c.li,{children:\"调用生命周期方法\"}),\"\\n\",n(c.li,{children:\"重置文本节点\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" commitMutationEffects\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"FiberRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"renderPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" flags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" & \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"ContentReset\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      commitResetTextContent\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" & \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Ref\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"        commitDetachRef\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" primaryFlags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" & (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Placement\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Update\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Deletion\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Hydrating\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    switch\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"primaryFlags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" Placement\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"        commitPlacement\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" &=\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" ~\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Placement\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        break\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" PlacementAndUpdate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"        commitPlacement\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" &=\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" ~\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Placement\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"        commitWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        break\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" Update\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"        commitWork\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        break\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      case\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" Deletion\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"        commitDeletion\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"renderPriorityLevel\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        break\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.ol,{start:\"3\",children:[\"\\n\",e(c.li,{children:[\"Layout阶段：\",\"\\n\",e(c.ul,{children:[\"\\n\",n(c.li,{children:\"处理DOM操作后的工作\"}),\"\\n\",n(c.li,{children:\"调用useLayoutEffect钩子\"}),\"\\n\",n(c.li,{children:\"更新ref\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" commitLayoutEffects\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"FiberRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"committedLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" flags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" & (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Update\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Callback\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      commitLayoutEffectOnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"committedLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" & \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"Ref\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      commitAttachRef\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.h2,{id:\"3-fiber树的更新机制\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#3-fiber树的更新机制\",children:n(c.span,{className:\"icon icon-link\"})}),\"3. Fiber树的更新机制\"]}),\"\\n\",n(c.p,{children:\"React的更新机制是其性能优化的核心。当组件状态发生变化时，React会创建一个新的Fiber树（称为workInProgress树），然后与当前的Fiber树进行对比，找出需要更新的部分。\"}),\"\\n\",e(c.h3,{id:\"31-调度更新\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#31-调度更新\",children:n(c.span,{className:\"icon icon-link\"})}),\"3.1 调度更新\"]}),\"\\n\",e(c.p,{children:[\"当我们调用\",n(c.code,{children:\"setState\"}),\"或使用\",n(c.code,{children:\"hooks\"}),\"更新状态时，React会调度一次更新，这部分源码其实在第3章讲得很多了：\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" scheduleUpdateOnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"lane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Lane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"eventTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"number\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"markUpdateLaneFromFiberToRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 标记根节点为已调度\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  markRootUpdated\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"eventTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgressRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 如果我们正在处理这个根节点，可能需要调整优先级\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      workInProgressRootExitStatus\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"RootSuspendedWithDelay\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" ||\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgressRootExitStatus\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"RootSuspended\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" &&\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"        includesOnlyRetries\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgressRootRenderLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") &&\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"        now\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"() - \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"globalMostRecentFallbackTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"FALLBACK_THROTTLE_MS\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    ) {\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 中断当前渲染\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      prepareFreshStack\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 继续当前渲染，合并新的更新\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      workInProgressRootRenderLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"mergeLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        workInProgressRootRenderLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        lane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      );\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"  ensureRootIsScheduled\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"eventTime\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    lane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"SyncLane\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" &&\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    executionContext\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoContext\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" &&\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"mode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" & \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"ConcurrentMode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoMode\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  ) {\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 同步更新，立即执行\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    performSyncWorkOnRoot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" root\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.h3,{id:\"32-构建workinprogress树\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#32-构建workinprogress树\",children:n(c.span,{className:\"icon icon-link\"})}),\"3.2 构建workInProgress树\"]}),\"\\n\",e(c.p,{children:[\"在React的更新过程中，这个过程的核心是\",n(c.code,{children:\"createWorkInProgress\"}),\"函数，它负责创建或重用Fiber节点来构建新的树结构。我们前面提到过，但我们现在深入看看这个设计：\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" createWorkInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"pendingProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"any\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"): \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 如果alternate不存在，创建一个新的Fiber\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"createFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"tag\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      pendingProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"mode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    );\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"elementType\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"elementType\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"stateNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"stateNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 如果alternate存在，重置workInProgress\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"pendingProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"pendingProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"NoFlags\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"firstEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lastEffect\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // ... 其他属性的重置\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 复制一些不变的属性\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"childLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"childLanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"memoizedProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"memoizedProps\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"memoizedState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"memoizedState\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"updateQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"updateQueue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 处理dependencies\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" currentDependencies\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"dependencies\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"dependencies\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" =\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    currentDependencies\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      ?\"}),n(c.span,{style:{color:\"#FFD493\"},children:\" null\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      :\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"          lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentDependencies\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"          firstContext\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentDependencies\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"firstContext\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"        };\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 复制其他属性\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"ref\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"ref\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" workInProgress\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"这个函数的主要目的是创建或重用一个Fiber节点，作为当前更新过程中的工作单元：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"Fiber节点复用\"}),\"：\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[\"React使用\",n(c.code,{children:\"alternate\"}),\"属性来实现Fiber节点的复用。每个Fiber节点都有一个\",n(c.code,{children:\"alternate\"}),\"，指向其在另一棵树中的对应节点。\"]}),\"\\n\",e(c.li,{children:[\"如果\",n(c.code,{children:\"alternate\"}),\"存在，React会重用这个节点，而不是创建新的节点。这大大减少了内存分配和垃圾回收的开销。\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"选择性重置\"}),\"：\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[\"当重用一个Fiber节点时，React只重置那些可能发生变化的属性（如\",n(c.code,{children:\"pendingProps\"}),\"、\",n(c.code,{children:\"flags\"}),\"、\",n(c.code,{children:\"effects\"}),\"等）。\"]}),\"\\n\",e(c.li,{children:[\"不变的属性（如\",n(c.code,{children:\"childLanes\"}),\"、\",n(c.code,{children:\"lanes\"}),\"、\",n(c.code,{children:\"child\"}),\"等）直接从当前Fiber复制，避免不必要的操作。\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",e(c.p,{children:[n(c.strong,{children:\"浅拷贝\"}),\"：\"]}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[\"对于大多数属性，React使用浅拷贝。这意味着引用类型的属性（如\",n(c.code,{children:\"updateQueue\"}),\"、\",n(c.code,{children:\"memoizedState\"}),\"等）只复制引用，而不是深度克隆（react几乎都是浅拷贝）。\"]}),\"\\n\",n(c.li,{children:\"这种策略在大多数情况下是高效的，但也要求开发者在操作这些属性时要小心，避免意外修改。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.h3,{id:\"33-diff算法\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#33-diff算法\",children:n(c.span,{className:\"icon icon-link\"})}),\"3.3 Diff算法\"]}),\"\\n\",n(c.p,{children:\"React的Diff算法是其高效更新的核心，用于比较两棵虚拟DOM树的差异，以最小化实际DOM操作。React的Diff算法基于三个主要假设：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",n(c.li,{children:\"不同类型的元素会产生不同的树结构。\"}),\"\\n\",n(c.li,{children:\"开发者可以通过key属性来暗示哪些子元素在不同的渲染中可能是稳定的。\"}),\"\\n\",n(c.li,{children:\"只对同级元素进行比较。\"}),\"\\n\"]}),\"\\n\",e(c.h4,{id:\"331-diff算法的入口\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#331-diff算法的入口\",children:n(c.span,{className:\"icon icon-link\"})}),\"3.3.1 Diff算法的入口\"]}),\"\\n\",e(c.p,{children:[\"Diff算法的入口是\",n(c.code,{children:\"reconcileChildFibers\"}),\"函数，几乎所有的更新和渲染过程都会用到这个函数：\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" reconcileChildFibers\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  currentFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | null,\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"any\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Lanes\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"): \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | null {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 处理单个子元素\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'object'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    switch\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"$$typeof\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      case\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" REACT_ELEMENT_TYPE\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        return\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" placeSingleChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"          reconcileSingleElement\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"            returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"            currentFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"            newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#4BF3C8\"},children:\"            lanes\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"          )\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"        );\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // ... 其他类型的处理\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 处理多个子元素\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"isArray\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" reconcileChildrenArray\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      currentFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#4BF3C8\"},children:\"      lanes\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    );\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 处理文本节点\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'string'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" || \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"'number'\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" placeSingleChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      reconcileSingleTextNode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        currentFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#FFD493\"},children:\"        ''\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" + \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#4BF3C8\"},children:\"        lanes\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      )\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    );\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 其他情况，删除所有现有子节点\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" deleteRemainingChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.h4,{id:\"332-单节点对比\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#332-单节点对比\",children:n(c.span,{className:\"icon icon-link\"})}),\"3.3.2 单节点对比\"]}),\"\\n\",e(c.p,{children:[\"对于单个子元素，React使用\",n(c.code,{children:\"reconcileSingleElement\"}),\"函数进行对比：\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" reconcileSingleElement\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  currentFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | null,\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"ReactElement\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Lanes\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"): \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 比较key\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 比较type\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"elementType\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"        deleteRemainingChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" existing\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"useFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"props\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        existing\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"ref\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"coerceRef\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        existing\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" existing\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // key相同但type不同，删除所有旧的子节点\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      deleteRemainingChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      break\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"      deleteChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 创建新的Fiber节点\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" created\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"createFiberFromElement\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"mode\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  created\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"ref\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"coerceRef\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"element\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"  created\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"return\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" created\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"单节点对比的过程主要包括：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",n(c.li,{children:\"比较key和type\"}),\"\\n\",n(c.li,{children:\"复用或创建新节点\"}),\"\\n\",n(c.li,{children:\"删除不需要的旧节点\"}),\"\\n\"]}),\"\\n\",e(c.h4,{id:\"333-多节点对比\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#333-多节点对比\",children:n(c.span,{className:\"icon icon-link\"})}),\"3.3.3 多节点对比\"]}),\"\\n\",e(c.p,{children:[\"对于多个子元素，React使用\",n(c.code,{children:\"reconcileChildrenArray\"}),\"函数进行对比：\"]}),\"\\n\",n(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:n(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" reconcileChildrenArray\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  currentFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | null,\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  newChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Array\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"any\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\">,\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Lanes\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"): \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | null {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" resultingFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | null = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" previousNewFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" | null = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"currentFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" lastPlacedIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" newIdx\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"0\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" nextOldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 第一次遍历：处理更新的节点\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  for\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (; \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newIdx\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"length\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"; \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newIdx\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"++) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"index\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" > \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newIdx\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      nextOldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      nextOldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"updateSlot\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      newChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newIdx\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"],\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#4BF3C8\"},children:\"      lanes\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    );\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextOldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      break\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"shouldTrackSideEffects\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"        deleteChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    lastPlacedIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"placeChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lastPlacedIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newIdx\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"previousNewFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      resultingFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      previousNewFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    previousNewFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"nextOldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 所有新子节点都已处理完毕\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newIdx\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"length\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#00DAEF\"},children:\"    deleteRemainingChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" resultingFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 所有旧子节点都已处理完毕，添加剩余的新节点\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    for\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (; \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newIdx\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"length\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"; \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newIdx\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"++) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"createChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newIdx\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"], \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        continue\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      lastPlacedIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"placeChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lastPlacedIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newIdx\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"previousNewFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        resultingFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        previousNewFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      previousNewFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" resultingFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 将剩余的旧节点添加到Map中，用于后续的查找\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" existingChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"mapRemainingChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"oldFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 第二次遍历：处理剩余的新节点，尝试从Map中复用旧节点\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  for\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (; \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newIdx\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"length\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"; \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newIdx\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"++) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),n(c.span,{style:{color:\"#ACAFFF\"},children:\" newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"updateFromMap\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      existingChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      newIdx\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      newChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newIdx\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"],\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#4BF3C8\"},children:\"      lanes\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    );\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"shouldTrackSideEffects\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"        if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"          existingChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"delete\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"            newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"key\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" ?\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" newIdx\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" :\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"key\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"          );\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"        }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      lastPlacedIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"placeChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"lastPlacedIndex\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newIdx\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"previousNewFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),n(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        resultingFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#EEF0F9\"},children:\"      } \"}),n(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"        previousNewFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"sibling\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"      previousNewFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"newFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 删除Map中剩余的旧节点\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"shouldTrackSideEffects\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#4BF3C8\"},children:\"    existingChildren\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\"forEach\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"child\"}),n(c.span,{style:{color:\"#54B9FF\"},children:\" =>\"}),n(c.span,{style:{color:\"#00DAEF\"},children:\" deleteChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"returnFiber\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\"));\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[n(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),n(c.span,{style:{color:\"#4BF3C8\"},children:\" resultingFirstChild\"}),n(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:n(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:\"多节点对比的过程主要包括：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",n(c.li,{children:\"第一次遍历：尝试更新现有节点\"}),\"\\n\",n(c.li,{children:\"处理新增节点\"}),\"\\n\",n(c.li,{children:\"处理需要移动的节点\"}),\"\\n\",n(c.li,{children:\"删除不再需要的旧节点\"}),\"\\n\"]}),\"\\n\",e(c.h4,{id:\"334-diff算法的优化策略\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#334-diff算法的优化策略\",children:n(c.span,{className:\"icon icon-link\"})}),\"3.3.4 Diff算法的优化策略\"]}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[n(c.strong,{children:\"两次遍历\"}),\"：第一次处理可以直接更新的节点，第二次处理需要移动或新建的节点。\"]}),\"\\n\",e(c.li,{children:[n(c.strong,{children:\"使用key进行优化\"}),\"：通过key可以快速判断元素是否可以复用。\"]}),\"\\n\",e(c.li,{children:[n(c.strong,{children:\"从两端向中间比较\"}),\"：这种策略可以快速处理头尾的增删操作。\"]}),\"\\n\",e(c.li,{children:[n(c.strong,{children:\"使用Map存储剩余节点\"}),\"：提高查找效率。\"]}),\"\\n\",e(c.li,{children:[n(c.strong,{children:\"就地复用\"}),\"：尽可能地复用已有的Fiber节点。\"]}),\"\\n\",e(c.li,{children:[n(c.strong,{children:\"批量处理\"}),\"：将多个更新操作批量处理，减少渲染次数。\"]}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"通过这些优化策略，React的Diff算法能够在O(n)的时间复杂度内完成对比，大大提高了性能。理解Diff算法的工作原理对于优化React应用非常重要，例如：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"合理使用\",n(c.code,{children:\"key\"}),\"属性，特别是在列表渲染中，避免使用索引作为key。\"]}),\"\\n\",n(c.li,{children:\"尽量保持组件的稳定性，避免不必要的重新渲染。\"}),\"\\n\",n(c.li,{children:\"合理拆分组件，避免大型组件导致的大范围Diff。\"}),\"\\n\"]}),\"\\n\",e(c.h3,{id:\"34-完成更新\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#34-完成更新\",children:n(c.span,{className:\"icon icon-link\"})}),\"3.4 完成更新\"]}),\"\\n\",n(c.p,{children:\"一旦Diff完成，React会标记需要更新的Fiber节点，然后在commit阶段应用这些更新。这个过程与初始渲染时的commit阶段类似，但只会处理被标记为需要更新的节点。\"}),\"\\n\",e(c.h2,{id:\"总结\",children:[n(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#总结\",children:n(c.span,{className:\"icon icon-link\"})}),\"总结\"]}),\"\\n\",n(c.p,{children:\"React Fiber架构通过可中断的渲染过程和精细的更新控制，大大提高了React应用的性能和响应性。通过创建、更新和提交Fiber对象，React能够灵活地管理组件树，实现高效的状态更新和DOM操作。理解这些内部机制对于深入掌握React和优化React应用至关重要。\"}),\"\\n\",n(c.p,{children:\"在实际开发中，我们可以利用这些知识来优化我们的React应用：\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"合理使用\",n(c.code,{children:\"key\"}),\"属性，帮助React更好地识别列表中的元素变化。\"]}),\"\\n\",e(c.li,{children:[\"使用\",n(c.code,{children:\"React.memo\"}),\"、\",n(c.code,{children:\"useMemo\"}),\"和\",n(c.code,{children:\"useCallback\"}),\"来避免不必要的重渲染。\"]}),\"\\n\",n(c.li,{children:\"理解并正确使用生命周期方法和Hooks，避免在不恰当的时机进行昂贵的操作。\"}),\"\\n\",e(c.li,{children:[\"对于大型列表，考虑使用虚拟化技术（如\",n(c.code,{children:\"react-window\"}),\"）来减少渲染的节点数量。\"]}),\"\\n\"]}),\"\\n\",n(c.p,{children:\"通过深入理解React Fiber的工作原理，我们可以编写出更高效、更可维护的React应用。\"})]})}return{default:function(l={}){const{wrapper:e}=l.components||{};return e?n(e,{...l,children:n(_createMdxContent,{...l})}):_createMdxContent(l)}};",
    "toc": {
      "content": [
        {
          "title": "React Fiber架构：React Fiber对象的创建、更新、提交",
          "url": "#react-fiber架构react-fiber对象的创建更新提交",
          "items": [
            {
              "title": "1. 创建Fiber对象",
              "url": "#1-创建fiber对象",
              "items": [
                {
                  "title": "1.1 创建RootFiber",
                  "url": "#11-创建rootfiber",
                  "items": []
                },
                {
                  "title": "1.2 创建子Fiber节点",
                  "url": "#12-创建子fiber节点",
                  "items": []
                },
                {
                  "title": "1.3 创建单个Fiber节点",
                  "url": "#13-创建单个fiber节点",
                  "items": []
                }
              ]
            },
            {
              "title": "2. 初始化提交",
              "url": "#2-初始化提交",
              "items": [
                {
                  "title": "2.1 提交前的准备",
                  "url": "#21-提交前的准备",
                  "items": []
                },
                {
                  "title": "2.2 提交阶段",
                  "url": "#22-提交阶段",
                  "items": []
                }
              ]
            },
            {
              "title": "3. Fiber树的更新机制",
              "url": "#3-fiber树的更新机制",
              "items": [
                {
                  "title": "3.1 调度更新",
                  "url": "#31-调度更新",
                  "items": []
                },
                {
                  "title": "3.2 构建workInProgress树",
                  "url": "#32-构建workinprogress树",
                  "items": []
                },
                {
                  "title": "3.3 Diff算法",
                  "url": "#33-diff算法",
                  "items": [
                    {
                      "title": "3.3.1 Diff算法的入口",
                      "url": "#331-diff算法的入口",
                      "items": []
                    },
                    {
                      "title": "3.3.2 单节点对比",
                      "url": "#332-单节点对比",
                      "items": []
                    },
                    {
                      "title": "3.3.3 多节点对比",
                      "url": "#333-多节点对比",
                      "items": []
                    },
                    {
                      "title": "3.3.4 Diff算法的优化策略",
                      "url": "#334-diff算法的优化策略",
                      "items": []
                    }
                  ]
                },
                {
                  "title": "3.4 完成更新",
                  "url": "#34-完成更新",
                  "items": []
                }
              ]
            },
            {
              "title": "总结",
              "url": "#总结",
              "items": []
            }
          ]
        }
      ],
      "visible": true
    },
    "slugAsParams": "5.fiber-commit"
  },
  {
    "slug": "/content/react-source-code/6.react_source_reading(4)_top",
    "title": "6. 函数式组件-构建细节以及更新（上）",
    "description": "React源码阅读(4)-支线(函数式组件)-构建细节以及更新（上）",
    "published": true,
    "date": "2022-12-05T00:00:00.000Z",
    "body": "const{Fragment:n,jsx:l,jsxs:e}=arguments[0];function _createMdxContent(r){const c={a:\"a\",code:\"code\",figure:\"figure\",h1:\"h1\",h2:\"h2\",img:\"img\",li:\"li\",ol:\"ol\",p:\"p\",pre:\"pre\",span:\"span\",ul:\"ul\",...r.components};return e(n,{children:[e(c.h1,{id:\"函数式组件-构建细节以及更新上\",children:[l(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#函数式组件-构建细节以及更新上\",children:l(c.span,{className:\"icon icon-link\"})}),\"函数式组件-构建细节以及更新（上）\"]}),\"\\n\",l(c.p,{children:\"在前面的过程中，我们已经理解了Fiber，它能帮助我们理解优化级调度机制等优化应用性能。那么接下来我们就通过Hooks和函数式组件来进一步深入React的优化。\"}),\"\\n\",e(c.h2,{id:\"函数式组件的处理流程\",children:[l(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#函数式组件的处理流程\",children:l(c.span,{className:\"icon icon-link\"})}),\"函数式组件的处理流程\"]}),\"\\n\",e(c.h2,{id:\"beginwork阶段\",children:[l(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#beginwork阶段\",children:l(c.span,{className:\"icon icon-link\"})}),\"beginWork阶段\"]}),\"\\n\",e(c.p,{children:[\"我们直接从\",l(c.code,{children:\"beginWork\"}),\"开始,讲解最常用的函数式组件的更新和构建。\",l(c.a,{href:\"https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact%2Fblob%2Fv17.0.2%2Fpackages%2Freact-reconciler%2Fsrc%2FReactFiberBeginWork.old.js%23L3083-L3494\",title:\"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberBeginWork.old.js#L3083-L3494\",children:\"源码地址\"})]}),\"\\n\",l(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:l(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"js\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"js\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"switch\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"tag\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 忽略代码\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 函数式组件的子节点构建\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"    case\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\" FunctionComponent\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\": {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),l(c.span,{style:{color:\"#ACAFFF\"},children:\" Component\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),l(c.span,{style:{color:\"#ACAFFF\"},children:\" unresolvedProps\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"pendingProps\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),l(c.span,{style:{color:\"#ACAFFF\"},children:\" resolvedProps\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" =\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"        workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"elementType\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"Component\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"          ?\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\" unresolvedProps\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"          :\"}),l(c.span,{style:{color:\"#00DAEF\"},children:\" resolveDefaultProps\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"Component\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"unresolvedProps\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"      return\"}),l(c.span,{style:{color:\"#00DAEF\"},children:\" updateFunctionComponent\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"        current\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"        workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"        Component\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"        resolvedProps\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"        renderLanes\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F9\"},children:\"      );\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 忽略代码\"})})]})})}),\"\\n\",e(c.p,{children:[\"在\",l(c.code,{children:\"beginWork\"}),\"阶段,React会根据组件类型选择相应的处理方法。对于函数式组件,它会调用\",l(c.code,{children:\"updateFunctionComponent\"}),\"方法。\"]}),\"\\n\",e(c.h2,{id:\"更新分析\",children:[l(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#更新分析\",children:l(c.span,{className:\"icon icon-link\"})}),\"更新分析\"]}),\"\\n\",e(c.p,{children:[l(c.code,{children:\"beginWork\"}),\"探寻阶段的主要任务是设置是否需要更新的状态。这个状态是后续许多代码判断的基础。\"]}),\"\\n\",l(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:l(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"js\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"js\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"if\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),l(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 双缓存机制\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),l(c.span,{style:{color:\"#ACAFFF\"},children:\" oldProps\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"memoizedProps\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),l(c.span,{style:{color:\"#ACAFFF\"},children:\" newProps\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"pendingProps\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 不相等就进入对比\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"oldProps\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"newProps\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" || \"}),l(c.span,{style:{color:\"#00DAEF\"},children:\"hasLegacyContextChanged\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\"() || (\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"__DEV__\"}),l(c.span,{style:{color:\"#54B9FF\"},children:\" ?\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\" workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"type\"}),l(c.span,{style:{color:\"#54B9FF\"},children:\" :\"}),l(c.span,{style:{color:\"#FFD493\"},children:\" false\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 状态标记需要更新这个状态，记住这个状态后续很多工作都与之相关\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"    didReceiveUpdate\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),l(c.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 如果渲染车道内不包含更新就不需要更新\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),l(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),l(c.span,{style:{color:\"#54B9FF\"},children:\" if\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" (!\"}),l(c.span,{style:{color:\"#00DAEF\"},children:\"includesSomeLane\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"renderLanes\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"updateLanes\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"    didReceiveUpdate\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),l(c.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 上下文特殊处理，优化\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"    switch\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"tag\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 循坏子节点需要更新不\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),l(c.span,{style:{color:\"#00DAEF\"},children:\" bailoutOnAlreadyFinishedWork\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"renderLanes\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),l(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" ((\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" & \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"ForceUpdateForLegacySuspense\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\") !== \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"NoFlags\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 处理Suspense组件不会Context更新时更新的问题强制将标记变为true。\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"      didReceiveUpdate\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),l(c.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),l(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // An update was scheduled on this fiber, but there are no new props\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // nor legacy context. Set this to false. If an update queue or context\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // consumer produces a changed value, it will set this to true. Otherwise,\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // the component will assume the children have not changed and bail out.\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"      didReceiveUpdate\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),l(c.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#EEF0F9\"},children:\"} \"}),l(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 剩下的就是都不需要更新\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"  didReceiveUpdate\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),l(c.span,{style:{color:\"#FFD493\"},children:\"false\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",l(c.p,{children:\"这段代码主要做了以下几件事:\"}),\"\\n\",e(c.ol,{children:[\"\\n\",l(c.li,{children:\"比较新旧props是否相等\"}),\"\\n\",l(c.li,{children:\"检查context是否发生变化\"}),\"\\n\",e(c.li,{children:[\"根据比较结果设置\",l(c.code,{children:\"didReceiveUpdate\"}),\"状态\"]}),\"\\n\",l(c.li,{children:\"处理特殊情况,如Suspense组件的强制更新\"}),\"\\n\"]}),\"\\n\",e(c.h2,{id:\"updatefunctioncomponent\",children:[l(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#updatefunctioncomponent\",children:l(c.span,{className:\"icon icon-link\"})}),\"updateFunctionComponent\"]}),\"\\n\",e(c.p,{children:[\"在设置更新状态后,React会调用\",l(c.code,{children:\"updateFunctionComponent\"}),\"方法来处理函数式组件。\"]}),\"\\n\",l(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:l(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"js\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"js\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),l(c.span,{style:{color:\"#00DAEF\"},children:\" updateFunctionComponent\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  current\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  Component\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  nextProps\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),l(c.span,{style:{color:\"#ACAFFF\"},children:\"any\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  renderLanes\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 忽略代码\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\" context\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\" nextChildren\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 这里和useContext有关，hooks分支中我们去讲一下\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#00DAEF\"},children:\"  prepareToReadContext\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"renderLanes\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"__DEV__\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    //忽略代码\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),l(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 这里就直接进入了hooks相关逻辑，最后返回下级ReactElement对象\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"    nextChildren\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),l(c.span,{style:{color:\"#00DAEF\"},children:\"renderWithHooks\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"      current\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"      workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"      Component\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"      nextProps\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"      context\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"      renderLanes\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F9\"},children:\"    );\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 老规矩，如果didReceiveUpdate这个状态也就是前面提到的不需要更新，向下查找子节\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),l(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" && !\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"didReceiveUpdate\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#00DAEF\"},children:\"    bailoutHooks\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"renderLanes\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),l(c.span,{style:{color:\"#00DAEF\"},children:\" bailoutOnAlreadyFinishedWork\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"renderLanes\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // React DevTools reads this flag.我们暂时都略过performance的东西\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"  workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),l(c.span,{style:{color:\"#54B9FF\"},children:\" |=\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\" PerformedWork\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 向下生成子fiber节点\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#00DAEF\"},children:\"  reconcileChildren\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"nextChildren\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"renderLanes\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\" workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"child\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:[l(c.code,{children:\"updateFunctionComponent\"}),\"的主要工作包括:\"]}),\"\\n\",e(c.ol,{children:[\"\\n\",l(c.li,{children:\"准备context\"}),\"\\n\",e(c.li,{children:[\"调用\",l(c.code,{children:\"renderWithHooks\"}),\"执行函数组件\"]}),\"\\n\",e(c.li,{children:[\"根据\",l(c.code,{children:\"didReceiveUpdate\"}),\"状态决定是否需要更新\"]}),\"\\n\",l(c.li,{children:\"生成子Fiber节点\"}),\"\\n\"]}),\"\\n\",e(c.h2,{id:\"renderwithhooks\",children:[l(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#renderwithhooks\",children:l(c.span,{className:\"icon icon-link\"})}),\"renderWithHooks\"]}),\"\\n\",e(c.p,{children:[l(c.code,{children:\"renderWithHooks\"}),\"函数是Hooks机制的核心,它为函数式组件提供了状态管理和副作用处理的能力:\"]}),\"\\n\",l(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:l(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"js\",\"data-theme\":\"houston\",children:e(c.code,{\"data-language\":\"js\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"export\"}),l(c.span,{style:{color:\"#54B9FF\"},children:\" function\"}),l(c.span,{style:{color:\"#00DAEF\"},children:\" renderWithHooks\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),l(c.span,{style:{color:\"#ACAFFF\"},children:\"Props\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),l(c.span,{style:{color:\"#ACAFFF\"},children:\"SecondArg\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\">(\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  current\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),l(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" | null,\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),l(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#00DAEF\"},children:\"  Component\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\": (\"}),l(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"p\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),l(c.span,{style:{color:\"#ACAFFF\"},children:\"Props\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),l(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"arg\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),l(c.span,{style:{color:\"#ACAFFF\"},children:\"SecondArg\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\") \"}),l(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),l(c.span,{style:{color:\"#ACAFFF\"},children:\" any\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  props\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),l(c.span,{style:{color:\"#ACAFFF\"},children:\"Props\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  secondArg\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),l(c.span,{style:{color:\"#ACAFFF\"},children:\"SecondArg\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  nextRenderLanes\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),l(c.span,{style:{color:\"#ACAFFF\"},children:\"Lanes\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#EEF0F9\"},children:\"): \"}),l(c.span,{style:{color:\"#ACAFFF\"},children:\"any\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 1阶段：去设置全局的状态\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"  renderLanes\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"nextRenderLanes\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\"; \"}),l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 当前渲染优先级\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"  currentlyRenderingFiber\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\"; \"}),l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 当前fiber节点, 也就是function组件对应的fiber节点\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"__DEV__\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    //忽略代码\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 清除当前fiber的遗留状态\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"  workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"memoizedState\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),l(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"  workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"updateQueue\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),l(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"  workInProgress\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"NoLanes\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"   if\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"__DEV__\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    //忽略代码\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#EEF0F9\"},children:\"   } \"}),l(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 2阶段：生成ReactElement子节点\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // ReactCurrentDispatcher来自react-dom中的全局变量，确认是初始化还是更新\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"      ReactCurrentDispatcher\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" =\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"        current\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),l(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" || \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"memoizedState\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),l(c.span,{style:{color:\"#FFD493\"},children:\"null\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"          ?\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\" HooksDispatcherOnMount\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"          :\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\" HooksDispatcherOnUpdate\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"      // 执行function函数\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#54B9FF\"},children:\"      let\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\" children\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),l(c.span,{style:{color:\"#00DAEF\"},children:\"Component\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"props\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"secondArg\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F9\"},children:\"   }\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 重置全局变量,并返回\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // 执行function之后, 还原被修改的全局变量, 不影响下一次调用\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#4BF3C8\"},children:\"  renderLanes\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),l(c.span,{style:{color:\"#4BF3C8\"},children:\"NoLanes\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:[l(c.span,{style:{color:\"#00DAEF\"},children:\"  currentlyRenderingFiber\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\" = (\"}),l(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"null\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),l(c.span,{style:{color:\"#ACAFFF\"},children:\"any\"}),l(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",l(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F9\"},children:\"  currentHook = null;\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F9\"},children:\"  workInProgressHook = null;\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F9\"},children:\"  didScheduleRenderPhaseUpdate = false;\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F9\"},children:\"  return children;\"})}),\"\\n\",l(c.span,{\"data-line\":\"\",children:l(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",l(c.p,{children:\"这个函数的工作流程可以分为三个阶段:\"}),\"\\n\",e(c.ol,{children:[\"\\n\",l(c.li,{children:\"准备阶段: 设置全局变量,清除旧的状态。\"}),\"\\n\",l(c.li,{children:\"执行阶段: 根据是首次渲染还是更新,选择合适的Hooks处理器,然后执行组件函数。\"}),\"\\n\",l(c.li,{children:\"清理阶段: 重置全局变量,防止影响其他组件。\"}),\"\\n\"]}),\"\\n\",e(c.h2,{id:\"执行过程分析\",children:[l(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#执行过程分析\",children:l(c.span,{className:\"icon icon-link\"})}),\"执行过程分析\"]}),\"\\n\",l(c.p,{children:l(c.a,{href:\"https://link.juejin.cn?target=https%3A%2F%2Fcodesandbox.io%2Fs%2Fjovial-hill-idlc7g%3Ffile%3D%2Fsrc%2FApp.tsx\",title:\"https://codesandbox.io/s/jovial-hill-idlc7g?file=/src/App.tsx\",children:\"在线尝试\"})}),\"\\n\",l(c.p,{children:\"通过打断点分析,我们可以了解函数组件的执行过程:\"}),\"\\n\",e(c.ol,{children:[\"\\n\",e(c.li,{children:[\"\\n\",l(c.p,{children:\"初始化阶段:\"}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[\"组件首次进入\",l(c.code,{children:\"beginWork\"}),\"时,被标记为\",l(c.code,{children:\"indeterminateComponent\"}),\"(不确定的组件类型)\"]}),\"\\n\",e(c.li,{children:[\"执行\",l(c.code,{children:\"renderWithHooks\"})]}),\"\\n\",e(c.li,{children:[\"执行完毕后,打上\",l(c.code,{children:\"FunctionComponent\"}),\"标记\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.li,{children:[\"\\n\",l(c.p,{children:\"更新阶段:\"}),\"\\n\",e(c.ul,{children:[\"\\n\",e(c.li,{children:[\"直接进入\",l(c.code,{children:\"updateFunctionComponent\"}),\"逻辑\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.p,{children:[l(c.img,{src:\"https://ik.imagekit.io/leiakito/Vue3+ELLnput/React%20%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%20%E6%94%AF%E7%BA%BF%20%E7%BB%84%E4%BB%B6%20%E6%9E%84%E5%BB%BA%E7%BB%86%E8%8A%82.webp?updatedAt=1739720712530\",alt:\"执行过程图1\"}),\"\\n\",l(c.img,{src:\"https://ik.imagekit.io/leiakito/Vue3+ELLnput/923c00657040409ba6031935d913a946~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.webp?updatedAt=1739720711840\",alt:\"执行过程图2\"})]}),\"\\n\",e(c.h2,{id:\"总结\",children:[l(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#总结\",children:l(c.span,{className:\"icon icon-link\"})}),\"总结\"]}),\"\\n\",e(c.p,{children:[\"本文详细介绍了React函数式组件的构建和更新过程,从\",l(c.code,{children:\"beginWork\"}),\"到\",l(c.code,{children:\"updateFunctionComponent\"}),\",再到\",l(c.code,{children:\"renderWithHooks\"}),\"。我们了解了React如何处理函数式组件,如何决定是否需要更新,以及Hooks机制的核心实现。\"]}),\"\\n\",l(c.p,{children:\"下一篇将深入探讨函数组件中具体Hooks的实现,以及是如何优化性能的。\"})]})}return{default:function(n={}){const{wrapper:e}=n.components||{};return e?l(e,{...n,children:l(_createMdxContent,{...n})}):_createMdxContent(n)}};",
    "toc": {
      "content": [
        {
          "title": "函数式组件-构建细节以及更新（上）",
          "url": "#函数式组件-构建细节以及更新上",
          "items": [
            {
              "title": "函数式组件的处理流程",
              "url": "#函数式组件的处理流程",
              "items": []
            },
            {
              "title": "beginWork阶段",
              "url": "#beginwork阶段",
              "items": []
            },
            {
              "title": "更新分析",
              "url": "#更新分析",
              "items": []
            },
            {
              "title": "updateFunctionComponent",
              "url": "#updatefunctioncomponent",
              "items": []
            },
            {
              "title": "renderWithHooks",
              "url": "#renderwithhooks",
              "items": []
            },
            {
              "title": "执行过程分析",
              "url": "#执行过程分析",
              "items": []
            },
            {
              "title": "总结",
              "url": "#总结",
              "items": []
            }
          ]
        }
      ],
      "visible": true
    },
    "slugAsParams": "6.react_source_reading(4)_top"
  },
  {
    "slug": "/content/react-source-code/7.react_source_reading(4)_middle",
    "title": "7. 函数式组件-构建细节以及更新（中）",
    "description": "React源码阅读(4)-支线(函数式组件)-构建细节以及更新（中））",
    "published": true,
    "date": "2022-12-06T00:00:00.000Z",
    "body": "const{Fragment:l,jsx:e,jsxs:n}=arguments[0];function _createMdxContent(r){const c={a:\"a\",code:\"code\",figure:\"figure\",h1:\"h1\",h2:\"h2\",h3:\"h3\",li:\"li\",ol:\"ol\",p:\"p\",pre:\"pre\",span:\"span\",strong:\"strong\",ul:\"ul\",...r.components};return n(l,{children:[n(c.h1,{id:\"函数式组件-构建细节以及更新中\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#函数式组件-构建细节以及更新中\",children:e(c.span,{className:\"icon icon-link\"})}),\"函数式组件-构建细节以及更新（中）\"]}),\"\\n\",e(c.p,{children:\"在上一篇文章中,我们讨论了函数式组件的构建和更新过程。而本文将深入探讨React hooks的工作原理。\"}),\"\\n\",e(c.p,{children:\"首先,让我们理解一下hooks的分类:\"}),\"\\n\",n(c.ol,{children:[\"\\n\",n(c.li,{children:[\"状态Hook (State Hook): 如\",e(c.code,{children:\"useState\"}),\"和\",e(c.code,{children:\"useReducer\"})]}),\"\\n\",n(c.li,{children:[\"副作用Hook (Effect Hook): 如\",e(c.code,{children:\"useEffect\"}),\"和\",e(c.code,{children:\"useLayoutEffect\"})]}),\"\\n\",n(c.li,{children:[\"Ref Hook: 如\",e(c.code,{children:\"useRef\"})]}),\"\\n\"]}),\"\\n\",n(c.p,{children:[\"而本文将讲状态Hook,\",e(c.code,{children:\"useState\"}),\"和\",e(c.code,{children:\"useReducer\"}),\"的实现。\"]}),\"\\n\",n(c.h2,{id:\"2-usestate的实现\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#2-usestate的实现\",children:e(c.span,{className:\"icon icon-link\"})}),\"2. useState的实现\"]}),\"\\n\",n(c.p,{children:[e(c.code,{children:\"useState\"}),\"是React中最常用的Hook之一。它的实现分为两个主要函数:\",e(c.code,{children:\"mountState\"}),\"(用于初始化)和\",e(c.code,{children:\"updateState\"}),\"(用于更新)。让我们先来看\",e(c.code,{children:\"mountState\"}),\"的实现。\"]}),\"\\n\",n(c.h3,{id:\"21-mountstate\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#21-mountstate\",children:e(c.span,{className:\"icon icon-link\"})}),\"2.1 mountState\"]}),\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\" mountState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\">(\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  initialState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": (() \"}),e(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") | \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"): [\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"Dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"BasicStateAction\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\">>] {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" hook\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"mountWorkInProgressHook\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"();\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\" initialState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"'function'\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    initialState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"initialState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"();\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  hook\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"memoizedState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"hook\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"baseState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"initialState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"hook\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    pending\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    lastRenderedReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"basicStateReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#00DAEF\"},children:\"    lastRenderedState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": (\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"initialState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"any\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"),\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"  });\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  const\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\" dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"Dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    BasicStateAction\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\">,\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"  > = (queue.\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"dispatchAction\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"bind\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#FFD493\"},children:\"    null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    currentlyRenderingFiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"  ): \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"any\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"));\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"  return [\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"hook.memoizedState, dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"]\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#4BF3C8\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:\"让我们逐行分析这个函数:\"}),\"\\n\",n(c.ol,{children:[\"\\n\",n(c.li,{children:[\"\\n\",n(c.p,{children:[e(c.code,{children:\"const hook = mountWorkInProgressHook();\"}),\"\\n这行代码创建了一个新的hook对象,并将其添加到当前fiber的hooks链表中。这是React管理多个hooks的关键机制。\"]}),\"\\n\"]}),\"\\n\",n(c.li,{children:[\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"if\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(c.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\" initialState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"'function'\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  initialState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"initialState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:\"这是一个优化,允许用户传入一个函数来计算初始状态。这对于复杂或昂贵的初始状态计算很有用,因为它只会在组件挂载时执行一次。\"}),\"\\n\"]}),\"\\n\",n(c.li,{children:[\"\\n\",n(c.p,{children:[e(c.code,{children:\"hook.memoizedState = hook.baseState = initialState;\"}),\"\\n这里初始化了hook的\",e(c.code,{children:\"memoizedState\"}),\"和\",e(c.code,{children:\"baseState\"}),\"。\",e(c.code,{children:\"memoizedState\"}),\"存储当前状态,而\",e(c.code,{children:\"baseState\"}),\"用于在更新过程中计算新状态。\"]}),\"\\n\"]}),\"\\n\",n(c.li,{children:[\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"hook\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  pending\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  lastRenderedReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"basicStateReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#00DAEF\"},children:\"  lastRenderedState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": (\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"initialState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"any\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"),\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"});\"})})]})})}),\"\\n\",n(c.p,{children:[\"这创建了一个更新队列。\",e(c.code,{children:\"pending\"}),\"用于存储待处理的更新,\",e(c.code,{children:\"dispatch\"}),\"是更新函数,\",e(c.code,{children:\"lastRenderedReducer\"}),\"是最后一次渲染使用的reducer(对于useState,这是一个基本的状态更新函数),\",e(c.code,{children:\"lastRenderedState\"}),\"是最后一次渲染的状态。\"]}),\"\\n\"]}),\"\\n\",n(c.li,{children:[\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"Dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#ACAFFF\"},children:\"  BasicStateAction\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\">,\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"> = (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"dispatchAction\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"bind\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#FFD493\"},children:\"  null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  currentlyRenderingFiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"): \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"any\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"));\"})]})]})})}),\"\\n\",n(c.p,{children:[\"这创建了\",e(c.code,{children:\"dispatch\"}),\"函数。它实际上是\",e(c.code,{children:\"dispatchAction\"}),\"函数的绑定版本,预先绑定了当前fiber和更新队列。这是一个优化,避免了每次调用\",e(c.code,{children:\"dispatch\"}),\"时都要重新绑定这些参数。\"]}),\"\\n\"]}),\"\\n\",n(c.li,{children:[\"\\n\",n(c.p,{children:[e(c.code,{children:\"return [hook.memoizedState, dispatch];\"}),\"\\n最后返回当前状态和dispatch函数,这就是我们在使用\",e(c.code,{children:\"useState\"}),\"时得到的数组。\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(c.h3,{id:\"22-dispatchaction\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#22-dispatchaction\",children:e(c.span,{className:\"icon icon-link\"})}),\"2.2 dispatchAction\"]}),\"\\n\",n(c.p,{children:[\"接下来,让我们看看\",e(c.code,{children:\"dispatchAction\"}),\"函数,这是状态更新的核心:\"]}),\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\" dispatchAction\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"A\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\">(\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  fiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"Fiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"UpdateQueue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"A\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\">,\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  action\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"A\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" eventTime\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"requestEventTime\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"();\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" lane\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"requestUpdateLane\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"fiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"Update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"A\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"> = {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    lane\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    action\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    eagerReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    eagerState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#00DAEF\"},children:\"    next\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": (\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"any\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"),\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"  };\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  const\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\" pending\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"pending\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#00DAEF\"},children:\"  if\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"pending\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"    update.\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"else\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"    update.\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"pending\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"    pending.\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"pending\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  const\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\" alternate\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"fiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#00DAEF\"},children:\"  if\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    fiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"currentlyRenderingFiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" ||\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"    (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"currentlyRenderingFiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"  ) {\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    didScheduleRenderPhaseUpdateDuringThisPass\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"didScheduleRenderPhaseUpdate\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"true\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"else\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#00DAEF\"},children:\"    if\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"      fiber.lanes === \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"NoLanes\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" &&\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"      (\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"alternate\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" || alternate.lanes === \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"NoLanes\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"    ) {\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" lastRenderedReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"lastRenderedReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"lastRenderedReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"        let\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\" prevDispatcher\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"        try\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"          const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" currentState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"lastRenderedState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"any\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"          const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" eagerState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"lastRenderedReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"currentState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"action\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"          update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"eagerReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"lastRenderedReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"          update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"eagerState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"eagerState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"          if\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"is\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"eagerState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"currentState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"            return\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"          }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"        } \"}),e(c.span,{style:{color:\"#54B9FF\"},children:\"catch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"error\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"          // Suppress the error. It will throw again in the render phase.\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"        }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#00DAEF\"},children:\"    scheduleUpdateOnFiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"fiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"lane\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"eventTime\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:\"让我们逐步分析这个函数:\"}),\"\\n\",n(c.ol,{children:[\"\\n\",n(c.li,{children:[\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" eventTime\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"requestEventTime\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" lane\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"requestUpdateLane\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"fiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\")\"})]})]})})}),\"\\n\",e(c.p,{children:\"这两行代码获取了当前的事件时间和更新优先级(lane)。React使用lane模型来管理更新的优先级,这是一个重要的优化机制。\"}),\"\\n\"]}),\"\\n\",n(c.li,{children:[\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"Update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"A\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"> = {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  lane\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  action\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  eagerReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  eagerState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#00DAEF\"},children:\"  next\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": (\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"any\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"),\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"};\"})})]})})}),\"\\n\",n(c.p,{children:[\"这创建了一个新的更新对象。\",e(c.code,{children:\"lane\"}),\"表示更新的优先级,\",e(c.code,{children:\"action\"}),\"是状态更新的动作,\",e(c.code,{children:\"eagerReducer\"}),\"和\",e(c.code,{children:\"eagerState\"}),\"用于优化,\",e(c.code,{children:\"next\"}),\"用于链接到下一个更新。\"]}),\"\\n\"]}),\"\\n\",n(c.li,{children:[\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" pending\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"pending\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"if\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"pending\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"update\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"} \"}),e(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"pending\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  pending\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"update\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"pending\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"update\"})]})]})})}),\"\\n\",e(c.p,{children:\"这段代码将新的更新添加到更新队列中。注意这里使用了环形链表的结构,这使得React可以高效地处理多个更新。\"}),\"\\n\"]}),\"\\n\",n(c.li,{children:[\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"if\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"fiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"currentlyRenderingFiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" || (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"currentlyRenderingFiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  didScheduleRenderPhaseUpdateDuringThisPass\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"didScheduleRenderPhaseUpdate\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"} \"}),e(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ... (优化逻辑)\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:\"这段代码检查是否在渲染阶段调度了更新。如果是,它会设置一个标志,以便React可以在当前渲染完成后立即开始新的渲染。\"}),\"\\n\"]}),\"\\n\",n(c.li,{children:[\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"if\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"fiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"NoLanes\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" && (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" || \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"NoLanes\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ... (优化逻辑)\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:\"这是一个重要的优化。如果当前fiber没有待处理的更新,React会尝试立即计算新的状态。\"}),\"\\n\"]}),\"\\n\",n(c.li,{children:[\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" lastRenderedReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"lastRenderedReducer\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"if\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"lastRenderedReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ... (优化逻辑)\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:\"这里React尝试使用上一次渲染的reducer来计算新状态。这是一个优化,可以避免不必要的重新渲染。\"}),\"\\n\"]}),\"\\n\",n(c.li,{children:[\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" currentState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"lastRenderedState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"any\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" eagerState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"lastRenderedReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"currentState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"action\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"eagerReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"lastRenderedReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"eagerState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"eagerState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"if\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"is\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"eagerState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"currentState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:[\"这段代码计算了新的状态(\",e(c.code,{children:\"eagerState\"}),\")。如果新状态与当前状态相同,函数直接返回,避免了不必要的更新。\"]}),\"\\n\"]}),\"\\n\",n(c.li,{children:[\"\\n\",n(c.p,{children:[e(c.code,{children:\"scheduleUpdateOnFiber(fiber, lane, eventTime);\"}),\"\\n如果需要更新,这行代码会调度一个更新。\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(c.h3,{id:\"23-updatestate\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#23-updatestate\",children:e(c.span,{className:\"icon icon-link\"})}),\"2.3 updateState\"]}),\"\\n\",n(c.p,{children:[\"当组件更新时,会调用\",e(c.code,{children:\"updateState\"}),\"。这个函数实际上是调用了\",e(c.code,{children:\"updateReducer\"}),\":\"]}),\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\" updateState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\">(\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  initialState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": (() \"}),e(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") | \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"): [\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"Dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"BasicStateAction\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\">>] {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\" updateReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"basicStateReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", (\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"initialState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"any\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"));\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:[e(c.code,{children:\"updateReducer\"}),\"是一个复杂的函数,它处理了状态的实际更新。让我们看看它的关键部分:\"]}),\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\" updateReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"I\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"A\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\">(\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#00DAEF\"},children:\"  reducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": (\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"A\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") \"}),e(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  initialArg\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"I\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  init\"}),e(c.span,{style:{color:\"#54B9FF\"},children:\"?\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"I\"}),e(c.span,{style:{color:\"#54B9FF\"},children:\" =>\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"): [\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"Dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"A\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\">] {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" hook\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"updateWorkInProgressHook\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"();\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"hook\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"lastRenderedReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"reducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"  // ... (处理baseQueue和pendingQueue)\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"baseQueue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" first\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"baseQueue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"    let\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\" newState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"baseState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"    let\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\" newBaseState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"    let\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\" newBaseQueueFirst\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"    let\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\" newBaseQueueLast\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"    let\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\" update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"first\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"    do\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" updateLane\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"lane\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (!\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"isSubsetOfLanes\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"renderLanes\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"updateLane\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"        // 优先级不够,跳过这个更新\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"        const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" clone\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"Update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"A\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"> = {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"          lane\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"updateLane\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"          action\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"action\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"          eagerReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"eagerReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"          eagerState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"eagerState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#00DAEF\"},children:\"          next\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": (\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"any\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"),\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"        };\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"        if (\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"newBaseQueueLast\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"          newBaseQueueFirst\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"newBaseQueueLast\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"clone\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"          newBaseState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"newState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"        } \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"else\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"          newBaseQueueLast\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"newBaseQueueLast\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"clone\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"        }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"        currentlyRenderingFiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"mergeLanes\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"          currentlyRenderingFiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"lanes\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"          updateLane\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"        );\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"      } \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"else\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"        // 优先级足够,应用这个更新\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#00DAEF\"},children:\"        if\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"newBaseQueueLast\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"          const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" clone\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"Update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"A\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"> = {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"            lane\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"NoLane\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"            action\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"action\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"            eagerReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"eagerReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"            eagerState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"eagerState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#00DAEF\"},children:\"            next\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": (\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"any\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"),\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"          };\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"          newBaseQueueLast = newBaseQueueLast.next = clone;\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"        }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"        if (update.eagerReducer === \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"reducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"          // 如果有缓存的计算结果,直接使用\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"          newState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = ((\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"eagerState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"any\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"): \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"        } \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"else\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"          // 否则,调用reducer计算新状态\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"          const \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"action\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"action\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"          newState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"reducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"newState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"action\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"        }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"      update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"update\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"next\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"    } while (update !== null && update !== first);\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // ... (更新hook的状态)\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(c.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"Dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"A\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"> = (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"any\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"hook\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"memoizedState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"];\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(c.p,{children:\"这个函数的核心是一个循环，它遍历所有待处理的更新。让我们逐步分析：\"}),\"\\n\",n(c.ol,{children:[\"\\n\",n(c.li,{children:[\"\\n\",n(c.p,{children:[e(c.code,{children:\"const hook = updateWorkInProgressHook();\"}),\"\\n这行代码获取当前正在工作的hook。React使用链表结构来管理一个组件中的多个hooks，这允许hooks在渲染过程中保持稳定的顺序。\"]}),\"\\n\"]}),\"\\n\",n(c.li,{children:[\"\\n\",n(c.p,{children:[e(c.code,{children:\"queue.lastRenderedReducer = reducer;\"}),\"\\n更新队列中存储的最后一次渲染使用的reducer。这是为了后续的优化。\"]}),\"\\n\"]}),\"\\n\",n(c.li,{children:[\"\\n\",e(c.p,{children:\"接下来的大循环是整个函数的核心，它遍历所有待处理的更新。\"}),\"\\n\"]}),\"\\n\",n(c.li,{children:[\"\\n\",n(c.p,{children:[e(c.code,{children:\"if (!isSubsetOfLanes(renderLanes, updateLane)) { ... }\"}),\"\\n这个条件检查当前更新的优先级是否足够高。如果优先级不够，这个更新会被跳过，并被添加到一个新的队列中，等待下次渲染。\"]}),\"\\n\"]}),\"\\n\",n(c.li,{children:[\"\\n\",n(c.p,{children:[e(c.code,{children:\"if (update.eagerReducer === reducer) { ... }\"}),\"\\n这是一个重要的优化。如果当前更新已经有了预计算的结果（eagerState），并且使用的reducer没有变，那么就直接使用预计算的结果，避免重复计算。\"]}),\"\\n\"]}),\"\\n\",n(c.li,{children:[\"\\n\",n(c.p,{children:[e(c.code,{children:\"newState = reducer(newState, action);\"}),\"\\n如果没有预计算的结果，就调用reducer计算新的状态。\"]}),\"\\n\"]}),\"\\n\"]}),\"\\n\",e(c.p,{children:\"这个函数展示了React在状态更新过程中的几个关键优化：\"}),\"\\n\",n(c.ul,{children:[\"\\n\",e(c.li,{children:\"优先级调度：通过lane模型，React可以跳过低优先级的更新，优先处理高优先级的更新。\"}),\"\\n\",e(c.li,{children:\"批量更新：多个更新被放在一个队列中一起处理，提高了效率。\"}),\"\\n\",e(c.li,{children:\"预计算：通过eagerReducer和eagerState，React可以在某些情况下避免重复计算。\"}),\"\\n\"]}),\"\\n\",n(c.h2,{id:\"3-usereducer的实现\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#3-usereducer的实现\",children:e(c.span,{className:\"icon icon-link\"})}),\"3. useReducer的实现\"]}),\"\\n\",n(c.p,{children:[e(c.code,{children:\"useReducer\"}),\"的实现与\",e(c.code,{children:\"useState\"}),\"非常相似。主要区别在于，\",e(c.code,{children:\"useReducer\"}),\"允许用户提供自定义的reducer函数。让我们看看\",e(c.code,{children:\"mountReducer\"}),\"的实现：\"]}),\"\\n\",e(c.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(c.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(c.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\" mountReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"I\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"A\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\">(\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#00DAEF\"},children:\"  reducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": (\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"A\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") \"}),e(c.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  initialArg\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"I\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"  init\"}),e(c.span,{style:{color:\"#54B9FF\"},children:\"?\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"I\"}),e(c.span,{style:{color:\"#54B9FF\"},children:\" =>\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"): [\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"Dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"A\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\">] {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\" hook\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"mountWorkInProgressHook\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"();\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  let\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\" initialState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"init\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"undefined\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    initialState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"init\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"initialArg\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"  } \"}),e(c.span,{style:{color:\"#54B9FF\"},children:\"else\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    initialState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = ((\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"initialArg\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"any\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"): \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"S\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\");\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#FFD493\"},children:\"  hook\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"memoizedState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"hook\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"baseState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"initialState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\";\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  const\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\" queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"hook\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = {\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    pending\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    lastRenderedReducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"reducer\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#00DAEF\"},children:\"    lastRenderedState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": (\"}),e(c.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"initialState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"any\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"),\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"  });\"})}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  const\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\" dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"Dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"<\"}),e(c.span,{style:{color:\"#ACAFFF\"},children:\"A\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"> = (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" = (\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"dispatchAction\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#00DAEF\"},children:\"bind\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"(\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#FFD493\"},children:\"    null\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    currentlyRenderingFiber\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"    queue\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\",\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#EEF0F9\"},children:\"  ): \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"any\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"));\"})]}),\"\\n\",n(c.span,{\"data-line\":\"\",children:[e(c.span,{style:{color:\"#4BF3C8\"},children:\"  return\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\" [\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"hook\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"memoizedState\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(c.span,{style:{color:\"#4BF3C8\"},children:\"dispatch\"}),e(c.span,{style:{color:\"#EEF0F9\"},children:\"];\"})]}),\"\\n\",e(c.span,{\"data-line\":\"\",children:e(c.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(c.p,{children:[\"这个函数与\",e(c.code,{children:\"mountState\"}),\"非常相似，主要区别在于：\"]}),\"\\n\",n(c.ol,{children:[\"\\n\",n(c.li,{children:[\"它接受一个\",e(c.code,{children:\"reducer\"}),\"函数作为参数。\"]}),\"\\n\",n(c.li,{children:[\"它允许通过\",e(c.code,{children:\"init\"}),\"函数来初始化状态，这提供了更灵活的初始化方式。\"]}),\"\\n\"]}),\"\\n\",n(c.p,{children:[e(c.code,{children:\"useReducer\"}),\"的更新过程（\",e(c.code,{children:\"updateReducer\"}),\"）与\",e(c.code,{children:\"useState\"}),\"完全相同，我们在前面已经详细分析过了。\"]}),\"\\n\",n(c.h2,{id:\"4-深入思考\",children:[e(c.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#4-深入思考\",children:e(c.span,{className:\"icon icon-link\"})}),\"4. 深入思考\"]}),\"\\n\",n(c.ol,{children:[\"\\n\",n(c.li,{children:[\"\\n\",n(c.p,{children:[e(c.strong,{children:\"Hooks的本质\"}),\"：Hooks本质上是一种状态管理的方式。它们允许函数组件拥有自己的状态，而不需要转换为类组件。这大大简化了React组件的编写。\"]}),\"\\n\"]}),\"\\n\",n(c.li,{children:[\"\\n\",n(c.p,{children:[e(c.strong,{children:\"链表结构\"}),\"：React使用链表来管理hooks，这允许hooks在多次渲染之间保持稳定的顺序。这也是为什么hooks不能在条件语句中使用的原因。\"]}),\"\\n\"]}),\"\\n\",n(c.li,{children:[\"\\n\",n(c.p,{children:[e(c.strong,{children:\"批量更新和优先级\"}),\"：React的更新机制非常精细。它可以将多个更新批量处理，并且可以根据优先级来决定哪些更新应该先被处理。这大大提高了应用的性能和响应速度。\"]}),\"\\n\"]}),\"\\n\",n(c.li,{children:[\"\\n\",n(c.p,{children:[e(c.strong,{children:\"懒初始化\"}),\"：\",e(c.code,{children:\"useState\"}),\"和\",e(c.code,{children:\"useReducer\"}),\"都支持懒初始化，即可以传入一个函数来计算初始状态。这对于复杂的初始状态计算很有用，可以避免在每次渲染时都重新计算。\"]}),\"\\n\"]}),\"\\n\",n(c.li,{children:[\"\\n\",n(c.p,{children:[e(c.strong,{children:\"闭包陷阱\"}),\"：Hooks的实现依赖于JavaScript的闭包机制。这可能导致一些难以察觉的bug，比如在异步操作中使用旧的状态。理解这一点对于正确使用hooks非常重要。\"]}),\"\\n\"]}),\"\\n\"]})]})}return{default:function(l={}){const{wrapper:n}=l.components||{};return n?e(n,{...l,children:e(_createMdxContent,{...l})}):_createMdxContent(l)}};",
    "toc": {
      "content": [
        {
          "title": "函数式组件-构建细节以及更新（中）",
          "url": "#函数式组件-构建细节以及更新中",
          "items": [
            {
              "title": "2. useState的实现",
              "url": "#2-usestate的实现",
              "items": [
                {
                  "title": "2.1 mountState",
                  "url": "#21-mountstate",
                  "items": []
                },
                {
                  "title": "2.2 dispatchAction",
                  "url": "#22-dispatchaction",
                  "items": []
                },
                {
                  "title": "2.3 updateState",
                  "url": "#23-updatestate",
                  "items": []
                }
              ]
            },
            {
              "title": "3. useReducer的实现",
              "url": "#3-usereducer的实现",
              "items": []
            },
            {
              "title": "4. 深入思考",
              "url": "#4-深入思考",
              "items": []
            }
          ]
        }
      ],
      "visible": true
    },
    "slugAsParams": "7.react_source_reading(4)_middle"
  },
  {
    "slug": "/content/react-source-code/8.react_source_reading(4)_down",
    "title": "8. 函数式组件-构建细节以及更新（下）",
    "description": "React源码阅读(4)-支线(函数式组件)-构建细节以及更新（下）",
    "published": true,
    "date": "2022-12-08T00:00:00.000Z",
    "body": "const{Fragment:l,jsx:e,jsxs:n}=arguments[0];function _createMdxContent(c){const r={a:\"a\",code:\"code\",figure:\"figure\",h1:\"h1\",h2:\"h2\",h3:\"h3\",h4:\"h4\",li:\"li\",ol:\"ol\",p:\"p\",pre:\"pre\",span:\"span\",ul:\"ul\",...c.components};return n(l,{children:[n(r.h1,{id:\"函数式组件-构建细节以及更新下\",children:[e(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#函数式组件-构建细节以及更新下\",children:e(r.span,{className:\"icon icon-link\"})}),\"函数式组件-构建细节以及更新（下）\"]}),\"\\n\",e(r.p,{children:\"React Hooks的引入彻底改变了React组件的编写方式,使函数组件能够管理状态和副作用。本文将深入探讨React Hooks的内部实现,特别是useEffect、useRef、useMemo和useCallback这几个常用的Hooks。\"}),\"\\n\",e(r.p,{children:\"好的，我理解您希望对整个部分进行重写。我会重新组织内容，使其更加清晰和连贯。以下是重写后的内容：\"}),\"\\n\",n(r.h2,{id:\"effect-hook的内部机制\",children:[e(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#effect-hook的内部机制\",children:e(r.span,{className:\"icon icon-link\"})}),\"Effect Hook的内部机制\"]}),\"\\n\",e(r.p,{children:\"React中的Effect Hook（主要是useEffect和useLayoutEffect）是用于处理组件副作用的重要工具。它们的实现涉及到React的渲染和提交过程的多个阶段。让我们深入了解它们的工作原理。\"}),\"\\n\",n(r.h3,{id:\"useeffect和uselayouteffect的区别\",children:[e(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#useeffect和uselayouteffect的区别\",children:e(r.span,{className:\"icon icon-link\"})}),\"useEffect和useLayoutEffect的区别\"]}),\"\\n\",e(r.p,{children:\"虽然useEffect和useLayoutEffect的API看起来相似，但它们的执行时机有重要区别：\"}),\"\\n\",n(r.ul,{children:[\"\\n\",e(r.li,{children:\"useEffect：在渲染完成后异步执行\"}),\"\\n\",e(r.li,{children:\"useLayoutEffect：在DOM变更后同步执行\"}),\"\\n\"]}),\"\\n\",e(r.p,{children:\"这个区别体现在它们的内部实现上：\"}),\"\\n\",e(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(r.span,{style:{color:\"#00DAEF\"},children:\" mountEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"create\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"deps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),e(r.span,{style:{color:\"#00DAEF\"},children:\" mountEffectImpl\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"UpdateEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" | \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"PassiveEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"HookPassive\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"create\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"deps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(r.span,{style:{color:\"#00DAEF\"},children:\" mountLayoutEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"create\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"deps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),e(r.span,{style:{color:\"#00DAEF\"},children:\" mountEffectImpl\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"UpdateEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"HookLayout\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"create\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"deps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(r.p,{children:\"关键区别在于传入的flags：useEffect使用PassiveEffect标志，而useLayoutEffect不使用。这决定了它们在commit阶段的处理方式。\"}),\"\\n\",n(r.h3,{id:\"effect的创建过程\",children:[e(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#effect的创建过程\",children:e(r.span,{className:\"icon icon-link\"})}),\"Effect的创建过程\"]}),\"\\n\",e(r.p,{children:\"当组件首次渲染时，Effect通过mountEffectImpl函数创建：\"}),\"\\n\",e(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(r.span,{style:{color:\"#00DAEF\"},children:\" mountEffectImpl\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"fiberFlags\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"hookFlags\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"create\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"deps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" hook\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#00DAEF\"},children:\"mountWorkInProgressHook\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" nextDeps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"deps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(r.span,{style:{color:\"#FFD493\"},children:\"undefined\"}),e(r.span,{style:{color:\"#54B9FF\"},children:\" ?\"}),e(r.span,{style:{color:\"#FFD493\"},children:\" null\"}),e(r.span,{style:{color:\"#54B9FF\"},children:\" :\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\" deps\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#4BF3C8\"},children:\"  currentlyRenderingFiber\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),e(r.span,{style:{color:\"#54B9FF\"},children:\" |=\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\" fiberFlags\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#4BF3C8\"},children:\"  hook\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"memoizedState\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#00DAEF\"},children:\"pushEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"HookHasEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" | \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"hookFlags\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"create\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#FFD493\"},children:\"undefined\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextDeps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(r.p,{children:\"这个函数完成以下关键任务：\"}),\"\\n\",n(r.ol,{children:[\"\\n\",e(r.li,{children:\"创建新的hook并添加到fiber的hook链表中\"}),\"\\n\",e(r.li,{children:\"设置fiber的flags，这决定了在commit阶段如何处理这个fiber\"}),\"\\n\",e(r.li,{children:\"调用pushEffect创建effect对象并将其添加到effect链表中\"}),\"\\n\"]}),\"\\n\",n(r.h3,{id:\"effect的执行过程\",children:[e(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#effect的执行过程\",children:e(r.span,{className:\"icon icon-link\"})}),\"Effect的执行过程\"]}),\"\\n\",e(r.p,{children:\"Effect的执行分为三个主要阶段，对应commit阶段的三个子阶段：\"}),\"\\n\",n(r.ol,{children:[\"\\n\",e(r.li,{children:\"Before mutation (commitBeforeMutationEffects)\"}),\"\\n\",e(r.li,{children:\"Mutation (commitMutationEffects)\"}),\"\\n\",e(r.li,{children:\"Layout (commitLayoutEffects)\"}),\"\\n\"]}),\"\\n\",n(r.h4,{id:\"before-mutation阶段\",children:[e(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#before-mutation阶段\",children:e(r.span,{className:\"icon icon-link\"})}),\"Before Mutation阶段\"]}),\"\\n\",e(r.p,{children:\"在这个阶段，React为useEffect的执行做准备：\"}),\"\\n\",e(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(r.span,{style:{color:\"#00DAEF\"},children:\" commitBeforeMutationEffects\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),e(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" flags\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"flags\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" ((\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" & \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"Passive\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") !== \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"NoFlags\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" (!\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"rootDoesHavePassiveEffects\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#4BF3C8\"},children:\"        rootDoesHavePassiveEffects\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#FFD493\"},children:\"true\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#00DAEF\"},children:\"        scheduleCallback\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"NormalSchedulerPriority\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", () \"}),e(r.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#00DAEF\"},children:\"          flushPassiveEffects\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"          return\"}),e(r.span,{style:{color:\"#FFD493\"},children:\" null\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"        })\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#4BF3C8\"},children:\"    nextEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(r.p,{children:\"这里，React调度了一个异步任务来执行useEffect。这就是为什么useEffect在渲染后异步执行的原因。\"}),\"\\n\",n(r.h4,{id:\"mutation阶段\",children:[e(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#mutation阶段\",children:e(r.span,{className:\"icon icon-link\"})}),\"Mutation阶段\"]}),\"\\n\",e(r.p,{children:\"在这个阶段，React处理useLayoutEffect的清理函数：\"}),\"\\n\",e(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(r.span,{style:{color:\"#00DAEF\"},children:\" commitMutationEffects\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"root\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"renderPriorityLevel\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),e(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" flags\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"flags\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" & \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"Update\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" current\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#00DAEF\"},children:\"      commitWork\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#4BF3C8\"},children:\"    nextEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(r.p,{children:\"这个过程是同步的，发生在DOM更新之前，确保在新的副作用执行前清理旧的副作用。\"}),\"\\n\",e(r.p,{children:\"为什么useLayoutEffect在这里执行清理函数？\"}),\"\\n\",n(r.ul,{children:[\"\\n\",e(r.li,{children:\"确保在DOM更新前清理旧的副作用，防止潜在的内存泄漏。\"}),\"\\n\",e(r.li,{children:\"为新的副作用准备一个干净的环境。\"}),\"\\n\"]}),\"\\n\",n(r.h4,{id:\"layout阶段\",children:[e(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#layout阶段\",children:e(r.span,{className:\"icon icon-link\"})}),\"Layout阶段\"]}),\"\\n\",e(r.p,{children:\"在Layout阶段，React执行useLayoutEffect的回调函数：\"}),\"\\n\",e(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(r.span,{style:{color:\"#00DAEF\"},children:\" commitLayoutEffects\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"root\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"committedLanes\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  while\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),e(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" flags\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"flags\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" & (\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"Update\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" | \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"Callback\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" current\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"alternate\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#00DAEF\"},children:\"      commitLayoutEffectOnFiber\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"root\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"committedLanes\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" & \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"Ref\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#00DAEF\"},children:\"      commitAttachRef\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#4BF3C8\"},children:\"    nextEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextEffect\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(r.p,{children:\"useLayoutEffect的回调在这里同步执行，而useEffect的回调仍在等待异步执行。\"}),\"\\n\",n(r.h3,{id:\"useeffect的异步执行\",children:[e(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#useeffect的异步执行\",children:e(r.span,{className:\"icon icon-link\"})}),\"useEffect的异步执行\"]}),\"\\n\",e(r.p,{children:\"useEffect的实际执行发生在之前调度的异步任务中，当浏览器有空闲时间时，之前调度的异步任务（flushPassiveEffects）会被执行。这个函数会遍历所有待执行的effects并执行它们：\"}),\"\\n\",e(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(r.span,{style:{color:\"#00DAEF\"},children:\" flushPassiveEffects\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"rootWithPendingPassiveEffects\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),e(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" root\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"rootWithPendingPassiveEffects\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 首先执行所有的清理函数\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#00DAEF\"},children:\"    flushPassiveEffectsImpl\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"    // 然后执行新的effect\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#00DAEF\"},children:\"    flushPassiveEffectsImpl\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(r.p,{children:\"这个函数首先执行所有待清理的effect的清理函数，然后执行所有新的effect回调。\"}),\"\\n\",n(r.h2,{id:\"2-ref-hook的实现原理\",children:[e(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#2-ref-hook的实现原理\",children:e(r.span,{className:\"icon icon-link\"})}),\"2. Ref Hook的实现原理\"]}),\"\\n\",e(r.p,{children:\"useRef的实现相对简单,但它的作用却非常重要:\"}),\"\\n\",e(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(r.span,{style:{color:\"#00DAEF\"},children:\" mountRef\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"initialValue\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" hook\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#00DAEF\"},children:\"mountWorkInProgressHook\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" ref\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = { \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\": \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"initialValue\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" }\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#4BF3C8\"},children:\"  hook\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"memoizedState\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"ref\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\" ref\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(r.span,{style:{color:\"#00DAEF\"},children:\" updateRef\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"() {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" hook\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#00DAEF\"},children:\"updateWorkInProgressHook\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\" hook\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"memoizedState\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(r.p,{children:\"useRef的核心思想是创建一个可变的引用,这个引用在组件的整个生命周期内保持不变。这就是为什么我们可以用useRef来存储DOM节点或任何可变值,而不会触发组件重新渲染。\"}),\"\\n\",e(r.p,{children:\"在fiber树的构建和提交阶段,React会特别处理带有ref的fiber:\"}),\"\\n\",e(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(r.span,{style:{color:\"#00DAEF\"},children:\" markRef\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"current\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"workInProgress\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" ref\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"workInProgress\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"ref\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" ((\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"ref\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),e(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") || (\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),e(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"ref\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"ref\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#4BF3C8\"},children:\"    workInProgress\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"flags\"}),e(r.span,{style:{color:\"#54B9FF\"},children:\" |=\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\" Ref\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(r.p,{children:\"这个函数会在ref发生变化时标记fiber,以便在commit阶段进行处理。\"}),\"\\n\",e(r.p,{children:\"在commit阶段,React会先解除旧的ref,然后设置新的ref:\"}),\"\\n\",e(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(r.span,{style:{color:\"#00DAEF\"},children:\" commitAttachRef\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"finishedWork\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" ref\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"finishedWork\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"ref\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"ref\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),e(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"    const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" instance\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"finishedWork\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"stateNode\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"    let\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\" instanceToUse\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"    switch\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"finishedWork\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"tag\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"      case\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\" HostComponent\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#4BF3C8\"},children:\"        instanceToUse\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#00DAEF\"},children:\"getPublicInstance\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"instance\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#54B9FF\"},children:\"        break\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"      default\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\":\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#4BF3C8\"},children:\"        instanceToUse\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"instance\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(r.span,{style:{color:\"#54B9FF\"},children:\"typeof\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\" ref\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(r.span,{style:{color:\"#FFD493\"},children:\"'function'\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#00DAEF\"},children:\"      ref\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"instanceToUse\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\")\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#EEF0F9\"},children:\"    } \"}),e(r.span,{style:{color:\"#54B9FF\"},children:\"else\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#4BF3C8\"},children:\"      ref\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"current\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"instanceToUse\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(r.p,{children:\"好的，我理解您希望在第三节中增加关于浅比较依赖的内容。我们可以扩展这一部分，详细解释React如何进行依赖比较，以及这对useMemo和useCallback的性能优化有何影响。以下是修改后的内容：\"}),\"\\n\",n(r.h2,{id:\"3-usememo和usecallback的实现及依赖比较机制\",children:[e(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#3-usememo和usecallback的实现及依赖比较机制\",children:e(r.span,{className:\"icon icon-link\"})}),\"3. useMemo和useCallback的实现及依赖比较机制\"]}),\"\\n\",e(r.p,{children:\"useMemo和useCallback的实现非常相似，它们都用于性能优化。这两个Hook的核心是通过比较依赖项来决定是否需要重新计算值或重新创建函数。让我们深入了解它们的实现，特别是依赖比较的机制：\"}),\"\\n\",e(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(r.span,{style:{color:\"#00DAEF\"},children:\" mountMemo\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"nextCreate\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"deps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" hook\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#00DAEF\"},children:\"mountWorkInProgressHook\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" nextDeps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"deps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(r.span,{style:{color:\"#FFD493\"},children:\"undefined\"}),e(r.span,{style:{color:\"#54B9FF\"},children:\" ?\"}),e(r.span,{style:{color:\"#FFD493\"},children:\" null\"}),e(r.span,{style:{color:\"#54B9FF\"},children:\" :\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\" deps\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" nextValue\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#00DAEF\"},children:\"nextCreate\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#4BF3C8\"},children:\"  hook\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"memoizedState\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = [\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextValue\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextDeps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"]\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\" nextValue\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:\" \"}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(r.span,{style:{color:\"#00DAEF\"},children:\" updateMemo\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"nextCreate\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"deps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" hook\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#00DAEF\"},children:\"updateWorkInProgressHook\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" nextDeps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"deps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(r.span,{style:{color:\"#FFD493\"},children:\"undefined\"}),e(r.span,{style:{color:\"#54B9FF\"},children:\" ?\"}),e(r.span,{style:{color:\"#FFD493\"},children:\" null\"}),e(r.span,{style:{color:\"#54B9FF\"},children:\" :\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\" deps\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" prevState\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"hook\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"memoizedState\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"prevState\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),e(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextDeps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" !== \"}),e(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"      const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" prevDeps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"prevState\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),e(r.span,{style:{color:\"#FFD493\"},children:\"1\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"]\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"      if\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(r.span,{style:{color:\"#00DAEF\"},children:\"areHookInputsEqual\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextDeps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"prevDeps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\")) {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"        return\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\" prevState\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),e(r.span,{style:{color:\"#FFD493\"},children:\"0\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"]\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"      }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  const\"}),e(r.span,{style:{color:\"#ACAFFF\"},children:\" nextValue\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#00DAEF\"},children:\"nextCreate\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"()\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#4BF3C8\"},children:\"  hook\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"memoizedState\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = [\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextValue\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextDeps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"]\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\" nextValue\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",n(r.h3,{id:\"依赖比较机制\",children:[e(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#依赖比较机制\",children:e(r.span,{className:\"icon icon-link\"})}),\"依赖比较机制\"]}),\"\\n\",n(r.p,{children:[\"React使用\",e(r.code,{children:\"areHookInputsEqual\"}),\"函数来进行依赖项的浅比较。这个函数的实现大致如下：\"]}),\"\\n\",e(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:n(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:[n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"function\"}),e(r.span,{style:{color:\"#00DAEF\"},children:\" areHookInputsEqual\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"nextDeps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\",fontStyle:\"italic\"},children:\"prevDeps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  if\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"prevDeps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" === \"}),e(r.span,{style:{color:\"#FFD493\"},children:\"null\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\") {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),e(r.span,{style:{color:\"#FFD493\"},children:\" false\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  for\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(r.span,{style:{color:\"#54B9FF\"},children:\"let\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\" i\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" = \"}),e(r.span,{style:{color:\"#FFD493\"},children:\"0\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"; \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"i\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"prevDeps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"length\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" && \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"i\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" < \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextDeps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"length\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"; \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"i\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"++) {\"})]}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"    if\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" (\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"Object\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\".\"}),e(r.span,{style:{color:\"#00DAEF\"},children:\"is\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"nextDeps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"i\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"], \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"prevDeps\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"[\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"i\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"])) {\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#54B9FF\"},children:\"      continue\"})}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"    }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"    return\"}),e(r.span,{style:{color:\"#FFD493\"},children:\" false\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"  }\"})}),\"\\n\",n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#54B9FF\"},children:\"  return\"}),e(r.span,{style:{color:\"#FFD493\"},children:\" true\"})]}),\"\\n\",e(r.span,{\"data-line\":\"\",children:e(r.span,{style:{color:\"#EEF0F9\"},children:\"}\"})})]})})}),\"\\n\",e(r.p,{children:\"这个函数有以下几个关键点：\"}),\"\\n\",n(r.ol,{children:[\"\\n\",n(r.li,{children:[\"\\n\",e(r.p,{children:\"浅比较：只比较依赖数组中每个元素的引用，不进行深层比较。\"}),\"\\n\"]}),\"\\n\",n(r.li,{children:[\"\\n\",n(r.p,{children:[\"使用Object.is：这个方法比较两个值是否相同，它与\",e(r.code,{children:\"===\"}),\"操作符类似，但能够正确处理NaN和-0的情况。\"]}),\"\\n\"]}),\"\\n\",n(r.li,{children:[\"\\n\",e(r.p,{children:\"长度敏感：如果新旧依赖数组的长度不同，会返回false。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(r.h3,{id:\"浅比较的影响\",children:[e(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#浅比较的影响\",children:e(r.span,{className:\"icon icon-link\"})}),\"浅比较的影响\"]}),\"\\n\",e(r.p,{children:\"浅比较机制对useMemo和useCallback的使用有重要影响：\"}),\"\\n\",n(r.ol,{children:[\"\\n\",n(r.li,{children:[\"\\n\",e(r.p,{children:\"基本类型依赖：对于数字、字符串、布尔值等基本类型，浅比较能够有效地检测变化。\"}),\"\\n\"]}),\"\\n\",n(r.li,{children:[\"\\n\",e(r.p,{children:\"对象和数组依赖：由于只比较引用，如果你传入一个每次渲染都新创建的对象或数组，即使内容没变，也会被视为依赖变化。例如：\"}),\"\\n\",e(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#00DAEF\"},children:\"useMemo\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(() \"}),e(r.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),e(r.span,{style:{color:\"#00DAEF\"},children:\" expensiveCalculation\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"a\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"b\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"), [{ \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"a\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"b\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\" }]) \"}),e(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 不推荐\"})]})})})}),\"\\n\",e(r.p,{children:\"这里每次渲染都创建了一个新对象，导致memo失效。应该改为：\"}),\"\\n\",e(r.figure,{\"data-rehype-pretty-code-figure\":\"\",children:e(r.pre,{style:{backgroundColor:\"#17191e\",color:\"#eef0f9\"},tabIndex:\"0\",\"data-language\":\"javascript\",\"data-theme\":\"houston\",children:e(r.code,{\"data-language\":\"javascript\",\"data-theme\":\"houston\",style:{display:\"grid\"},children:n(r.span,{\"data-line\":\"\",children:[e(r.span,{style:{color:\"#00DAEF\"},children:\"useMemo\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(() \"}),e(r.span,{style:{color:\"#54B9FF\"},children:\"=>\"}),e(r.span,{style:{color:\"#00DAEF\"},children:\" expensiveCalculation\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"(\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"a\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"b\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"), [\"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"a\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\", \"}),e(r.span,{style:{color:\"#4BF3C8\"},children:\"b\"}),e(r.span,{style:{color:\"#EEF0F9\"},children:\"]) \"}),e(r.span,{style:{color:\"#EEF0F98F\",fontStyle:\"italic\"},children:\"// 推荐\"})]})})})}),\"\\n\"]}),\"\\n\",n(r.li,{children:[\"\\n\",e(r.p,{children:\"函数依赖：类似地，如果依赖项包含内联函数，每次渲染都会创建新的函数引用，导致优化失效。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(r.h3,{id:\"最佳实践\",children:[e(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#最佳实践\",children:e(r.span,{className:\"icon icon-link\"})}),\"最佳实践\"]}),\"\\n\",e(r.p,{children:\"为了充分利用useMemo和useCallback的优化效果：\"}),\"\\n\",n(r.ol,{children:[\"\\n\",n(r.li,{children:[\"\\n\",e(r.p,{children:\"只包含必要的依赖：仅包含计算或回调函数真正依赖的值。\"}),\"\\n\"]}),\"\\n\",n(r.li,{children:[\"\\n\",e(r.p,{children:\"使用基本类型依赖：尽可能使用数字、字符串等基本类型作为依赖。\"}),\"\\n\"]}),\"\\n\",n(r.li,{children:[\"\\n\",e(r.p,{children:\"稳定的引用：对于对象或函数依赖，考虑使用useMemo或useCallback来稳定它们的引用。\"}),\"\\n\"]}),\"\\n\",n(r.li,{children:[\"\\n\",e(r.p,{children:\"考虑使用useRef：对于不需要触发重新渲染的可变值，考虑使用useRef而不是将其作为依赖项。\"}),\"\\n\"]}),\"\\n\"]}),\"\\n\",n(r.h2,{id:\"总结\",children:[e(r.a,{className:\"subheading-anchor\",\"aria-label\":\"Link to section\",href:\"#总结\",children:e(r.span,{className:\"icon icon-link\"})}),\"总结\"]}),\"\\n\",e(r.p,{children:\"React Hooks的实现涉及到复杂的内部机制,包括fiber树的构建、更新和提交过程。\"}),\"\\n\",e(r.p,{children:\"关键点包括:\"}),\"\\n\",n(r.ol,{children:[\"\\n\",e(r.li,{children:\"Effect Hooks (useEffect和useLayoutEffect) 的执行时机和优化机制\"}),\"\\n\",e(r.li,{children:\"Ref Hook (useRef) 的不触发重渲染特性及其在DOM操作中的应用\"}),\"\\n\",e(r.li,{children:\"Memo Hooks (useMemo和useCallback) 的依赖比较和缓存机制\"}),\"\\n\"]}),\"\\n\",e(r.p,{children:\"通过这些机制,React实现了在函数组件中管理状态和副作用的能力,同时保持了良好的性能和开发体验。深入理解这些实现细节,有助于我们在实际开发中更好地使用Hooks,写出更高质量的React代码。\"})]})}return{default:function(l={}){const{wrapper:n}=l.components||{};return n?e(n,{...l,children:e(_createMdxContent,{...l})}):_createMdxContent(l)}};",
    "toc": {
      "content": [
        {
          "title": "函数式组件-构建细节以及更新（下）",
          "url": "#函数式组件-构建细节以及更新下",
          "items": [
            {
              "title": "Effect Hook的内部机制",
              "url": "#effect-hook的内部机制",
              "items": [
                {
                  "title": "useEffect和useLayoutEffect的区别",
                  "url": "#useeffect和uselayouteffect的区别",
                  "items": []
                },
                {
                  "title": "Effect的创建过程",
                  "url": "#effect的创建过程",
                  "items": []
                },
                {
                  "title": "Effect的执行过程",
                  "url": "#effect的执行过程",
                  "items": [
                    {
                      "title": "Before Mutation阶段",
                      "url": "#before-mutation阶段",
                      "items": []
                    },
                    {
                      "title": "Mutation阶段",
                      "url": "#mutation阶段",
                      "items": []
                    },
                    {
                      "title": "Layout阶段",
                      "url": "#layout阶段",
                      "items": []
                    }
                  ]
                },
                {
                  "title": "useEffect的异步执行",
                  "url": "#useeffect的异步执行",
                  "items": []
                }
              ]
            },
            {
              "title": "2. Ref Hook的实现原理",
              "url": "#2-ref-hook的实现原理",
              "items": []
            },
            {
              "title": "3. useMemo和useCallback的实现及依赖比较机制",
              "url": "#3-usememo和usecallback的实现及依赖比较机制",
              "items": [
                {
                  "title": "依赖比较机制",
                  "url": "#依赖比较机制",
                  "items": []
                },
                {
                  "title": "浅比较的影响",
                  "url": "#浅比较的影响",
                  "items": []
                },
                {
                  "title": "最佳实践",
                  "url": "#最佳实践",
                  "items": []
                }
              ]
            },
            {
              "title": "总结",
              "url": "#总结",
              "items": []
            }
          ]
        }
      ],
      "visible": true
    },
    "slugAsParams": "8.react_source_reading(4)_down"
  }
]